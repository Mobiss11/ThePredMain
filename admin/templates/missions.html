{% extends "base.html" %}

{% block title %}Missions - ThePred Admin{% endblock %}

{% block content %}
<div class="max-w-7xl">
    <h1 class="text-3xl font-bold mb-8">Missions Management</h1>

    <!-- Action Buttons -->
    <div class="mb-6 flex items-center gap-4">
        <button onclick="window.location.href='/missions/create'" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium">
            + Create Mission
        </button>
        <button onclick="initDefaultMissions()" class="px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-medium">
            ðŸŽ¯ Init Default Missions (7)
        </button>
    </div>

    <!-- Missions Table -->
    <div class="bg-dark-800 rounded-lg overflow-hidden">
        <table class="w-full">
            <thead class="bg-dark-700">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Icon</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Title</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Reward</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Requirements</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Active</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody id="missions-tbody" class="divide-y divide-gray-800">
                <tr>
                    <td colspan="8" class="px-6 py-8 text-center text-gray-400">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function getIconHtml(mission) {
    // Priority 1: Custom icon URL
    if (mission.custom_icon_url) {
        return `<img src="${mission.custom_icon_url}" alt="icon" class="w-10 h-10 rounded inline-block object-cover">`;
    }

    // Priority 2: Icon field (could be emoji or URL)
    if (mission.icon) {
        // Check if it's a full URL
        if (mission.icon.startsWith('http')) {
            return `<img src="${mission.icon}" alt="icon" class="w-10 h-10 rounded inline-block object-cover">`;
        }
        // Check if it's an icon name (no emoji characters)
        if (!/[\u{1F000}-\u{1F9FF}]/u.test(mission.icon)) {
            return `<img src="${S3_MISSIONS_URL}/${mission.icon}.svg" alt="icon" class="w-10 h-10 rounded inline-block object-cover">`;
        }
        // It's an emoji
        return `<span class="text-3xl">${mission.icon}</span>`;
    }

    // Fallback emoji
    return `<span class="text-3xl">ðŸŽ¯</span>`;
}

async function loadMissions() {
    const tbody = document.getElementById('missions-tbody');
    tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-8 text-center text-gray-400">Loading...</td></tr>';

    try {
        const response = await fetch(`${API_URL}/admin/missions`);
        const missions = await response.json();
        console.log('Missions loaded:', missions);

        if (missions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-8 text-center text-gray-400">No missions found</td></tr>';
            return;
        }

        tbody.innerHTML = missions.map(mission => {
            const requirements = JSON.stringify(mission.requirements);
            const requirementText = getRequirementText(mission.requirements);
            const iconHtml = getIconHtml(mission);

            // Add channel info for subscription missions
            let subscriptionInfo = '';
            if (mission.type === 'subscription' && mission.channel_username) {
                subscriptionInfo = `<div class="text-xs text-blue-400 mt-1">@${mission.channel_username}</div>`;
            }

            return `
            <tr class="hover:bg-dark-700">
                <td class="px-6 py-4 text-sm">#${mission.id}</td>
                <td class="px-6 py-4">${iconHtml}</td>
                <td class="px-6 py-4">
                    <div class="text-sm font-medium">${mission.title}</div>
                    <div class="text-xs text-gray-400">${mission.description || ''}</div>
                    ${subscriptionInfo}
                </td>
                <td class="px-6 py-4">
                    <span class="px-2 py-1 text-xs rounded bg-blue-600">${mission.type}</span>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm font-bold text-yellow-400">${formatNumber(mission.reward_amount)}</div>
                    <div class="text-xs text-gray-400">${mission.reward_currency}</div>
                </td>
                <td class="px-6 py-4 text-xs text-gray-400">
                    ${requirementText}
                </td>
                <td class="px-6 py-4">
                    <span class="px-2 py-1 text-xs rounded ${mission.is_active ? 'bg-green-600' : 'bg-gray-600'}">
                        ${mission.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td class="px-6 py-4">
                    <button onclick="editMission(${mission.id})" class="px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 rounded mr-2">
                        Edit
                    </button>
                    <button onclick="deleteMission(${mission.id})" class="px-3 py-1 text-xs bg-red-600 hover:bg-red-700 rounded">
                        Delete
                    </button>
                </td>
            </tr>
            `;
        }).join('');
    } catch (error) {
        console.error('Failed to load missions:', error);
        tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-8 text-center text-red-400">Failed to load missions</td></tr>';
    }
}

function getRequirementText(requirements) {
    if (requirements.bets_count) {
        return `${requirements.bets_count} bets`;
    } else if (requirements.wins_count) {
        return `${requirements.wins_count} wins`;
    } else if (requirements.win_streak) {
        return `${requirements.win_streak} win streak`;
    } else if (requirements.daily_bets) {
        return `${requirements.daily_bets} daily bets`;
    } else if (requirements.weekly_bets) {
        return `${requirements.weekly_bets} weekly bets`;
    } else if (requirements.referrals_count) {
        return `${requirements.referrals_count} referrals`;
    } else if (requirements.category_bets) {
        return `${requirements.category_bets.count} bets in ${requirements.category_bets.category}`;
    } else if (requirements.subscription) {
        return 'Subscribe to channel';
    }
    return JSON.stringify(requirements);
}

// Edit mission
function editMission(missionId) {
    window.location.href = `/missions/edit/${missionId}`;
}

// Delete mission
async function deleteMission(missionId) {
    if (!confirm('Are you sure you want to delete this mission? This action cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch(`${API_URL}/admin/missions/${missionId}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (response.ok) {
            showToast('Mission deleted successfully!', 'success');
            loadMissions();
        } else {
            showToast(`Error: ${result.detail || 'Failed to delete mission'}`, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Failed to delete mission', 'error');
    }
}

// Initialize default missions
async function initDefaultMissions() {
    if (!confirm('Create 20 default missions? (3 daily, 3 weekly, 14 achievements)')) {
        return;
    }

    try {
        // Run the init script
        showToast('Initializing missions... This may take a moment.', 'success');

        // Since we don't have an API endpoint for this, we'll need to ask user to run manually
        alert('Please run the following command on the server:\ncd backend && python3 app/init_missions.py');

    } catch (error) {
        console.error('Error:', error);
        showToast('Failed to initialize missions', 'error');
    }
}

// Load missions on page load
loadMissions();
</script>
{% endblock %}
