{% extends "base.html" %}
{% block title %}Leaderboard Management - ThePred Admin{% endblock %}
{% block content %}
<div class="max-w-7xl">
    <h1 class="text-3xl font-bold mb-8">üèÜ Leaderboard Management</h1>

    <!-- Period Tabs -->
    <div class="mb-6">
        <div class="flex space-x-2">
            <button id="tab-week" class="px-6 py-2 rounded-lg bg-yellow-600 font-bold text-black" onclick="switchPeriod('week')">
                –ù–µ–¥–µ–ª—è
            </button>
            <button id="tab-month" class="px-6 py-2 rounded-lg bg-dark-700 font-bold" onclick="switchPeriod('month')">
                –ú–µ—Å—è—Ü
            </button>
        </div>
    </div>

    <!-- UTC Notice -->
    <div class="bg-blue-900/30 border border-blue-700 rounded-lg p-4 mb-6">
        <p class="text-blue-300">
            üåç <strong>–í—Å–µ —Ä–∞—Å—á–µ—Ç—ã –ø—Ä–æ–≤–æ–¥—è—Ç—Å—è –ø–æ UTC –≤—Ä–µ–º–µ–Ω–∏</strong>
        </p>
    </div>

    <!-- Two Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Leaderboard Table -->
        <div class="bg-dark-800 rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4">
                <span id="period-title">–ù–µ–¥–µ–ª—å–Ω—ã–π</span> –õ–∏–¥–µ—Ä–±–æ—Ä–¥
            </h2>
            <div class="overflow-y-auto" style="max-height: 600px;">
                <table class="w-full">
                    <thead class="bg-dark-700 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">Rank</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">User</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-400">Profit</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-400">Win Rate</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Rewards Management -->
        <div class="bg-dark-800 rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">
                    <span id="rewards-period-title">–ù–µ–¥–µ–ª—å–Ω—ã–µ</span> –ù–∞–≥—Ä–∞–¥—ã
                </h2>
                <button onclick="showCreateRewardModal()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-bold text-sm">
                    + –î–æ–±–∞–≤–∏—Ç—å
                </button>
            </div>

            <div id="rewards-list" class="space-y-3">
                <!-- Rewards will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Period Management Section -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
        <!-- Current Period Stats -->
        <div class="bg-dark-800 rounded-lg p-6">
            <h3 class="text-xl font-bold mb-4">üìä –¢–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥</h3>
            <div id="current-stats" class="space-y-3">
                <!-- Stats will be loaded here -->
            </div>
        </div>

        <!-- Close Period -->
        <div class="bg-dark-800 rounded-lg p-6">
            <h3 class="text-xl font-bold mb-4">üèÅ –ó–∞–∫—Ä—ã—Ç—å –ø–µ—Ä–∏–æ–¥</h3>
            <p class="text-sm text-gray-400 mb-4">
                –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–µ—Ä–∏–æ–¥–∞ –∑–∞–ø—É—Å—Ç–∏—Ç —Ä–∞—Å—á–µ—Ç –Ω–∞–≥—Ä–∞–¥ –∏ –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤—Å–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è–º.
            </p>
            <button id="close-period-btn" onclick="closePeriod()" class="w-full px-4 py-3 bg-red-600 hover:bg-red-700 rounded-lg font-bold">
                –ó–∞–∫—Ä—ã—Ç—å <span id="close-period-type">–Ω–µ–¥–µ–ª—å–Ω—ã–π</span> –ø–µ—Ä–∏–æ–¥
            </button>
        </div>

        <!-- Notification Queue Stats -->
        <div class="bg-dark-800 rounded-lg p-6">
            <h3 class="text-xl font-bold mb-4">üì® –û—á–µ—Ä–µ–¥—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h3>
            <div id="queue-stats" class="space-y-2">
                <!-- Queue stats will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Closed Periods History -->
    <div class="bg-dark-800 rounded-lg p-6">
        <h3 class="text-2xl font-bold mb-4">üìú –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫—Ä—ã—Ç—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤</h3>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-dark-700">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">ID</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">–ü–µ—Ä–∏–æ–¥</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">–î–∞—Ç—ã</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-400">–£—á–∞—Å—Ç–Ω–∏–∫–∏</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-400">–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-400">–ù–∞–≥—Ä–∞–¥—ã</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">–ó–∞–∫—Ä—ã—Ç</th>
                    </tr>
                </thead>
                <tbody id="periods-tbody">
                    <!-- Periods will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create/Edit Reward Modal -->
<div id="rewardModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center" style="z-index: 1000;">
    <div class="bg-dark-800 rounded-lg p-8 max-w-md w-full mx-4">
        <h3 id="modalTitle" class="text-2xl font-bold mb-6">–°–æ–∑–¥–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É</h3>

        <form id="rewardForm" class="space-y-4">
            <input type="hidden" id="rewardId" value="">

            <div>
                <label class="block text-sm font-medium mb-2">–ü–µ—Ä–∏–æ–¥</label>
                <select id="rewardPeriod" class="w-full px-4 py-2 bg-dark-700 rounded-lg border border-gray-700">
                    <option value="week">–ù–µ–¥–µ–ª—è</option>
                    <option value="month">–ú–µ—Å—è—Ü</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">–†–∞–Ω–≥ –æ—Ç</label>
                    <input type="number" id="rankFrom" min="1" class="w-full px-4 py-2 bg-dark-700 rounded-lg border border-gray-700" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">–†–∞–Ω–≥ –¥–æ</label>
                    <input type="number" id="rankTo" min="1" class="w-full px-4 py-2 bg-dark-700 rounded-lg border border-gray-700" required>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">–ù–∞–≥—Ä–∞–¥–∞ (PRED)</label>
                <input type="number" id="rewardAmount" min="0" class="w-full px-4 py-2 bg-dark-700 rounded-lg border border-gray-700" required>
            </div>

            <div class="flex items-center">
                <input type="checkbox" id="isActive" class="mr-2" checked>
                <label for="isActive" class="text-sm">–ê–∫—Ç–∏–≤–Ω–∞</label>
            </div>

            <div class="flex space-x-3 mt-6">
                <button type="submit" class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-bold">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button type="button" onclick="closeRewardModal()" class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}
{% block scripts %}
<script>
let currentPeriod = 'week';

// Switch period
function switchPeriod(period) {
    currentPeriod = period;

    // Update tab styles
    document.querySelectorAll('button[id^="tab-"]').forEach(tab => {
        tab.classList.remove('bg-yellow-600', 'text-black');
        tab.classList.add('bg-dark-700');
    });
    document.getElementById(`tab-${period}`).classList.remove('bg-dark-700');
    document.getElementById(`tab-${period}`).classList.add('bg-yellow-600', 'text-black');

    // Update titles
    const title = period === 'week' ? '–ù–µ–¥–µ–ª—å–Ω—ã–π' : '–ú–µ—Å—è—á–Ω—ã–π';
    const rewardsTitle = period === 'week' ? '–ù–µ–¥–µ–ª—å–Ω—ã–µ' : '–ú–µ—Å—è—á–Ω—ã–µ';
    const closePeriodType = period === 'week' ? '–Ω–µ–¥–µ–ª—å–Ω—ã–π' : '–º–µ—Å—è—á–Ω—ã–π';
    document.getElementById('period-title').textContent = title;
    document.getElementById('rewards-period-title').textContent = rewardsTitle;
    document.getElementById('close-period-type').textContent = closePeriodType;

    // Reload data
    loadLeaderboard();
    loadRewards();
    loadCurrentStats();
    loadPeriodsHistory();
}

// Load leaderboard
async function loadLeaderboard() {
    try {
        const response = await fetch(`${API_URL}/admin/leaderboard?period=${currentPeriod}&limit=100`);
        const leaderboard = await response.json();

        const tbody = document.getElementById('leaderboard-tbody');
        tbody.innerHTML = leaderboard.map(entry => {
            const profitColor = entry.profit >= 0 ? 'text-green-400' : 'text-red-400';
            const profitPrefix = entry.profit >= 0 ? '+' : '';

            return `
                <tr class="border-t border-gray-800 hover:bg-dark-700">
                    <td class="px-4 py-3 font-bold ${entry.rank <= 3 ? 'text-yellow-400' : ''}">#${entry.rank}</td>
                    <td class="px-4 py-3">
                        <div class="font-bold">${entry.username || entry.first_name || `User ${entry.user_id}`}</div>
                        <div class="text-xs text-gray-400">${entry.user_rank} ‚Ä¢ ${entry.total_wins}W/${entry.total_bets}B</div>
                    </td>
                    <td class="px-4 py-3 text-right">
                        <div class="font-bold ${profitColor}">${profitPrefix}${formatNumber(entry.profit)}</div>
                        <div class="text-xs text-gray-400">PRED</div>
                    </td>
                    <td class="px-4 py-3 text-right">
                        <div class="font-bold">${entry.win_rate}%</div>
                    </td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading leaderboard:', error);
        showToast('Failed to load leaderboard', 'error');
    }
}

// Load rewards
async function loadRewards() {
    try {
        const response = await fetch(`${API_URL}/admin/leaderboard/rewards?period=${currentPeriod}`);
        const rewards = await response.json();

        const rewardsList = document.getElementById('rewards-list');

        if (rewards.length === 0) {
            rewardsList.innerHTML = '<div class="text-center text-gray-400 py-8">–ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥</div>';
            return;
        }

        rewardsList.innerHTML = rewards.map(reward => {
            let rankText;
            if (reward.rank_from === reward.rank_to) {
                rankText = `#${reward.rank_from}`;
            } else {
                rankText = `#${reward.rank_from}-${reward.rank_to}`;
            }

            return `
                <div class="bg-dark-700 rounded-lg p-4 flex items-center justify-between">
                    <div>
                        <div class="font-bold">${rankText} –ú–µ—Å—Ç–æ</div>
                        <div class="text-yellow-400 font-bold">${formatNumber(reward.reward_amount)} PRED</div>
                        ${reward.is_active ? '' : '<div class="text-xs text-red-400 mt-1">–ù–µ–∞–∫—Ç–∏–≤–Ω–∞</div>'}
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editReward(${reward.id}, '${reward.period}', ${reward.rank_from}, ${reward.rank_to}, ${reward.reward_amount}, ${reward.is_active})"
                                class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm">
                            Edit
                        </button>
                        <button onclick="deleteReward(${reward.id})"
                                class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm">
                            Delete
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading rewards:', error);
        showToast('Failed to load rewards', 'error');
    }
}

// Show create reward modal
function showCreateRewardModal() {
    document.getElementById('modalTitle').textContent = '–°–æ–∑–¥–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É';
    document.getElementById('rewardForm').reset();
    document.getElementById('rewardId').value = '';
    document.getElementById('rewardPeriod').value = currentPeriod;
    document.getElementById('isActive').checked = true;
    document.getElementById('rewardModal').classList.remove('hidden');
    document.getElementById('rewardModal').classList.add('flex');
}

// Edit reward
function editReward(id, period, rankFrom, rankTo, rewardAmount, isActive) {
    document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É';
    document.getElementById('rewardId').value = id;
    document.getElementById('rewardPeriod').value = period;
    document.getElementById('rankFrom').value = rankFrom;
    document.getElementById('rankTo').value = rankTo;
    document.getElementById('rewardAmount').value = rewardAmount;
    document.getElementById('isActive').checked = isActive;
    document.getElementById('rewardModal').classList.remove('hidden');
    document.getElementById('rewardModal').classList.add('flex');
}

// Close modal
function closeRewardModal() {
    document.getElementById('rewardModal').classList.add('hidden');
    document.getElementById('rewardModal').classList.remove('flex');
}

// Delete reward
async function deleteReward(id) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –Ω–∞–≥—Ä–∞–¥—É?')) return;

    try {
        const response = await fetch(`${API_URL}/admin/leaderboard/rewards/${id}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showToast('Reward deleted successfully', 'success');
            loadRewards();
        } else {
            showToast('Failed to delete reward', 'error');
        }
    } catch (error) {
        console.error('Error deleting reward:', error);
        showToast('Failed to delete reward', 'error');
    }
}

// Handle reward form submission
document.getElementById('rewardForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const rewardId = document.getElementById('rewardId').value;
    const data = {
        period: document.getElementById('rewardPeriod').value,
        rank_from: parseInt(document.getElementById('rankFrom').value),
        rank_to: parseInt(document.getElementById('rankTo').value),
        reward_amount: parseInt(document.getElementById('rewardAmount').value),
        is_active: document.getElementById('isActive').checked
    };

    try {
        const url = rewardId
            ? `${API_URL}/admin/leaderboard/rewards/${rewardId}`
            : `${API_URL}/admin/leaderboard/rewards`;

        const method = rewardId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            showToast(rewardId ? 'Reward updated' : 'Reward created', 'success');
            closeRewardModal();
            loadRewards();
        } else {
            showToast('Failed to save reward', 'error');
        }
    } catch (error) {
        console.error('Error saving reward:', error);
        showToast('Failed to save reward', 'error');
    }
});

// Close modal on outside click
document.getElementById('rewardModal').addEventListener('click', (e) => {
    if (e.target.id === 'rewardModal') {
        closeRewardModal();
    }
});

// Load current period stats
async function loadCurrentStats() {
    try {
        const response = await fetch(`${API_URL}/admin/leaderboard/current-stats?period_type=${currentPeriod}`);
        const stats = await response.json();

        const statsDiv = document.getElementById('current-stats');
        statsDiv.innerHTML = `
            <div class="bg-dark-700 rounded p-3">
                <div class="text-xs text-gray-400">–£—á–∞—Å—Ç–Ω–∏–∫–∏</div>
                <div class="text-2xl font-bold">${stats.participants_count || 0}</div>
            </div>
            <div class="bg-dark-700 rounded p-3">
                <div class="text-xs text-gray-400">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã</div>
                <div class="text-2xl font-bold text-yellow-400">${formatNumber(stats.potential_rewards || 0)} PRED</div>
            </div>
            <div class="bg-dark-700 rounded p-3">
                <div class="text-xs text-gray-400">–ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã</div>
                <div class="text-2xl font-bold">${stats.rewards_configured || 0}</div>
            </div>
        `;
    } catch (error) {
        console.error('Error loading current stats:', error);
    }
}

// Load notification queue stats
async function loadQueueStats() {
    try {
        const response = await fetch(`${API_URL}/admin/notifications/queue-stats`);
        const stats = await response.json();

        const statsDiv = document.getElementById('queue-stats');
        statsDiv.innerHTML = `
            <div class="flex justify-between text-sm">
                <span class="text-gray-400">–í—Å–µ–≥–æ:</span>
                <span class="font-bold">${stats.total || 0}</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-gray-400">Pending:</span>
                <span class="font-bold text-yellow-400">${stats.pending || 0}</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-gray-400">Processing:</span>
                <span class="font-bold text-blue-400">${stats.processing || 0}</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-gray-400">Sent:</span>
                <span class="font-bold text-green-400">${stats.sent || 0}</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-gray-400">Failed:</span>
                <span class="font-bold text-red-400">${stats.failed || 0}</span>
            </div>
        `;
    } catch (error) {
        console.error('Error loading queue stats:', error);
    }
}

// Load closed periods history
async function loadPeriodsHistory() {
    try {
        const response = await fetch(`${API_URL}/admin/leaderboard/periods?period_type=${currentPeriod}&limit=50`);
        const periods = await response.json();

        const tbody = document.getElementById('periods-tbody');

        if (periods.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-400 py-8">–ù–µ—Ç –∑–∞–∫—Ä—ã—Ç—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤</td></tr>';
            return;
        }

        tbody.innerHTML = periods.map(period => {
            const startDate = new Date(period.start_date).toLocaleDateString('ru-RU');
            const endDate = new Date(period.end_date).toLocaleDateString('ru-RU');
            const closedAt = new Date(period.closed_at).toLocaleString('ru-RU');
            const periodType = period.period_type === 'week' ? '–ù–µ–¥–µ–ª—è' : '–ú–µ—Å—è—Ü';

            return `
                <tr class="border-t border-gray-800 hover:bg-dark-700">
                    <td class="px-4 py-3 font-mono text-sm text-gray-400">#${period.id}</td>
                    <td class="px-4 py-3">${periodType}</td>
                    <td class="px-4 py-3 text-sm">
                        <div>${startDate}</div>
                        <div class="text-gray-400">${endDate}</div>
                    </td>
                    <td class="px-4 py-3 text-right">${period.participants_count}</td>
                    <td class="px-4 py-3 text-right font-bold text-green-400">${period.winners_count}</td>
                    <td class="px-4 py-3 text-right">
                        <div class="font-bold text-yellow-400">${formatNumber(period.total_rewards_distributed)} PRED</div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-400">${closedAt}</td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading periods history:', error);
    }
}

// Close period
async function closePeriod() {
    const periodName = currentPeriod === 'week' ? '–Ω–µ–¥–µ–ª—å–Ω—ã–π' : '–º–µ—Å—è—á–Ω—ã–π';
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å ${periodName} –ø–µ—Ä–∏–æ–¥?\n\n–≠—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç —Ä–∞—Å—á–µ—Ç –Ω–∞–≥—Ä–∞–¥ –∏ –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤—Å–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è–º.`)) {
        return;
    }

    const btn = document.getElementById('close-period-btn');
    btn.disabled = true;
    btn.innerHTML = '–ó–∞–∫—Ä—ã—Ç–∏–µ...';

    try {
        // Send period_type as query parameter
        const response = await fetch(`${API_URL}/admin/leaderboard/close-period?period_type=${currentPeriod}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();

        if (result.success) {
            showToast(`–ü–µ—Ä–∏–æ–¥ –∑–∞–∫—Ä—ã—Ç! –ù–∞–≥—Ä–∞–¥—ã: ${result.total_rewards} PRED –¥–ª—è ${result.winners_count} –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π`, 'success');
            // Reload all data
            loadLeaderboard();
            loadRewards();
            loadCurrentStats();
            loadPeriodsHistory();
            loadQueueStats();
        } else {
            showToast(`–û—à–∏–±–∫–∞: ${result.error}`, 'error');
        }
    } catch (error) {
        console.error('Error closing period:', error);
        showToast('Failed to close period', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = `–ó–∞–∫—Ä—ã—Ç—å <span id="close-period-type">${periodName}</span> –ø–µ—Ä–∏–æ–¥`;
    }
}

// Initialize
loadLeaderboard();
loadRewards();
loadCurrentStats();
loadQueueStats();
loadPeriodsHistory();

// Auto-refresh queue stats every 30 seconds
setInterval(loadQueueStats, 30000);
</script>
{% endblock %}
