{% extends "base.html" %}

{% block title %}Broadcast - ThePred Admin{% endblock %}

{% block content %}
<div class="max-w-4xl">
    <h1 class="text-3xl font-bold mb-8">Broadcast Message</h1>

    <div class="bg-dark-800 rounded-lg p-8">
        <form id="broadcast-form" class="space-y-6">
            <!-- Target Selection -->
            <div>
                <label class="block text-sm font-medium mb-3">Send To:</label>
                <div class="space-y-2">
                    <label class="flex items-center">
                        <input type="radio" name="target" value="all" checked class="mr-2" onchange="toggleUserInput()">
                        <span>All Users</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="target" value="specific" class="mr-2" onchange="toggleUserInput()">
                        <span>Specific User</span>
                    </label>
                </div>
                <input type="number" id="telegram-id" placeholder="Telegram ID" class="mt-2 w-full bg-dark-700 border border-gray-700 rounded px-4 py-2 hidden">
            </div>

            <!-- Parse Mode -->
            <div>
                <label class="block text-sm font-medium mb-3">Format:</label>
                <select id="parse-mode" class="w-full bg-dark-700 border border-gray-700 rounded px-4 py-2">
                    <option value="HTML">HTML</option>
                    <option value="Markdown">Markdown</option>
                </select>
            </div>

            <!-- Editor Toolbar -->
            <div>
                <label class="block text-sm font-medium mb-3">Message:</label>
                <div class="flex space-x-2 mb-3 bg-dark-700 p-2 rounded">
                    <button type="button" onclick="insertTag('<b>', '</b>')" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 rounded text-sm font-bold">B</button>
                    <button type="button" onclick="insertTag('<i>', '</i>')" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 rounded text-sm italic">I</button>
                    <button type="button" onclick="insertTag('<code>', '</code>')" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 rounded text-sm font-mono">Code</button>
                    <button type="button" onclick="insertTag('<a href=\\\"\\\">', '</a>')" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 rounded text-sm">Link</button>
                    <button type="button" onclick="insertTag('\\n• ', '')" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 rounded text-sm">• List</button>
                </div>
                <textarea id="message" rows="10" class="w-full bg-dark-700 border border-gray-700 rounded px-4 py-3 font-mono text-sm" placeholder="Enter your message here..." oninput="updatePreview()"></textarea>
            </div>

            <!-- Preview -->
            <div>
                <label class="block text-sm font-medium mb-3">Preview:</label>
                <div id="preview" class="bg-dark-700 border border-gray-700 rounded px-4 py-3 min-h-[100px] text-gray-400">
                    Preview will appear here...
                </div>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-end">
                <button type="submit" class="gradient-gold text-black font-bold px-8 py-3 rounded-lg hover:opacity-90 transition">
                    Send Broadcast
                </button>
            </div>
        </form>

        <!-- Stats -->
        <div id="stats" class="mt-8 p-4 bg-dark-700 rounded hidden">
            <h3 class="font-bold mb-2">Last Broadcast Result:</h3>
            <div class="text-sm space-y-1">
                <p>Total Recipients: <span id="total-recipients" class="font-bold">0</span></p>
                <p>Sent: <span id="sent-count" class="font-bold text-green-400">0</span></p>
                <p>Failed: <span id="failed-count" class="font-bold text-red-400">0</span></p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function toggleUserInput() {
    const target = document.querySelector('input[name="target"]:checked').value;
    const telegramIdInput = document.getElementById('telegram-id');
    telegramIdInput.classList.toggle('hidden', target === 'all');
}

function insertTag(openTag, closeTag) {
    const textarea = document.getElementById('message');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    const selectedText = text.substring(start, end);

    textarea.value = text.substring(0, start) + openTag + selectedText + closeTag + text.substring(end);
    textarea.focus();
    textarea.selectionStart = start + openTag.length;
    textarea.selectionEnd = end + openTag.length;
    updatePreview();
}

function updatePreview() {
    const message = document.getElementById('message').value;
    const preview = document.getElementById('preview');

    if (!message) {
        preview.innerHTML = '<span class="text-gray-400">Preview will appear here...</span>';
        return;
    }

    // Simple HTML rendering for preview
    preview.innerHTML = message
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/&lt;b&gt;(.*?)&lt;\/b&gt;/g, '<b>$1</b>')
        .replace(/&lt;i&gt;(.*?)&lt;\/i&gt;/g, '<i>$1</i>')
        .replace(/&lt;code&gt;(.*?)&lt;\/code&gt;/g, '<code class="bg-dark-900 px-1 rounded">$1</code>')
        .replace(/&lt;a href="(.*?)"&gt;(.*?)&lt;\/a&gt;/g, '<a href="$1" class="text-blue-400 underline">$2</a>')
        .replace(/\n/g, '<br>');
}

document.getElementById('broadcast-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const target = document.querySelector('input[name="target"]:checked').value;
    const message = document.getElementById('message').value;
    const parseMode = document.getElementById('parse-mode').value;

    if (!message.trim()) {
        showToast('Please enter a message', 'error');
        return;
    }

    const payload = {
        message,
        target,
        parse_mode: parseMode
    };

    if (target === 'specific') {
        const telegramId = document.getElementById('telegram-id').value;
        if (!telegramId) {
            showToast('Please enter Telegram ID', 'error');
            return;
        }
        payload.telegram_id = parseInt(telegramId);
    }

    if (!confirm(`Send this message to ${target === 'all' ? 'ALL USERS' : 'user ' + payload.telegram_id}?`)) {
        return;
    }

    try {
        const response = await fetch(`${API_URL}/admin/broadcast`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (response.ok) {
            showToast(result.message);

            // Show stats
            document.getElementById('total-recipients').textContent = result.total_recipients;
            document.getElementById('sent-count').textContent = result.sent;
            document.getElementById('failed-count').textContent = result.failed;
            document.getElementById('stats').classList.remove('hidden');

            // Clear form
            document.getElementById('message').value = '';
            updatePreview();
        } else {
            showToast(result.detail || 'Failed to send broadcast', 'error');
        }
    } catch (error) {
        console.error('Broadcast error:', error);
        showToast('Network error. Please try again.', 'error');
    }
});
</script>
{% endblock %}
