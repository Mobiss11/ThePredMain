{% extends "base.html" %}

{% block title %}Broadcast - ThePred Admin{% endblock %}

{% block content %}
<div class="max-w-5xl">
    <h1 class="text-3xl font-bold mb-8">üì¢ Broadcast Message</h1>

    <div class="bg-dark-800 rounded-lg p-8">
        <form id="broadcast-form" class="space-y-6">
            <!-- Target Selection -->
            <div>
                <label class="block text-sm font-medium mb-3">Send To:</label>
                <div class="space-y-2">
                    <label class="flex items-center">
                        <input type="radio" name="target" value="all" checked class="mr-2" onchange="toggleUserInput()">
                        <span>All Users</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="target" value="specific" class="mr-2" onchange="toggleUserInput()">
                        <span>Specific User</span>
                    </label>
                </div>
                <input type="number" id="telegram-id" placeholder="Telegram ID" class="mt-2 w-full bg-dark-700 border border-gray-700 rounded px-4 py-2 hidden">
            </div>

            <!-- Image Upload -->
            <div>
                <label class="block text-sm font-medium mb-3">Image (Optional):</label>
                <div class="space-y-3">
                    <input type="file" id="image-upload" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                    <button type="button" onclick="document.getElementById('image-upload').click()"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        Upload Image
                    </button>

                    <!-- Image Preview -->
                    <div id="image-preview-container" class="hidden">
                        <div class="relative inline-block">
                            <img id="image-preview" src="" alt="Preview" class="max-w-md max-h-64 rounded-lg border border-gray-700">
                            <button type="button" onclick="removeImage()"
                                    class="absolute top-2 right-2 bg-red-600 hover:bg-red-700 rounded-full p-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <p class="text-sm text-gray-400 mt-2">‚ö†Ô∏è With image: max 1000 characters</p>
                    </div>
                </div>
            </div>

            <!-- Parse Mode -->
            <div>
                <label class="block text-sm font-medium mb-3">Format:</label>
                <select id="parse-mode" class="w-full bg-dark-700 border border-gray-700 rounded px-4 py-2">
                    <option value="HTML">HTML</option>
                    <option value="Markdown">Markdown</option>
                </select>
            </div>

            <!-- Editor Toolbar -->
            <div>
                <label class="block text-sm font-medium mb-3">Message:</label>

                <!-- Formatting Toolbar -->
                <div class="flex flex-wrap gap-2 mb-3 bg-dark-700 p-3 rounded-lg">
                    <!-- Text formatting -->
                    <button type="button" onclick="insertTag('<b>', '</b>')" class="px-3 py-2 bg-gray-600 hover:bg-gray-700 rounded text-sm font-bold" title="Bold">
                        <strong>B</strong>
                    </button>
                    <button type="button" onclick="insertTag('<i>', '</i>')" class="px-3 py-2 bg-gray-600 hover:bg-gray-700 rounded text-sm italic" title="Italic">
                        <em>I</em>
                    </button>
                    <button type="button" onclick="insertTag('<u>', '</u>')" class="px-3 py-2 bg-gray-600 hover:bg-gray-700 rounded text-sm underline" title="Underline">
                        <u>U</u>
                    </button>
                    <button type="button" onclick="insertTag('<s>', '</s>')" class="px-3 py-2 bg-gray-600 hover:bg-gray-700 rounded text-sm line-through" title="Strikethrough">
                        <s>S</s>
                    </button>
                    <button type="button" onclick="insertTag('<code>', '</code>')" class="px-3 py-2 bg-gray-600 hover:bg-gray-700 rounded text-sm font-mono" title="Code">
                        Code
                    </button>

                    <div class="w-px bg-gray-600"></div>

                    <!-- Links and lists -->
                    <button type="button" onclick="insertLink()" class="px-3 py-2 bg-gray-600 hover:bg-gray-700 rounded text-sm" title="Link">
                        üîó Link
                    </button>
                    <button type="button" onclick="insertTag('\\n‚Ä¢ ', '')" class="px-3 py-2 bg-gray-600 hover:bg-gray-700 rounded text-sm" title="Bullet">
                        ‚Ä¢ List
                    </button>
                    <button type="button" onclick="insertTag('\\n', '')" class="px-3 py-2 bg-gray-600 hover:bg-gray-700 rounded text-sm" title="New Line">
                        ‚Üµ
                    </button>

                    <div class="w-px bg-gray-600"></div>

                    <!-- Emoji picker button -->
                    <button type="button" onclick="toggleEmojiPicker()" class="px-3 py-2 bg-yellow-600 hover:bg-yellow-700 rounded text-sm" title="Emoji">
                        üòä Emoji
                    </button>
                </div>

                <!-- Emoji Picker -->
                <div id="emoji-picker" class="hidden bg-dark-700 border border-gray-600 rounded-lg p-4 mb-3 max-h-64 overflow-y-auto">
                    <div class="grid grid-cols-8 gap-2">
                        <button type="button" onclick="insertEmoji('üòä')" class="text-2xl hover:bg-dark-600 rounded p-1">üòä</button>
                        <button type="button" onclick="insertEmoji('üòÇ')" class="text-2xl hover:bg-dark-600 rounded p-1">üòÇ</button>
                        <button type="button" onclick="insertEmoji('‚ù§Ô∏è')" class="text-2xl hover:bg-dark-600 rounded p-1">‚ù§Ô∏è</button>
                        <button type="button" onclick="insertEmoji('üî•')" class="text-2xl hover:bg-dark-600 rounded p-1">üî•</button>
                        <button type="button" onclick="insertEmoji('‚≠ê')" class="text-2xl hover:bg-dark-600 rounded p-1">‚≠ê</button>
                        <button type="button" onclick="insertEmoji('üíé')" class="text-2xl hover:bg-dark-600 rounded p-1">üíé</button>
                        <button type="button" onclick="insertEmoji('üéØ')" class="text-2xl hover:bg-dark-600 rounded p-1">üéØ</button>
                        <button type="button" onclick="insertEmoji('üéâ')" class="text-2xl hover:bg-dark-600 rounded p-1">üéâ</button>
                        <button type="button" onclick="insertEmoji('üí∞')" class="text-2xl hover:bg-dark-600 rounded p-1">üí∞</button>
                        <button type="button" onclick="insertEmoji('üíµ')" class="text-2xl hover:bg-dark-600 rounded p-1">üíµ</button>
                        <button type="button" onclick="insertEmoji('üìà')" class="text-2xl hover:bg-dark-600 rounded p-1">üìà</button>
                        <button type="button" onclick="insertEmoji('üìâ')" class="text-2xl hover:bg-dark-600 rounded p-1">üìâ</button>
                        <button type="button" onclick="insertEmoji('üöÄ')" class="text-2xl hover:bg-dark-600 rounded p-1">üöÄ</button>
                        <button type="button" onclick="insertEmoji('üí™')" class="text-2xl hover:bg-dark-600 rounded p-1">üí™</button>
                        <button type="button" onclick="insertEmoji('üëç')" class="text-2xl hover:bg-dark-600 rounded p-1">üëç</button>
                        <button type="button" onclick="insertEmoji('üëé')" class="text-2xl hover:bg-dark-600 rounded p-1">üëé</button>
                        <button type="button" onclick="insertEmoji('‚úÖ')" class="text-2xl hover:bg-dark-600 rounded p-1">‚úÖ</button>
                        <button type="button" onclick="insertEmoji('‚ùå')" class="text-2xl hover:bg-dark-600 rounded p-1">‚ùå</button>
                        <button type="button" onclick="insertEmoji('‚ö†Ô∏è')" class="text-2xl hover:bg-dark-600 rounded p-1">‚ö†Ô∏è</button>
                        <button type="button" onclick="insertEmoji('üéÅ')" class="text-2xl hover:bg-dark-600 rounded p-1">üéÅ</button>
                        <button type="button" onclick="insertEmoji('üèÜ')" class="text-2xl hover:bg-dark-600 rounded p-1">üèÜ</button>
                        <button type="button" onclick="insertEmoji('ü•á')" class="text-2xl hover:bg-dark-600 rounded p-1">ü•á</button>
                        <button type="button" onclick="insertEmoji('ü•à')" class="text-2xl hover:bg-dark-600 rounded p-1">ü•à</button>
                        <button type="button" onclick="insertEmoji('ü•â')" class="text-2xl hover:bg-dark-600 rounded p-1">ü•â</button>
                        <button type="button" onclick="insertEmoji('‚ö°')" class="text-2xl hover:bg-dark-600 rounded p-1">‚ö°</button>
                        <button type="button" onclick="insertEmoji('üí´')" class="text-2xl hover:bg-dark-600 rounded p-1">üí´</button>
                        <button type="button" onclick="insertEmoji('üåü')" class="text-2xl hover:bg-dark-600 rounded p-1">üåü</button>
                        <button type="button" onclick="insertEmoji('üéä')" class="text-2xl hover:bg-dark-600 rounded p-1">üéä</button>
                        <button type="button" onclick="insertEmoji('üéà')" class="text-2xl hover:bg-dark-600 rounded p-1">üéà</button>
                        <button type="button" onclick="insertEmoji('üîî')" class="text-2xl hover:bg-dark-600 rounded p-1">üîî</button>
                        <button type="button" onclick="insertEmoji('üì¢')" class="text-2xl hover:bg-dark-600 rounded p-1">üì¢</button>
                        <button type="button" onclick="insertEmoji('üì£')" class="text-2xl hover:bg-dark-600 rounded p-1">üì£</button>
                    </div>
                </div>

                <!-- Textarea -->
                <textarea id="message" rows="12"
                          class="w-full bg-dark-700 border border-gray-700 rounded px-4 py-3 font-mono text-sm resize-y"
                          placeholder="Enter your message here..."
                          oninput="updatePreview(); updateCharCounter()"></textarea>

                <!-- Character Counter -->
                <div class="flex justify-between items-center mt-2">
                    <span id="char-counter" class="text-sm text-gray-400">
                        0 / 4096 characters
                    </span>
                    <span id="char-warning" class="text-sm text-red-400 hidden">
                        ‚ö†Ô∏è Character limit exceeded!
                    </span>
                </div>
            </div>

            <!-- Preview -->
            <div>
                <label class="block text-sm font-medium mb-3">Preview:</label>
                <div class="bg-dark-700 border border-gray-700 rounded-lg p-6">
                    <!-- Image preview in message -->
                    <div id="preview-image-container" class="hidden mb-4">
                        <img id="preview-image" src="" alt="Message image" class="max-w-sm rounded-lg">
                    </div>

                    <!-- Text preview -->
                    <div id="preview" class="min-h-[100px] text-gray-300">
                        <span class="text-gray-500 italic">Preview will appear here...</span>
                    </div>
                </div>
            </div>

            <!-- Schedule Options -->
            <div id="schedule-section" class="hidden space-y-4">
                <!-- Current Time -->
                <div class="bg-purple-900/30 border border-purple-700/50 rounded-lg p-4 mb-4">
                    <div class="text-sm font-medium text-gray-300 mb-2">‚è∞ –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è:</div>
                    <div class="flex gap-6">
                        <div>
                            <span class="text-xs text-gray-400">UTC:</span>
                            <span class="text-lg font-bold text-white ml-2" id="current-utc-time">--:--</span>
                        </div>
                        <div class="text-gray-600">|</div>
                        <div>
                            <span class="text-xs text-gray-400">–ú–æ—Å–∫–≤–∞:</span>
                            <span class="text-lg font-bold text-white ml-2" id="current-moscow-time">--:--</span>
                        </div>
                    </div>
                </div>

                <!-- Schedule Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-3">
                        üìÖ –ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å? (–≤—ã–±–∏—Ä–∞–π –≤—Ä–µ–º—è –≤ <strong class="text-yellow-400">UTC</strong>):
                    </label>
                    <input type="datetime-local" id="schedule-datetime"
                           class="w-full bg-dark-700 border border-gray-700 rounded px-4 py-3 text-lg"
                           onchange="updateMoscowTime()">

                    <!-- Selected Time Display -->
                    <div id="selected-time-display" class="hidden mt-4 bg-green-900/30 border border-green-700/50 rounded-lg p-4">
                        <div class="text-sm font-medium text-gray-300 mb-3">‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è:</div>
                        <div class="space-y-2">
                            <div>
                                <span class="text-xs text-gray-400">UTC:</span>
                                <span class="text-xl font-bold text-white ml-2" id="selected-utc-time">--:--</span>
                            </div>
                            <div>
                                <span class="text-xs text-gray-400">–ú–æ—Å–∫–≤–∞ (UTC+3):</span>
                                <span class="text-2xl font-bold text-green-400 ml-2" id="selected-moscow-time">--:--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="flex justify-between items-center">
                <div class="text-sm text-gray-400">
                    <p>üí° <strong>Tip:</strong> Messages are queued and sent with rate limiting (30 msg/sec)</p>
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="toggleSchedule()" id="schedule-toggle-btn"
                            class="bg-purple-600 hover:bg-purple-700 text-white font-bold px-6 py-3 rounded-lg transition flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span id="schedule-toggle-text">Schedule</span>
                    </button>
                    <button type="submit" class="gradient-gold text-black font-bold px-8 py-3 rounded-lg hover:opacity-90 transition flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                        <span id="send-btn-text">Send Now</span>
                    </button>
                </div>
            </div>
        </form>

        <!-- Stats -->
        <div id="stats" class="mt-8 p-6 bg-dark-700 rounded-lg hidden">
            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Broadcast Queued Successfully!
            </h3>
            <div class="grid grid-cols-3 gap-4 text-sm">
                <div class="bg-dark-800 p-4 rounded">
                    <p class="text-gray-400 mb-1">Total Recipients</p>
                    <p id="total-recipients" class="text-2xl font-bold">0</p>
                </div>
                <div class="bg-dark-800 p-4 rounded">
                    <p class="text-gray-400 mb-1">Messages Queued</p>
                    <p id="queued-count" class="text-2xl font-bold text-blue-400">0</p>
                </div>
                <div class="bg-dark-800 p-4 rounded">
                    <p class="text-gray-400 mb-1">Estimated Time</p>
                    <p id="estimated-time" class="text-2xl font-bold text-yellow-400">~0s</p>
                </div>
            </div>
            <p class="text-sm text-gray-400 mt-4">
                ‚ÑπÔ∏è Messages are being sent in the background. Check the Telegram bot logs for delivery status.
            </p>
        </div>

        <!-- Scheduled Broadcasts Table -->
        <div class="mt-8 bg-dark-800 rounded-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Scheduled Broadcasts
                </h2>
                <button onclick="loadScheduledBroadcasts()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm">
                    üîÑ Refresh
                </button>
            </div>

            <div id="scheduled-broadcasts-container">
                <div class="text-center text-gray-400 py-8">
                    Loading...
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let uploadedImageFile = null;
let uploadedImageUrl = null;

function toggleUserInput() {
    const target = document.querySelector('input[name="target"]:checked').value;
    const telegramIdInput = document.getElementById('telegram-id');
    telegramIdInput.classList.toggle('hidden', target === 'all');
}

function toggleEmojiPicker() {
    const picker = document.getElementById('emoji-picker');
    picker.classList.toggle('hidden');
}

function insertEmoji(emoji) {
    const textarea = document.getElementById('message');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;

    textarea.value = text.substring(0, start) + emoji + text.substring(end);
    textarea.focus();
    textarea.selectionStart = start + emoji.length;
    textarea.selectionEnd = start + emoji.length;

    updatePreview();
    updateCharCounter();

    // Close emoji picker after selection
    // toggleEmojiPicker();
}

function insertTag(openTag, closeTag) {
    const textarea = document.getElementById('message');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    const selectedText = text.substring(start, end);

    textarea.value = text.substring(0, start) + openTag + selectedText + closeTag + text.substring(end);
    textarea.focus();
    textarea.selectionStart = start + openTag.length;
    textarea.selectionEnd = end + openTag.length;

    updatePreview();
    updateCharCounter();
}

function insertLink() {
    const url = prompt('Enter URL:', 'https://');
    if (!url) return;

    const text = prompt('Link text:', 'Click here');
    if (!text) return;

    insertTag(`<a href="${url}">`, '</a>');
}

function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Check file size (max 10MB for Telegram)
    if (file.size > 10 * 1024 * 1024) {
        showToast('Image too large! Max size: 10MB', 'error');
        return;
    }

    // Check file type
    if (!file.type.startsWith('image/')) {
        showToast('Please upload an image file', 'error');
        return;
    }

    uploadedImageFile = file;

    // Show preview
    const reader = new FileReader();
    reader.onload = (e) => {
        uploadedImageUrl = e.target.result;
        document.getElementById('image-preview').src = e.target.result;
        document.getElementById('preview-image').src = e.target.result;
        document.getElementById('image-preview-container').classList.remove('hidden');
        document.getElementById('preview-image-container').classList.remove('hidden');
        updateCharCounter();
    };
    reader.readAsDataURL(file);
}

function removeImage() {
    uploadedImageFile = null;
    uploadedImageUrl = null;
    document.getElementById('image-upload').value = '';
    document.getElementById('image-preview-container').classList.add('hidden');
    document.getElementById('preview-image-container').classList.add('hidden');
    updateCharCounter();
}

function updateCharCounter() {
    const message = document.getElementById('message').value;
    const charCount = message.length;
    const maxChars = uploadedImageFile ? 1000 : 4096;

    const counter = document.getElementById('char-counter');
    const warning = document.getElementById('char-warning');

    counter.textContent = `${charCount} / ${maxChars} characters`;

    if (charCount > maxChars) {
        counter.classList.add('text-red-400');
        counter.classList.remove('text-gray-400');
        warning.classList.remove('hidden');
    } else {
        counter.classList.remove('text-red-400');
        counter.classList.add('text-gray-400');
        warning.classList.add('hidden');
    }
}

function updatePreview() {
    const message = document.getElementById('message').value;
    const preview = document.getElementById('preview');

    if (!message) {
        preview.innerHTML = '<span class="text-gray-500 italic">Preview will appear here...</span>';
        return;
    }

    // Simple HTML rendering for preview
    let html = message
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/&lt;b&gt;(.*?)&lt;\/b&gt;/g, '<b>$1</b>')
        .replace(/&lt;i&gt;(.*?)&lt;\/i&gt;/g, '<i>$1</i>')
        .replace(/&lt;u&gt;(.*?)&lt;\/u&gt;/g, '<u>$1</u>')
        .replace(/&lt;s&gt;(.*?)&lt;\/s&gt;/g, '<s>$1</s>')
        .replace(/&lt;code&gt;(.*?)&lt;\/code&gt;/g, '<code class="bg-dark-900 px-1 rounded">$1</code>')
        .replace(/&lt;a href="(.*?)"&gt;(.*?)&lt;\/a&gt;/g, '<a href="$1" class="text-blue-400 underline">$2</a>')
        .replace(/\n/g, '<br>');

    preview.innerHTML = html;
}

document.getElementById('broadcast-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const target = document.querySelector('input[name="target"]:checked').value;
    const message = document.getElementById('message').value;
    const parseMode = document.getElementById('parse-mode').value;
    const maxChars = uploadedImageFile ? 1000 : 4096;

    // Validation
    if (!message.trim()) {
        showToast('Please enter a message', 'error');
        return;
    }

    if (message.length > maxChars) {
        showToast(`Message too long! Max ${maxChars} characters ${uploadedImageFile ? 'with image' : ''}`, 'error');
        return;
    }

    const formData = new FormData();
    formData.append('message', message);
    formData.append('target', target);
    formData.append('parse_mode', parseMode);

    if (target === 'specific') {
        const telegramId = document.getElementById('telegram-id').value;
        if (!telegramId) {
            showToast('Please enter Telegram ID', 'error');
            return;
        }
        formData.append('telegram_id', telegramId);
    }

    if (uploadedImageFile) {
        formData.append('image', uploadedImageFile);
    }

    // Check schedule mode
    let endpoint = '/admin/broadcast';
    let confirmMessage = `Send this message to ${target === 'all' ? 'ALL USERS' : 'user ' + formData.get('telegram_id')}?`;

    if (scheduleMode) {
        const scheduledAt = document.getElementById('schedule-datetime').value;
        if (!scheduledAt) {
            showToast('Please select scheduled time', 'error');
            return;
        }

        // Convert to ISO 8601 UTC
        const scheduledDate = new Date(scheduledAt);
        formData.append('scheduled_at', scheduledDate.toISOString());
        endpoint = '/admin/broadcast/schedule';
        confirmMessage = `Schedule this message for ${scheduledDate.toLocaleString('en-US', { timeZone: 'UTC' })} UTC?`;
    }

    if (!confirm(confirmMessage)) {
        return;
    }

    try {
        showToast(scheduleMode ? 'Scheduling broadcast...' : 'Queuing broadcast...', 'info');

        const response = await fetch(`${API_URL}${endpoint}`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (response.ok) {
            if (scheduleMode) {
                showToast('Broadcast scheduled successfully!', 'success');
                // Clear form and reload scheduled table
                document.getElementById('message').value = '';
                removeImage();
                updatePreview();
                updateCharCounter();
                toggleSchedule(); // Reset schedule mode
                loadScheduledBroadcasts();
            } else {
                showToast('Broadcast queued successfully!', 'success');

                // Show stats
                document.getElementById('total-recipients').textContent = result.total_recipients || 0;
                document.getElementById('queued-count').textContent = result.queued || result.total_recipients || 0;

                // Estimate time (30 messages per second Telegram limit)
                const estimatedSeconds = Math.ceil((result.total_recipients || 0) / 30);
                document.getElementById('estimated-time').textContent = estimatedSeconds < 60
                    ? `~${estimatedSeconds}s`
                    : `~${Math.ceil(estimatedSeconds / 60)}m`;

                document.getElementById('stats').classList.remove('hidden');

                // Clear form
                document.getElementById('message').value = '';
                removeImage();
                updatePreview();
                updateCharCounter();
            }
        } else {
            showToast(result.detail || 'Failed to send broadcast', 'error');
        }
    } catch (error) {
        console.error('Broadcast error:', error);
        showToast('Network error. Please try again.', 'error');
    }
});

// Scheduler functions
let scheduleMode = false;

function toggleSchedule() {
    scheduleMode = !scheduleMode;
    const section = document.getElementById('schedule-section');
    const toggleBtn = document.getElementById('schedule-toggle-btn');
    const toggleText = document.getElementById('schedule-toggle-text');
    const sendBtnText = document.getElementById('send-btn-text');

    if (scheduleMode) {
        section.classList.remove('hidden');
        toggleBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
        toggleBtn.classList.add('bg-green-600', 'hover:bg-green-700');
        toggleText.textContent = 'Cancel Schedule';
        sendBtnText.textContent = 'Schedule Broadcast';

        // Start updating current time
        updateCurrentTime();
        currentTimeInterval = setInterval(updateCurrentTime, 1000);

        // Set min datetime to now + 5 minutes
        const now = new Date();
        now.setMinutes(now.getMinutes() + 5);
        document.getElementById('schedule-datetime').min = now.toISOString().slice(0, 16);
    } else {
        section.classList.add('hidden');
        toggleBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
        toggleBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
        toggleText.textContent = 'Schedule';
        sendBtnText.textContent = 'Send Now';
        document.getElementById('schedule-datetime').value = '';
        document.getElementById('selected-time-display').classList.add('hidden');

        // Stop updating current time
        if (currentTimeInterval) {
            clearInterval(currentTimeInterval);
            currentTimeInterval = null;
        }
    }
}

// Update current time every second
let currentTimeInterval = null;

function updateCurrentTime() {
    const now = new Date();

    // UTC time
    const utcTime = now.toLocaleString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        timeZone: 'UTC'
    });

    // Moscow time
    const moscowTime = now.toLocaleString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        timeZone: 'Europe/Moscow'
    });

    document.getElementById('current-utc-time').textContent = utcTime;
    document.getElementById('current-moscow-time').textContent = moscowTime;
}

function updateMoscowTime() {
    const utcInput = document.getElementById('schedule-datetime').value;
    const display = document.getElementById('selected-time-display');

    if (!utcInput) {
        display.classList.add('hidden');
        return;
    }

    // Parse as UTC (datetime-local returns local time, so we treat it as UTC)
    const utcDate = new Date(utcInput);

    // Format UTC time
    const utcFormatted = utcDate.toLocaleString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        timeZone: 'UTC'
    });

    // Format Moscow time (UTC+3)
    const moscowFormatted = utcDate.toLocaleString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        timeZone: 'Europe/Moscow'
    });

    document.getElementById('selected-utc-time').textContent = utcFormatted;
    document.getElementById('selected-moscow-time').textContent = moscowFormatted;
    display.classList.remove('hidden');
}

async function loadScheduledBroadcasts() {
    const container = document.getElementById('scheduled-broadcasts-container');
    container.innerHTML = '<div class="text-center text-gray-400 py-8">Loading...</div>';

    try {
        const response = await fetch(`${API_URL}/admin/broadcast/scheduled?status=PENDING&limit=20`);
        const data = await response.json();

        if (!data.broadcasts || data.broadcasts.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-400 py-8">
                    <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    No scheduled broadcasts
                </div>
            `;
            return;
        }

        let html = `
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-700">
                            <th class="text-left py-3 px-4">Message</th>
                            <th class="text-left py-3 px-4">Target</th>
                            <th class="text-left py-3 px-4">Scheduled (UTC)</th>
                            <th class="text-left py-3 px-4">Status</th>
                            <th class="text-center py-3 px-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        for (const broadcast of data.broadcasts) {
            const scheduledDate = new Date(broadcast.scheduled_at);
            const statusColors = {
                'PENDING': 'bg-yellow-600',
                'PROCESSING': 'bg-blue-600',
                'COMPLETED': 'bg-green-600',
                'CANCELLED': 'bg-red-600'
            };

            html += `
                <tr class="border-b border-gray-700 hover:bg-dark-700">
                    <td class="py-3 px-4">
                        ${broadcast.photo_url ? 'üì∑ ' : ''}
                        ${broadcast.message_text}
                    </td>
                    <td class="py-3 px-4">
                        ${broadcast.target === 'all' ? 'All Users' : `User ${broadcast.target_telegram_id}`}
                    </td>
                    <td class="py-3 px-4 text-sm">
                        ${scheduledDate.toLocaleString('en-US', { timeZone: 'UTC' })}
                    </td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 rounded text-xs ${statusColors[broadcast.status] || 'bg-gray-600'}">
                            ${broadcast.status}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-center">
                        ${broadcast.status === 'PENDING' ? `
                            <button onclick="cancelScheduledBroadcast(${broadcast.id})"
                                    class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm">
                                Cancel
                            </button>
                        ` : '-'}
                    </td>
                </tr>
            `;
        }

        html += `
                    </tbody>
                </table>
            </div>
        `;

        container.innerHTML = html;
    } catch (error) {
        console.error('Failed to load scheduled broadcasts:', error);
        container.innerHTML = `
            <div class="text-center text-red-400 py-8">
                Failed to load scheduled broadcasts. Please try again.
            </div>
        `;
    }
}

async function cancelScheduledBroadcast(id) {
    if (!confirm('Cancel this scheduled broadcast?')) {
        return;
    }

    try {
        const response = await fetch(`${API_URL}/admin/broadcast/scheduled/${id}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (response.ok) {
            showToast('Scheduled broadcast cancelled', 'success');
            loadScheduledBroadcasts();
        } else {
            showToast(result.detail || 'Failed to cancel broadcast', 'error');
        }
    } catch (error) {
        console.error('Cancel error:', error);
        showToast('Network error. Please try again.', 'error');
    }
}

// Initialize
updateCharCounter();
loadScheduledBroadcasts();
</script>
{% endblock %}
