{% extends "base.html" %}

{% block title %}{{ 'Edit Mission' if mission else 'Create Mission' }} - ThePred Admin{% endblock %}

{% block content %}
<div class="max-w-4xl">
    <div class="flex items-center justify-between mb-8">
        <h1 class="text-3xl font-bold">{{ 'Edit Mission' if mission else 'Create Mission' }}</h1>
        <button onclick="window.location.href='/missions'" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg">
            ‚Üê Back to Missions
        </button>
    </div>

    <form id="mission-form" class="bg-dark-800 rounded-lg p-8 space-y-6">
        <!-- Title -->
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Title</label>
            <input type="text" id="title" name="title" required
                   class="w-full bg-dark-700 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500"
                   placeholder="First Bet"
                   value="{{ mission.title if mission else '' }}">
        </div>

        <!-- Description -->
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Description</label>
            <textarea id="description" name="description" rows="3"
                      class="w-full bg-dark-700 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500"
                      placeholder="Make your first bet on any event">{{ mission.description if mission else '' }}</textarea>
        </div>

        <!-- Icon Selection -->
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-3">Icon</label>

            <!-- Default Icons (Emoji) -->
            <div class="mb-4">
                <p class="text-sm text-gray-400 mb-3">Choose from default emoji icons:</p>
                <div class="grid grid-cols-8 gap-3" id="default-icons">
                    <!-- Daily/Achievement Icons -->
                    <label class="cursor-pointer">
                        <input type="radio" name="icon" value="üéØ" class="hidden icon-radio" {% if mission and mission.icon == 'üéØ' %}checked{% endif %}>
                        <div class="icon-option p-3 bg-dark-700 rounded-lg border-2 border-transparent hover:border-blue-500 transition-colors flex items-center justify-center">
                            <span class="text-4xl">üéØ</span>
                        </div>
                        <p class="text-xs text-center mt-1 text-gray-400">Target</p>
                    </label>

                    <label class="cursor-pointer">
                        <input type="radio" name="icon" value="üå±" class="hidden icon-radio" {% if mission and mission.icon == 'üå±' %}checked{% endif %}>
                        <div class="icon-option p-3 bg-dark-700 rounded-lg border-2 border-transparent hover:border-blue-500 transition-colors flex items-center justify-center">
                            <span class="text-4xl">üå±</span>
                        </div>
                        <p class="text-xs text-center mt-1 text-gray-400">Beginner</p>
                    </label>

                    <label class="cursor-pointer">
                        <input type="radio" name="icon" value="ü•á" class="hidden icon-radio" {% if mission and mission.icon == 'ü•á' %}checked{% endif %}>
                        <div class="icon-option p-3 bg-dark-700 rounded-lg border-2 border-transparent hover:border-blue-500 transition-colors flex items-center justify-center">
                            <span class="text-4xl">ü•á</span>
                        </div>
                        <p class="text-xs text-center mt-1 text-gray-400">First Win</p>
                    </label>

                    <label class="cursor-pointer">
                        <input type="radio" name="icon" value="üî•" class="hidden icon-radio" {% if mission and mission.icon == 'üî•' %}checked{% endif %}>
                        <div class="icon-option p-3 bg-dark-700 rounded-lg border-2 border-transparent hover:border-blue-500 transition-colors flex items-center justify-center">
                            <span class="text-4xl">üî•</span>
                        </div>
                        <p class="text-xs text-center mt-1 text-gray-400">Streak</p>
                    </label>

                    <label class="cursor-pointer">
                        <input type="radio" name="icon" value="üìà" class="hidden icon-radio" {% if mission and mission.icon == 'üìà' %}checked{% endif %}>
                        <div class="icon-option p-3 bg-dark-700 rounded-lg border-2 border-transparent hover:border-blue-500 transition-colors flex items-center justify-center">
                            <span class="text-4xl">üìà</span>
                        </div>
                        <p class="text-xs text-center mt-1 text-gray-400">Trader</p>
                    </label>

                    <label class="cursor-pointer">
                        <input type="radio" name="icon" value="‚Çø" class="hidden icon-radio" {% if mission and mission.icon == '‚Çø' %}checked{% endif %}>
                        <div class="icon-option p-3 bg-dark-700 rounded-lg border-2 border-transparent hover:border-blue-500 transition-colors flex items-center justify-center">
                            <span class="text-4xl">‚Çø</span>
                        </div>
                        <p class="text-xs text-center mt-1 text-gray-400">Crypto</p>
                    </label>

                    <label class="cursor-pointer">
                        <input type="radio" name="icon" value="üë•" class="hidden icon-radio" {% if mission and mission.icon == 'üë•' %}checked{% endif %}>
                        <div class="icon-option p-3 bg-dark-700 rounded-lg border-2 border-transparent hover:border-blue-500 transition-colors flex items-center justify-center">
                            <span class="text-4xl">üë•</span>
                        </div>
                        <p class="text-xs text-center mt-1 text-gray-400">Referral</p>
                    </label>

                    <label class="cursor-pointer">
                        <input type="radio" name="icon" value="üíé" class="hidden icon-radio" {% if mission and mission.icon == 'üíé' %}checked{% endif %}>
                        <div class="icon-option p-3 bg-dark-700 rounded-lg border-2 border-transparent hover:border-blue-500 transition-colors flex items-center justify-center">
                            <span class="text-4xl">üíé</span>
                        </div>
                        <p class="text-xs text-center mt-1 text-gray-400">Premium</p>
                    </label>

                    <label class="cursor-pointer">
                        <input type="radio" name="icon" value="üèÜ" class="hidden icon-radio" {% if mission and mission.icon == 'üèÜ' %}checked{% endif %}>
                        <div class="icon-option p-3 bg-dark-700 rounded-lg border-2 border-transparent hover:border-blue-500 transition-colors flex items-center justify-center">
                            <span class="text-4xl">üèÜ</span>
                        </div>
                        <p class="text-xs text-center mt-1 text-gray-400">Victory</p>
                    </label>

                    <label class="cursor-pointer">
                        <input type="radio" name="icon" value="‚öΩ" class="hidden icon-radio" {% if mission and mission.icon == '‚öΩ' %}checked{% endif %}>
                        <div class="icon-option p-3 bg-dark-700 rounded-lg border-2 border-transparent hover:border-blue-500 transition-colors flex items-center justify-center">
                            <span class="text-4xl">‚öΩ</span>
                        </div>
                        <p class="text-xs text-center mt-1 text-gray-400">Sports</p>
                    </label>

                    <label class="cursor-pointer">
                        <input type="radio" name="icon" value="üó≥Ô∏è" class="hidden icon-radio" {% if mission and mission.icon == 'üó≥Ô∏è' %}checked{% endif %}>
                        <div class="icon-option p-3 bg-dark-700 rounded-lg border-2 border-transparent hover:border-blue-500 transition-colors flex items-center justify-center">
                            <span class="text-4xl">üó≥Ô∏è</span>
                        </div>
                        <p class="text-xs text-center mt-1 text-gray-400">Politics</p>
                    </label>

                    <label class="cursor-pointer">
                        <input type="radio" name="icon" value="üéñÔ∏è" class="hidden icon-radio" {% if mission and mission.icon == 'üéñÔ∏è' %}checked{% endif %}>
                        <div class="icon-option p-3 bg-dark-700 rounded-lg border-2 border-transparent hover:border-blue-500 transition-colors flex items-center justify-center">
                            <span class="text-4xl">üéñÔ∏è</span>
                        </div>
                        <p class="text-xs text-center mt-1 text-gray-400">Veteran</p>
                    </label>

                    <label class="cursor-pointer">
                        <input type="radio" name="icon" value="üèÖ" class="hidden icon-radio" {% if mission and mission.icon == 'üèÖ' %}checked{% endif %}>
                        <div class="icon-option p-3 bg-dark-700 rounded-lg border-2 border-transparent hover:border-blue-500 transition-colors flex items-center justify-center">
                            <span class="text-4xl">üèÖ</span>
                        </div>
                        <p class="text-xs text-center mt-1 text-gray-400">Legend</p>
                    </label>

                    <label class="cursor-pointer">
                        <input type="radio" name="icon" value="üöÄ" class="hidden icon-radio" {% if mission and mission.icon == 'üöÄ' %}checked{% endif %}>
                        <div class="icon-option p-3 bg-dark-700 rounded-lg border-2 border-transparent hover:border-blue-500 transition-colors flex items-center justify-center">
                            <span class="text-4xl">üöÄ</span>
                        </div>
                        <p class="text-xs text-center mt-1 text-gray-400">Rocket</p>
                    </label>

                    <label class="cursor-pointer">
                        <input type="radio" name="icon" value="üìä" class="hidden icon-radio" {% if mission and mission.icon == 'üìä' %}checked{% endif %}>
                        <div class="icon-option p-3 bg-dark-700 rounded-lg border-2 border-transparent hover:border-blue-500 transition-colors flex items-center justify-center">
                            <span class="text-4xl">üìä</span>
                        </div>
                        <p class="text-xs text-center mt-1 text-gray-400">Stats</p>
                    </label>

                    <label class="cursor-pointer">
                        <input type="radio" name="icon" value="üì¢" class="hidden icon-radio" {% if mission and mission.icon == 'üì¢' %}checked{% endif %}>
                        <div class="icon-option p-3 bg-dark-700 rounded-lg border-2 border-transparent hover:border-blue-500 transition-colors flex items-center justify-center">
                            <span class="text-4xl">üì¢</span>
                        </div>
                        <p class="text-xs text-center mt-1 text-gray-400">Subscribe</p>
                    </label>
                </div>
            </div>

            <!-- Custom Icon Upload -->
            <div class="mt-6 p-4 bg-dark-700 rounded-lg">
                <p class="text-sm text-gray-400 mb-3">Or upload custom icon URL:</p>
                <input type="text" id="custom-icon-url" placeholder="https://example.com/icon.png or emoji"
                       class="w-full bg-dark-800 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500"
                       value="{{ mission.custom_icon_url if mission and mission.custom_icon_url else '' }}">
                <p class="text-xs text-gray-400 mt-2">Enter a URL to an image or paste an emoji (e.g., üòé)</p>
            </div>
        </div>

        <!-- Reward Amount -->
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Reward Amount</label>
                <input type="number" id="reward_amount" name="reward_amount" required min="0"
                       class="w-full bg-dark-700 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500"
                       placeholder="500"
                       value="{{ mission.reward_amount if mission else '' }}">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Currency</label>
                <select id="reward_currency" name="reward_currency"
                        class="w-full bg-dark-700 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500">
                    <option value="PRED" {% if not mission or mission.reward_currency == 'PRED' %}selected{% endif %}>PRED</option>
                    <option value="TON" {% if mission and mission.reward_currency == 'TON' %}selected{% endif %}>TON</option>
                </select>
            </div>
        </div>

        <!-- Type -->
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Type</label>
            <select id="type" name="type" onchange="toggleSubscriptionFields()"
                    class="w-full bg-dark-700 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500">
                <option value="achievement" {% if not mission or mission.type == 'achievement' %}selected{% endif %}>Achievement</option>
                <option value="daily" {% if mission and mission.type == 'daily' %}selected{% endif %}>Daily</option>
                <option value="weekly" {% if mission and mission.type == 'weekly' %}selected{% endif %}>Weekly</option>
                <option value="subscription" {% if mission and mission.type == 'subscription' %}selected{% endif %}>Subscription</option>
                <option value="special" {% if mission and mission.type == 'special' %}selected{% endif %}>Special</option>
            </select>
        </div>

        <!-- Subscription Fields (shown only for subscription type) -->
        <div id="subscription-fields" class="space-y-4 p-4 bg-dark-700 rounded-lg" style="display: none;">
            <p class="text-sm text-blue-400 mb-3">üì¢ Subscription Mission Settings</p>

            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Channel ID</label>
                <input type="text" id="channel_id" name="channel_id"
                       class="w-full bg-dark-800 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500"
                       placeholder="-1001234567890"
                       value="{{ mission.channel_id if mission else '' }}">
                <p class="text-xs text-gray-400 mt-1">Telegram channel ID (numeric with -100 prefix)</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Channel Username</label>
                <input type="text" id="channel_username" name="channel_username"
                       class="w-full bg-dark-800 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500"
                       placeholder="thepred_official"
                       value="{{ mission.channel_username if mission else '' }}">
                <p class="text-xs text-gray-400 mt-1">Without @ symbol</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Channel URL</label>
                <input type="text" id="channel_url" name="channel_url"
                       class="w-full bg-dark-800 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500"
                       placeholder="https://t.me/thepred_official"
                       value="{{ mission.channel_url if mission else '' }}">
                <p class="text-xs text-gray-400 mt-1">Full Telegram channel link</p>
            </div>
        </div>

        <!-- Requirements -->
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Requirement Type</label>
            <select id="requirement_type" onchange="updateRequirementInput()"
                    class="w-full bg-dark-700 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500">
                <option value="bets_count">Bets Count</option>
                <option value="wins_count">Wins Count</option>
                <option value="win_streak">Win Streak</option>
                <option value="daily_bets">Daily Bets</option>
                <option value="weekly_bets">Weekly Bets</option>
                <option value="referrals_count">Referrals Count</option>
                <option value="category_bets">Category Bets</option>
                <option value="subscription">Subscription</option>
            </select>

            <div id="requirement-input" class="mt-3">
                <!-- Dynamic input based on requirement type -->
            </div>
        </div>

        <!-- Active Status -->
        <div class="flex items-center">
            <input type="checkbox" id="is_active" name="is_active" class="w-5 h-5 rounded bg-dark-700 border-gray-600"
                   {% if not mission or mission.is_active %}checked{% endif %}>
            <label for="is_active" class="ml-3 text-sm text-gray-300">Active</label>
        </div>

        <!-- Submit Button -->
        <div class="flex items-center justify-end space-x-4 pt-4">
            <button type="button" onclick="window.location.href='/missions'"
                    class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-medium">
                Cancel
            </button>
            <button type="submit"
                    class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium">
                {{ 'Update Mission' if mission else 'Create Mission' }}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
const missionId = {{ mission.id if mission else 'null' }};
const existingRequirements = {{ mission.requirements | tojson if mission else '{}' }};

// Icon selection handling
document.querySelectorAll('.icon-radio').forEach(radio => {
    radio.addEventListener('change', function() {
        // Update border styling
        document.querySelectorAll('.icon-option').forEach(opt => {
            opt.classList.remove('border-blue-500');
            opt.classList.add('border-transparent');
        });

        if (this.checked) {
            this.closest('label').querySelector('.icon-option').classList.remove('border-transparent');
            this.closest('label').querySelector('.icon-option').classList.add('border-blue-500');

            // Clear custom icon URL when selecting emoji
            document.getElementById('custom-icon-url').value = '';
        }
    });
});

// Initialize selected icon border
const checkedRadio = document.querySelector('.icon-radio:checked');
if (checkedRadio) {
    checkedRadio.closest('label').querySelector('.icon-option').classList.add('border-blue-500');
}

// Custom icon URL input - clear radio buttons when typing
document.getElementById('custom-icon-url').addEventListener('input', function() {
    if (this.value.trim()) {
        // Uncheck all radio buttons
        document.querySelectorAll('.icon-radio').forEach(radio => radio.checked = false);
        document.querySelectorAll('.icon-option').forEach(opt => {
            opt.classList.remove('border-blue-500');
            opt.classList.add('border-transparent');
        });
    }
});

// Toggle subscription fields visibility
function toggleSubscriptionFields() {
    const type = document.getElementById('type').value;
    const subscriptionFields = document.getElementById('subscription-fields');

    if (type === 'subscription') {
        subscriptionFields.style.display = 'block';
        // Auto-select subscription requirement type
        document.getElementById('requirement_type').value = 'subscription';
        updateRequirementInput();
    } else {
        subscriptionFields.style.display = 'none';
    }
}

// Requirement input handling
function updateRequirementInput() {
    const type = document.getElementById('requirement_type').value;
    const container = document.getElementById('requirement-input');

    let html = '';

    switch(type) {
        case 'bets_count':
        case 'wins_count':
        case 'win_streak':
        case 'daily_bets':
        case 'weekly_bets':
        case 'referrals_count':
            const labelMap = {
                'bets_count': 'Total Bets Count',
                'wins_count': 'Total Wins Count',
                'win_streak': 'Win Streak Length',
                'daily_bets': 'Daily Bets Count',
                'weekly_bets': 'Weekly Bets Count',
                'referrals_count': 'Referrals Count'
            };
            html = `
                <label class="block text-sm text-gray-400 mb-2">${labelMap[type]}</label>
                <input type="number" id="requirement_value" min="1" value="${existingRequirements[type] || 1}"
                       class="w-full bg-dark-700 border border-gray-600 rounded-lg px-4 py-3">
            `;
            break;
        case 'category_bets':
            const catValue = existingRequirements.category_bets || {};
            html = `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Category</label>
                        <select id="requirement_category" class="w-full bg-dark-700 border border-gray-600 rounded-lg px-4 py-3">
                            <option value="Crypto" ${catValue.category === 'Crypto' ? 'selected' : ''}>Crypto</option>
                            <option value="Sports" ${catValue.category === 'Sports' ? 'selected' : ''}>Sports</option>
                            <option value="Politics" ${catValue.category === 'Politics' ? 'selected' : ''}>Politics</option>
                            <option value="Tech" ${catValue.category === 'Tech' ? 'selected' : ''}>Tech</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Count</label>
                        <input type="number" id="requirement_count" min="1" value="${catValue.count || 1}"
                               class="w-full bg-dark-700 border border-gray-600 rounded-lg px-4 py-3">
                    </div>
                </div>
            `;
            break;
        case 'subscription':
            html = `
                <div class="p-3 bg-blue-900 bg-opacity-20 border border-blue-600 rounded-lg text-sm text-blue-300">
                    ‚ÑπÔ∏è Subscription missions automatically check if user is subscribed to the channel specified above.
                    Make sure to fill in the Channel ID, Username, and URL fields.
                </div>
            `;
            break;
    }

    container.innerHTML = html;
}

// Initialize requirement input
if (Object.keys(existingRequirements).length > 0) {
    // Set requirement type based on existing requirements
    const reqType = Object.keys(existingRequirements)[0];
    document.getElementById('requirement_type').value = reqType;
}
updateRequirementInput();

// Initialize subscription fields visibility
toggleSubscriptionFields();

// Form submission
document.getElementById('mission-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    // Get icon value - priority: custom URL > selected emoji
    const customIconUrl = document.getElementById('custom-icon-url').value.trim();
    let icon = customIconUrl || document.querySelector('.icon-radio:checked')?.value || 'üéØ';

    // Build requirements object
    const reqType = document.getElementById('requirement_type').value;
    let requirements = {};

    if (reqType === 'category_bets') {
        requirements[reqType] = {
            category: document.getElementById('requirement_category').value,
            count: parseInt(document.getElementById('requirement_count').value)
        };
    } else if (reqType === 'subscription') {
        requirements[reqType] = true;
    } else {
        const valueInput = document.getElementById('requirement_value');
        if (valueInput) {
            requirements[reqType] = parseInt(valueInput.value);
        }
    }

    const missionType = document.getElementById('type').value;

    const data = {
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        icon: icon,
        custom_icon_url: customIconUrl || null,
        reward_amount: parseFloat(document.getElementById('reward_amount').value),
        reward_currency: document.getElementById('reward_currency').value,
        type: missionType,
        requirements: requirements,
        is_active: document.getElementById('is_active').checked
    };

    // Add subscription fields if type is subscription
    if (missionType === 'subscription') {
        data.channel_id = document.getElementById('channel_id').value || null;
        data.channel_username = document.getElementById('channel_username').value || null;
        data.channel_url = document.getElementById('channel_url').value || null;
    }

    console.log('Submitting mission data:', data);

    try {
        const url = missionId
            ? `${API_URL}/admin/missions/${missionId}`
            : `${API_URL}/admin/missions`;

        const method = missionId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            alert(missionId ? 'Mission updated successfully!' : 'Mission created successfully!');
            window.location.href = '/missions';
        } else {
            const error = await response.json();
            alert(`Error: ${error.detail || 'Failed to save mission'}`);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to save mission. Please try again.');
    }
});
</script>
{% endblock %}
