{% extends "base.html" %}
{% block title %}Support Tickets - ThePred Admin{% endblock %}
{% block content %}
<div class="max-w-7xl">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold">Support Tickets</h1>
        <button onclick="loadTickets()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Refresh
        </button>
    </div>

    <!-- Filters -->
    <div class="bg-dark-800 rounded-xl p-6 border border-gray-700 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-2">Status</label>
                <select id="status-filter" onchange="loadTickets()" class="w-full bg-dark-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
                    <option value="">All Statuses</option>
                    <option value="open">Open</option>
                    <option value="in_progress">In Progress</option>
                    <option value="waiting_user">Waiting User</option>
                    <option value="closed">Closed</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-2">Priority</label>
                <select id="priority-filter" onchange="loadTickets()" class="w-full bg-dark-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
                    <option value="">All Priorities</option>
                    <option value="low">üü¢ Low</option>
                    <option value="medium">üü° Medium</option>
                    <option value="high">üü† High</option>
                    <option value="urgent">üî¥ Urgent</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-2">Results</label>
                <div class="text-white text-2xl font-bold" id="ticket-count">0</div>
            </div>
        </div>
    </div>

    <!-- Tickets List -->
    <div id="tickets-container" class="space-y-4">
        <div class="text-center py-12 text-gray-400">
            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
            </svg>
            Loading tickets...
        </div>
    </div>
</div>

<!-- Ticket Detail Modal -->
<div id="ticket-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center z-50 p-4" onclick="closeModal(event)">
    <div class="bg-dark-800 rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden border border-gray-700" onclick="event.stopPropagation()">
        <!-- Modal Header -->
        <div class="border-b border-gray-700 p-6 flex justify-between items-start">
            <div>
                <h2 id="modal-title" class="text-2xl font-bold mb-2">Ticket #123</h2>
                <div id="modal-info" class="text-sm text-gray-400"></div>
            </div>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>

        <!-- Messages -->
        <div id="messages-container" class="p-6 space-y-4 max-h-96 overflow-y-auto">
            <!-- Messages will be loaded here -->
        </div>

        <!-- Reply Form -->
        <div id="reply-section" class="border-t border-gray-700 p-6">
            <form id="reply-form" onsubmit="sendReply(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Your Reply</label>
                    <textarea name="message" required rows="4" class="w-full bg-dark-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 resize-none" placeholder="Type your response..."></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Attachment (optional)</label>
                    <input type="file" name="attachment" accept="image/*" class="w-full bg-dark-700 border border-gray-600 rounded-lg px-4 py-2 text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700">
                </div>

                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-yellow-500 to-orange-500 text-black font-bold py-3 rounded-lg hover:opacity-90 transition">
                        Send Reply
                    </button>
                    <button type="button" onclick="closeModal()" class="px-6 py-3 bg-dark-700 text-white rounded-lg hover:bg-dark-600 transition">
                        Cancel
                    </button>
                </div>
            </form>

            <!-- Status Actions -->
            <div class="grid grid-cols-3 gap-3 mt-4 pt-4 border-t border-gray-700">
                <button onclick="updateStatus('in_progress')" class="bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg text-sm transition">
                    ‚è≥ In Progress
                </button>
                <button onclick="updateStatus('waiting_user')" class="bg-yellow-600 hover:bg-yellow-700 text-white py-2 rounded-lg text-sm transition">
                    ‚è∞ Waiting User
                </button>
                <button onclick="updateStatus('closed')" class="bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg text-sm transition">
                    ‚úÖ Close
                </button>
            </div>
        </div>

        <!-- Closed Message -->
        <div id="closed-message" class="hidden p-6 border-t border-gray-700 bg-red-900 bg-opacity-20">
            <p class="text-red-400 text-center">This ticket is closed.</p>
        </div>
    </div>
</div>

<script>
let currentTicketId = null;
let allTickets = [];

async function loadTickets() {
    try {
        const status = document.getElementById('status-filter').value;
        const priority = document.getElementById('priority-filter').value;

        let url = '/api/admin/support/tickets?limit=100';
        if (status) url += `&status=${status}`;
        if (priority) url += `&priority=${priority}`;

        const response = await fetch(url);
        allTickets = await response.json();

        document.getElementById('ticket-count').textContent = allTickets.length;
        renderTickets();
    } catch (error) {
        console.error('Error loading tickets:', error);
        document.getElementById('tickets-container').innerHTML = `
            <div class="text-center py-12 text-red-400">
                <p>Error loading tickets: ${error.message}</p>
            </div>
        `;
    }
}

function renderTickets() {
    const container = document.getElementById('tickets-container');

    if (allTickets.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12 text-gray-400">
                <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                </svg>
                <p>No tickets found</p>
            </div>
        `;
        return;
    }

    const priorityColors = {
        'low': 'green',
        'medium': 'yellow',
        'high': 'orange',
        'urgent': 'red'
    };

    const statusColors = {
        'open': 'blue',
        'in_progress': 'purple',
        'waiting_user': 'yellow',
        'closed': 'gray'
    };

    const priorityEmojis = { 'low': 'üü¢', 'medium': 'üü°', 'high': 'üü†', 'urgent': 'üî¥' };
    const statusNames = { 'open': 'Open', 'in_progress': 'In Progress', 'waiting_user': 'Waiting User', 'closed': 'Closed' };

    container.innerHTML = allTickets.map(ticket => {
        const date = new Date(ticket.created_at).toLocaleString();

        return `
            <div onclick="openTicket(${ticket.id})" class="bg-dark-800 rounded-xl p-6 border border-gray-700 hover:border-gray-600 cursor-pointer transition">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <h3 class="text-lg font-bold">${ticket.subject}</h3>
                            <span class="px-2 py-1 rounded-full text-xs bg-${priorityColors[ticket.priority]}-600 bg-opacity-20 text-${priorityColors[ticket.priority]}-400">
                                ${priorityEmojis[ticket.priority]} ${ticket.priority.toUpperCase()}
                            </span>
                        </div>
                        <div class="text-sm text-gray-400">
                            User: <span class="text-white">${ticket.user_name}</span> (ID: ${ticket.user_id})
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="px-3 py-1 rounded-full text-xs bg-${statusColors[ticket.status]}-600 bg-opacity-20 text-${statusColors[ticket.status]}-400 mb-2">
                            ${statusNames[ticket.status]}
                        </div>
                        <div class="text-xs text-gray-400">${date}</div>
                    </div>
                </div>

                ${ticket.last_message ? `
                    <p class="text-sm text-gray-400 truncate mb-2">${ticket.last_message}</p>
                ` : ''}

                <div class="flex items-center gap-4 text-xs text-gray-500">
                    <span>üí¨ ${ticket.message_count} messages</span>
                    ${ticket.admin_replied ?
                        '<span class="text-green-400">‚úì Replied</span>' :
                        '<span class="text-orange-400">‚ö† No reply</span>'}
                </div>
            </div>
        `;
    }).join('');
}

async function openTicket(ticketId) {
    currentTicketId = ticketId;
    const ticket = allTickets.find(t => t.id === ticketId);

    document.getElementById('ticket-modal').classList.remove('hidden');
    document.getElementById('modal-title').textContent = `Ticket #${ticketId}: ${ticket.subject}`;

    const priorityEmojis = { 'low': 'üü¢', 'medium': 'üü°', 'high': 'üü†', 'urgent': 'üî¥' };
    const statusNames = { 'open': 'Open', 'in_progress': 'In Progress', 'waiting_user': 'Waiting User', 'closed': 'Closed' };

    document.getElementById('modal-info').innerHTML = `
        <span>User: <strong>${ticket.user_name}</strong></span> ‚Ä¢
        <span>Priority: ${priorityEmojis[ticket.priority]} ${ticket.priority.toUpperCase()}</span> ‚Ä¢
        <span>Status: ${statusNames[ticket.status]}</span> ‚Ä¢
        <span>Created: ${new Date(ticket.created_at).toLocaleString()}</span>
    `;

    await loadMessages(ticketId, ticket.user_id);

    if (ticket.status === 'closed') {
        document.getElementById('reply-section').classList.add('hidden');
        document.getElementById('closed-message').classList.remove('hidden');
    } else {
        document.getElementById('reply-section').classList.remove('hidden');
        document.getElementById('closed-message').classList.add('hidden');
    }
}

async function loadMessages(ticketId, userId) {
    try {
        const response = await fetch(`/api/support/tickets/${ticketId}/messages?user_id=${userId}`);
        const messages = await response.json();

        const container = document.getElementById('messages-container');
        container.innerHTML = messages.map(msg => {
            const date = new Date(msg.created_at).toLocaleString();

            if (msg.is_admin) {
                return `
                    <div class="bg-yellow-600 bg-opacity-10 border-l-4 border-yellow-500 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-2 text-xs text-yellow-400">
                            <span>üëë Admin</span>
                            <span class="text-gray-400">${date}</span>
                        </div>
                        <p class="text-sm whitespace-pre-wrap">${msg.message}</p>
                        ${msg.attachment_url ? `<img src="${msg.attachment_url}" class="mt-3 rounded-lg max-w-sm">` : ''}
                    </div>
                `;
            } else {
                return `
                    <div class="bg-blue-600 bg-opacity-10 border-l-4 border-blue-500 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-2 text-xs text-blue-400">
                            <span>${msg.user_name || 'User'}</span>
                            <span class="text-gray-400">${date}</span>
                        </div>
                        <p class="text-sm whitespace-pre-wrap">${msg.message}</p>
                        ${msg.attachment_url ? `<img src="${msg.attachment_url}" class="mt-3 rounded-lg max-w-sm">` : ''}
                    </div>
                `;
            }
        }).join('');
    } catch (error) {
        console.error('Error loading messages:', error);
    }
}

async function sendReply(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');

    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending...';

    try {
        const response = await fetch(`/api/admin/support/tickets/${currentTicketId}/reply`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (response.ok) {
            form.reset();
            const ticket = allTickets.find(t => t.id === currentTicketId);
            await loadMessages(currentTicketId, ticket.user_id);
            await loadTickets();
            alert('Reply sent successfully!');
        } else {
            alert('Error: ' + (result.error || 'Failed to send reply'));
        }
    } catch (error) {
        console.error('Error sending reply:', error);
        alert('Error sending reply');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Reply';
    }
}

async function updateStatus(status) {
    if (!confirm(`Change ticket status to ${status}?`)) return;

    try {
        const response = await fetch(`/api/admin/support/tickets/${currentTicketId}/status?status=${status}`, {
            method: 'PUT'
        });

        if (response.ok) {
            await loadTickets();
            closeModal();
            alert('Status updated successfully!');
        } else {
            alert('Error updating status');
        }
    } catch (error) {
        console.error('Error updating status:', error);
        alert('Error updating status');
    }
}

function closeModal(event) {
    if (event && event.target.id !== 'ticket-modal') return;
    document.getElementById('ticket-modal').classList.add('hidden');
    document.getElementById('reply-form').reset();
    currentTicketId = null;
}

// Load tickets on page load
document.addEventListener('DOMContentLoaded', loadTickets);
</script>
{% endblock %}
