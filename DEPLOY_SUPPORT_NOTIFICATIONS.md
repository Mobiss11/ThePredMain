# Deploy: Support Ticket Telegram Notifications

**–î–∞—Ç–∞**: 7 –Ω–æ—è–±—Ä—è 2025

## –ß—Ç–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ

### Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- ‚úÖ –ü—Ä–∏ –æ—Ç–≤–µ—Ç–µ –∞–¥–º–∏–Ω–∞ –Ω–∞ —Ç–∏–∫–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–æ–º–µ—Ä —Ç–∏–∫–µ—Ç–∞, —Ç–µ–º—É –∏ –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è
- ‚úÖ Deep link –≤–µ–¥–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –≤ —Ç–∏–∫–µ—Ç –≤ webapp
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ:
1. **backend/app/core/config.py**: –î–æ–±–∞–≤–ª–µ–Ω—ã `BOT_TOKEN` –∏ `WEBAPP_URL`
2. **backend/app/api/endpoints/support.py**:
   - –§—É–Ω–∫—Ü–∏—è `send_telegram_notification()`
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `admin_reply` endpoint
   - –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏
3. **ecosystem.config.js**: –î–æ–±–∞–≤–ª–µ–Ω—ã `BOT_TOKEN` –∏ `WEBAPP_URL` –≤ env backend

---

## –î–µ–ø–ª–æ–π –Ω–∞ –ü—Ä–æ–¥

### –®–∞–≥ 1: –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
```bash
ssh root@your-server
# –∏–ª–∏
ssh user@your-server

cd /root/ThePred
# –∏–ª–∏
cd /home/ThePredMain
```

### –®–∞–≥ 2: –ü–æ–ª—É—á–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
```bash
git pull origin main

# –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å:
# - ecosystem.config.js (updated)
# - backend/app/core/config.py (updated)
# - backend/app/api/endpoints/support.py (updated)
```

### –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend —á–µ—Ä–µ–∑ PM2
```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend —Å –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
pm2 restart backend

# –ü–æ–¥–æ–∂–¥–∞—Ç—å 5 —Å–µ–∫—É–Ω–¥
sleep 5

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
pm2 status

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# backend | online | 0
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
```bash
# –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
pm2 logs backend

# –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ:
# "Initializing default missions..."
# "‚úì Created 19 default missions" (–∏–ª–∏ "already exist")
#
# –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# "BOT_TOKEN not configured" ‚ùå
```

### –®–∞–≥ 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
```bash
# 1. –û—Ç–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω–∫—É: https://thepred.tech/admin
# 2. –ü–µ—Ä–µ–π—Ç–∏ –≤ Support
# 3. –û—Ç–∫—Ä—ã—Ç—å –ª—é–±–æ–π —Ç–∏–∫–µ—Ç
# 4. –ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
# 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ backend:
pm2 logs backend --lines 50

# –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# INFO: Preparing to send Telegram notification for ticket 1
# INFO: User found: True, user_id: 1
# INFO: User telegram_id: 1234567890
# INFO: Calling send_telegram_notification for telegram_id 1234567890
# INFO: Attempting to send Telegram notification to user 1234567890 for ticket 1
# INFO: BOT_TOKEN configured: True
# INFO: WEBAPP_URL: https://thepred.tech
# INFO: Telegram notification sent to user 1234567890 for ticket 1

# 6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Telegram
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:
# üí¨ –ù–æ–≤—ã–π –æ—Ç–≤–µ—Ç –≤ —Ç–∏–∫–µ—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
#
# –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –≤–∞—à —Ç–∏–∫–µ—Ç #1
#
# üìù –¢–µ–º–∞: [—Ç–µ–º–∞ —Ç–∏–∫–µ—Ç–∞]
#
# –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—Ç–≤–µ—Ç–∞ üëá
# [üì± –û—Ç–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç] <- –∫–Ω–æ–ø–∫–∞
```

---

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: "BOT_TOKEN not configured" –≤ –ª–æ–≥–∞—Ö

**–ü—Ä–∏—á–∏–Ω–∞**: PM2 –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å —Ñ–ª–∞–≥–æ–º --update-env
pm2 restart backend --update-env

# –ò–ª–∏ –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
pm2 delete backend
pm2 start ecosystem.config.js --only backend
```

### –ü—Ä–æ–±–ª–µ–º–∞: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç, –Ω–æ –ª–æ–≥–æ–≤ –Ω–µ—Ç

**–ü—Ä–∏—á–∏–Ω–∞**: User.telegram_id = None –≤ –±–∞–∑–µ

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å telegram_id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
psql -U thepred -d thepred -c "SELECT id, username, telegram_id FROM users WHERE id = 1;"

# –ï—Å–ª–∏ telegram_id NULL, –æ–±–Ω–æ–≤–∏—Ç—å:
psql -U thepred -d thepred -c "UPDATE users SET telegram_id = 123456789 WHERE id = 1;"
```

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ "Failed to send Telegram notification"

**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ–≤–µ—Ä–Ω—ã–π BOT_TOKEN –∏–ª–∏ Telegram API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å BOT_TOKEN
pm2 env backend | grep BOT_TOKEN

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Telegram API
curl https://api.telegram.org/bot<BOT_TOKEN>/getMe

# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å JSON —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –±–æ—Ç–µ
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç" –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ–≤–µ—Ä–Ω—ã–π WEBAPP_URL

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å WEBAPP_URL
pm2 env backend | grep WEBAPP_URL

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: https://thepred.tech (–±–µ–∑ —Å–ª—ç—à–∞ –≤ –∫–æ–Ω—Ü–µ)

# –ï—Å–ª–∏ –Ω–µ–≤–µ—Ä–Ω–æ, –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ ecosystem.config.js –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å:
nano ecosystem.config.js
pm2 restart backend --update-env
```

---

## Rollback (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)

```bash
# 1. –û—Ç–∫–∞—Ç–∏—Ç—å –∫–æ–¥
git log --oneline -5
git reset --hard <previous-commit-hash>

# 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend
pm2 restart backend

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
pm2 status
pm2 logs backend
```

---

## –ò—Ç–æ–≥–æ–≤—ã–π –ß–µ–∫–ª–∏—Å—Ç

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è –æ—Ç–º–µ—Ç—å—Ç–µ:

- [ ] –ö–æ–¥ –ø–æ–ª—É—á–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (git pull)
- [ ] Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω (pm2 restart backend)
- [ ] Backend –≤ —Å—Ç–∞—Ç—É—Å–µ "online" (pm2 status)
- [ ] –í –ª–æ–≥–∞—Ö –ù–ï–¢ "BOT_TOKEN not configured"
- [ ] –í –ª–æ–≥–∞—Ö –ï–°–¢–¨ "BOT_TOKEN configured: True"
- [ ] –¢–µ—Å—Ç–æ–≤—ã–π —Ç–∏–∫–µ—Ç —Å–æ–∑–¥–∞–Ω
- [ ] –ê–¥–º–∏–Ω –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ —Ç–∏–∫–µ—Ç
- [ ] –í –ª–æ–≥–∞—Ö –ø–æ—è–≤–∏–ª–∏—Å—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [ ] –í –ª–æ–≥–∞—Ö "Telegram notification sent to user..."
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
- [ ] –ö–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç" —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Deep link –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–∫–µ—Ç

---

## –§–æ—Ä–º–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ:

```
üí¨ –ù–æ–≤—ã–π –æ—Ç–≤–µ—Ç –≤ —Ç–∏–∫–µ—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –≤–∞—à —Ç–∏–∫–µ—Ç #123

üìù –¢–µ–º–∞: –ü—Ä–æ–±–ª–µ–º–∞ —Å –±–∞–ª–∞–Ω—Å–æ–º

–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—Ç–≤–µ—Ç–∞ üëá

[üì± –û—Ç–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç] <- inline –∫–Ω–æ–ø–∫–∞
```

–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –æ—Ç–∫—Ä–æ–µ—Ç—Å—è webapp —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º:
```
https://thepred.tech?startapp=support_ticket_123
```

---

**–ì–æ—Ç–æ–≤–æ!** üéâ –¢–µ–ø–µ—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –æ—Ç–≤–µ—Ç–∞—Ö –ø–æ–¥–¥–µ—Ä–∂–∫–∏!
