{% extends "base.html" %}

{% block title %}–†–µ–π—Ç–∏–Ω–≥ - ThePred{% endblock %}

{% block content %}
<!-- Header -->
<div class="glass card-shine rounded-2xl p-6 mb-6">
    <h1 class="text-2xl font-bold mb-4">üèÜ –¢–∞–±–ª–∏—Ü–∞ –õ–∏–¥–µ—Ä–æ–≤</h1>

    <!-- Period Tabs -->
    <div class="grid grid-cols-2 gap-2">
        <button id="tab-week" class="period-tab gold-gradient rounded-lg py-2 font-bold text-black text-sm" onclick="switchPeriod('week')">
            –ù–µ–¥–µ–ª—è
        </button>
        <button id="tab-month" class="period-tab glass rounded-lg py-2 font-bold text-sm" onclick="switchPeriod('month')">
            –ú–µ—Å—è—Ü
        </button>
    </div>
</div>

<!-- Top 3 -->
<div class="mb-6">
    <div id="top3-container" class="grid grid-cols-3 gap-3 mb-4">
        <!-- Top 3 will be loaded dynamically -->
    </div>
</div>

<!-- Your Position -->
<div id="user-rank-card" class="mb-6">
    <!-- User rank will be loaded dynamically -->
</div>

<!-- Leaderboard List -->
<div class="glass rounded-2xl p-4 mb-6">
    <div id="leaderboard-list" class="space-y-3">
        <!-- Leaderboard entries will be loaded dynamically -->
    </div>
</div>

<!-- Rewards Info -->
<div class="glass rounded-2xl p-6">
    <h2 class="text-xl font-bold mb-4">üéÅ <span id="reward-period-title">–ù–µ–¥–µ–ª—å–Ω—ã–µ</span> –ù–∞–≥—Ä–∞–¥—ã</h2>
    <div id="rewards-list" class="space-y-2 text-sm">
        <!-- Rewards will be loaded dynamically -->
    </div>

    <div class="mt-4 pt-4 border-t border-gray-700">
        <div class="text-center text-blue-400 text-xs mb-2">
            üåç –í—Å–µ —Ä–∞—Å—á–µ—Ç—ã –ø–æ UTC –≤—Ä–µ–º–µ–Ω–∏
        </div>
        <div class="text-center text-gray-400 text-sm">
            –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ <span id="period-countdown" class="font-bold text-yellow-400">--</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Rank badge icons mapping
    const rankBadges = {
        'bronze': 'ü•â –ë—Ä–æ–Ω–∑–∞',
        'silver': 'ü•à –°–µ—Ä–µ–±—Ä–æ',
        'gold': 'ü•á –ó–æ–ª–æ—Ç–æ',
        'platinum': 'üí† –ü–ª–∞—Ç–∏–Ω–∞',
        'diamond': 'üíé –ê–ª–º–∞–∑',
        'master': 'üëë –ú–∞—Å—Ç–µ—Ä',
        'grandmaster': 'üèÜ –ì—Ä–∞–Ω–¥ –ú–∞—Å—Ç–µ—Ä'
    };

    // Medal emojis for top 3
    const medalEmojis = {
        1: 'ü•á',
        2: 'ü•à',
        3: 'ü•â'
    };

    // Current period
    let currentPeriod = 'week';

    // Switch period function
    function switchPeriod(period) {
        currentPeriod = period;

        // Update tab styles
        document.querySelectorAll('.period-tab').forEach(tab => {
            tab.classList.remove('gold-gradient', 'text-black');
            tab.classList.add('glass');
        });
        document.getElementById(`tab-${period}`).classList.remove('glass');
        document.getElementById(`tab-${period}`).classList.add('gold-gradient', 'text-black');

        // Update title
        document.getElementById('reward-period-title').textContent = period === 'week' ? '–ù–µ–¥–µ–ª—å–Ω—ã–µ' : '–ú–µ—Å—è—á–Ω—ã–µ';

        // Reload data
        loadLeaderboard();
        loadRewards();
        updateCountdown();
    }

    // Load leaderboard from API
    async function loadLeaderboard() {
        try {
            const response = await fetch(`/api/leaderboard?limit=100&period=${currentPeriod}`);
            if (!response.ok) {
                throw new Error('Failed to load leaderboard');
            }
            const leaderboard = await response.json();
            renderLeaderboard(leaderboard);
        } catch (error) {
            console.error('Error loading leaderboard:', error);
        }
    }

    // Load rewards for current period
    async function loadRewards() {
        try {
            const response = await fetch(`/api/leaderboard/rewards/${currentPeriod}`);
            if (!response.ok) {
                throw new Error('Failed to load rewards');
            }
            const rewards = await response.json();
            renderRewards(rewards);
        } catch (error) {
            console.error('Error loading rewards:', error);
        }
    }

    // Render rewards list
    function renderRewards(rewards) {
        if (!rewards || rewards.length === 0) {
            document.getElementById('rewards-list').innerHTML = '<div class="text-center text-gray-400">–ù–∞–≥—Ä–∞–¥—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã</div>';
            return;
        }

        const html = rewards.map(reward => {
            let rankText;
            if (reward.rank_from === reward.rank_to) {
                const medal = medalEmojis[reward.rank_from] || `#${reward.rank_from}`;
                rankText = `${medal} ${reward.rank_from}-–µ –ú–µ—Å—Ç–æ`;
            } else {
                rankText = `#${reward.rank_from}-${reward.rank_to} –ú–µ—Å—Ç–∞`;
            }

            return `
                <div class="flex items-center justify-between">
                    <span>${rankText}</span>
                    <span class="font-bold text-yellow-400">${window.formatNumber(reward.reward_amount)} PRED</span>
                </div>
            `;
        }).join('');

        document.getElementById('rewards-list').innerHTML = html;
    }

    // Update countdown timer
    function updateCountdown() {
        const now = new Date();
        let endDate;

        if (currentPeriod === 'week') {
            // End of week (Sunday 23:59:59)
            endDate = new Date(now);
            endDate.setDate(now.getDate() + (7 - now.getDay()));
            endDate.setHours(23, 59, 59, 999);
        } else {
            // End of month
            endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
        }

        const diff = endDate - now;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

        document.getElementById('period-countdown').textContent = `${days}–¥ ${hours}—á ${minutes}–º`;
    }

    // Render leaderboard entries
    function renderLeaderboard(leaderboard) {
        if (!leaderboard || leaderboard.length === 0) {
            document.getElementById('leaderboard-list').innerHTML = '<div class="text-center text-gray-400 py-8">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Ä–µ–π—Ç–∏–Ω–≥–∞</div>';
            document.getElementById('top3-container').innerHTML = '';
            return;
        }

        // Render top 3 (or less if fewer users)
        const top3Count = Math.min(leaderboard.length, 3);
        if (top3Count > 0) {
            renderTop3(leaderboard.slice(0, top3Count));
        }

        // Render rest of leaderboard (4+)
        const restOfLeaderboard = leaderboard.slice(3);

        // Hide leaderboard-list container if empty
        const leaderboardListContainer = document.getElementById('leaderboard-list').parentElement;
        if (restOfLeaderboard.length === 0) {
            leaderboardListContainer.style.display = 'none';
            return;
        } else {
            leaderboardListContainer.style.display = 'block';
        }

        const listHTML = restOfLeaderboard.map(entry => {
            const profitColor = entry.profit >= 0 ? 'text-yellow-400' : 'text-red-400';
            const profitPrefix = entry.profit >= 0 ? '+' : '';
            const rankBadge = rankBadges[entry.rank_badge.toLowerCase()] || 'ü•â –ë—Ä–æ–Ω–∑–∞';

            // Avatar or placeholder
            const avatarHtml = entry.photo_url
                ? `<img src="${entry.photo_url}" class="w-10 h-10 rounded-full object-cover" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23374151%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22white%22 font-size=%2240%22%3E${entry.first_name ? entry.first_name[0].toUpperCase() : '?'}%3C/text%3E%3C/svg%3E'" />`
                : `<div class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center text-lg font-bold">${entry.first_name ? entry.first_name[0].toUpperCase() : '?'}</div>`;

            const rewardBadge = entry.reward ? `<div class="text-xs text-yellow-400 mt-1">+${window.formatNumber(entry.reward)} PRED</div>` : '';

            return `
                <div class="glass rounded-xl p-4 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="font-bold text-lg w-8">#${entry.rank}</div>
                        ${avatarHtml}
                        <div>
                            <div class="font-bold">${entry.username || entry.first_name || `Player #${entry.user_id}`}</div>
                            <div class="text-xs text-gray-400">${rankBadge}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold ${profitColor}">${profitPrefix}${window.formatNumber(entry.profit)}</div>
                        <div class="text-xs text-gray-400">PRED</div>
                        <div class="text-xs text-gray-400">${entry.win_rate}% –ø–æ–±–µ–¥</div>
                        ${rewardBadge}
                    </div>
                </div>
            `;
        }).join('');

        document.getElementById('leaderboard-list').innerHTML = listHTML;
    }

    // Render top 3 specially
    function renderTop3(top3) {
        if (!top3 || top3.length === 0) return;

        // Update grid-cols based on number of users
        const container = document.getElementById('top3-container');
        container.className = container.className.replace(/grid-cols-\d+/, `grid-cols-${top3.length}`);

        // Order: 2nd, 1st, 3rd (but only if they exist)
        let orderedTop3 = [];
        if (top3.length === 1) {
            orderedTop3 = [top3[0]]; // Only 1st place
        } else if (top3.length === 2) {
            orderedTop3 = [top3[1], top3[0]]; // 2nd, 1st
        } else {
            orderedTop3 = [top3[1], top3[0], top3[2]]; // 2nd, 1st, 3rd
        }

        const html = orderedTop3.filter(entry => entry).map((entry, index) => {
            const actualRank = entry.rank;
            const medal = medalEmojis[actualRank];
            const isFirst = actualRank === 1;
            const profitPrefix = entry.profit >= 0 ? '+' : '';
            const classes = isFirst
                ? 'glass rounded-2xl p-4 text-center border-2 border-yellow-400 card-shine transform scale-110'
                : 'glass rounded-2xl p-4 text-center';
            const nameClass = isFirst ? 'font-bold mb-1' : 'font-bold text-sm mb-1';
            const profitClass = isFirst ? 'text-yellow-400 font-bold text-lg' : 'text-yellow-400 font-bold';

            // Avatar or placeholder
            const avatarHtml = entry.photo_url
                ? `<img src="${entry.photo_url}" class="w-${isFirst ? '16' : '14'} h-${isFirst ? '16' : '14'} ${isFirst ? 'gold-gradient pulse-gold border-4 border-yellow-400' : 'border-2 border-gray-600'} rounded-full mx-auto mb-2 object-cover" onerror="this.className='w-${isFirst ? '16' : '14'} h-${isFirst ? '16' : '14'} ${isFirst ? 'gold-gradient pulse-gold' : 'bg-gray-700'} rounded-full mx-auto mb-2 flex items-center justify-center'; this.outerHTML='<div class=\\''+this.className+'\\'><span class=\\'text-2xl\\'>${entry.first_name ? entry.first_name[0].toUpperCase() : '?'}</span></div>'" />`
                : `<div class="w-${isFirst ? '16' : '14'} h-${isFirst ? '16' : '14'} ${isFirst ? 'gold-gradient pulse-gold' : 'bg-gray-700'} rounded-full mx-auto mb-2 flex items-center justify-center"><span class="text-2xl">${entry.first_name ? entry.first_name[0].toUpperCase() : '?'}</span></div>`;

            const rewardText = entry.reward ? `<div class="text-xs text-yellow-400 mt-1">+${window.formatNumber(entry.reward)} PRED</div>` : '';

            return `
                <div class="${classes}">
                    <div class="${isFirst ? 'text-4xl mb-2' : 'text-3xl mb-2'}">${medal}</div>
                    ${avatarHtml}
                    <div class="${nameClass}">${entry.username || entry.first_name || `Player${actualRank}`}</div>
                    <div class="${profitClass}">${profitPrefix}${window.formatNumber(entry.profit)}</div>
                    <div class="text-gray-400 text-xs">PRED</div>
                    ${rewardText}
                </div>
            `;
        }).join('');

        document.getElementById('top3-container').innerHTML = html;
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadLeaderboard();
        loadRewards();
        updateCountdown();

        // Update countdown every minute
        setInterval(updateCountdown, 60000);
    });
</script>
{% endblock %}
