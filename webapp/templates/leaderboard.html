{% extends "base.html" %}

{% block title %}Leaderboard - ThePred{% endblock %}

{% block content %}
<!-- Header -->
<div class="glass card-shine rounded-2xl p-6 mb-6">
    <h1 class="text-2xl font-bold mb-4">üèÜ Leaderboard</h1>

    <div class="grid grid-cols-3 gap-2">
        <button class="gold-gradient rounded-lg py-2 font-bold text-black text-sm">
            Weekly
        </button>
        <button class="glass rounded-lg py-2 font-bold text-sm">
            Monthly
        </button>
        <button class="glass rounded-lg py-2 font-bold text-sm">
            All Time
        </button>
    </div>
</div>

<!-- Top 3 -->
<div class="mb-6">
    <div id="top3-container" class="grid grid-cols-3 gap-3 mb-4">
        <!-- Top 3 will be loaded dynamically -->
    </div>
</div>

<!-- Your Position -->
<div id="user-rank-card" class="mb-6">
    <!-- User rank will be loaded dynamically -->
</div>

<!-- Leaderboard List -->
<div class="glass rounded-2xl p-4 mb-6">
    <div id="leaderboard-list" class="space-y-3">
        <!-- Leaderboard entries will be loaded dynamically -->
    </div>
</div>

<!-- Rewards Info -->
<div class="glass rounded-2xl p-6">
    <h2 class="text-xl font-bold mb-4">üéÅ Weekly Rewards</h2>
    <div class="space-y-2 text-sm">
        <div class="flex items-center justify-between">
            <span>ü•á 1st Place</span>
            <span class="font-bold text-yellow-400">50,000 PRED</span>
        </div>
        <div class="flex items-center justify-between">
            <span>ü•à 2nd Place</span>
            <span class="font-bold text-yellow-400">30,000 PRED</span>
        </div>
        <div class="flex items-center justify-between">
            <span>ü•â 3rd Place</span>
            <span class="font-bold text-yellow-400">20,000 PRED</span>
        </div>
        <div class="flex items-center justify-between">
            <span>4th - 10th</span>
            <span class="font-bold text-yellow-400">1,000 PRED</span>
        </div>
        <div class="flex items-center justify-between">
            <span>11th - 50th</span>
            <span class="font-bold text-yellow-400">5,000 PRED</span>
        </div>
    </div>

    <div class="mt-4 pt-4 border-t border-gray-700">
        <div class="text-center text-gray-400 text-sm">
            Reset in <span class="font-bold text-yellow-400">4d 12h 34m</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Rank badge icons mapping
    const rankBadges = {
        'bronze': 'ü•â Bronze',
        'silver': 'ü•à Silver',
        'gold': 'ü•á Gold',
        'platinum': 'üí† Platinum',
        'diamond': 'üíé Diamond',
        'master': 'üëë Master',
        'grandmaster': 'üèÜ Grandmaster'
    };

    // Medal emojis for top 3
    const medalEmojis = {
        1: 'ü•á',
        2: 'ü•à',
        3: 'ü•â'
    };

    // Current sort option
    let currentSort = 'profit';

    // Load leaderboard from API
    async function loadLeaderboard(sortBy = 'profit') {
        try {
            currentSort = sortBy;
            const response = await fetch(`/api/leaderboard?limit=100&sort_by=${sortBy}`);
            if (!response.ok) {
                throw new Error('Failed to load leaderboard');
            }
            const leaderboard = await response.json();
            renderLeaderboard(leaderboard);
        } catch (error) {
            console.error('Error loading leaderboard:', error);
        }
    }

    // Render leaderboard entries
    function renderLeaderboard(leaderboard) {
        if (!leaderboard || leaderboard.length === 0) {
            document.getElementById('leaderboard-list').innerHTML = '<div class="text-center text-gray-400 py-8">No leaderboard data available</div>';
            return;
        }

        // Render top 3
        if (leaderboard.length >= 3) {
            renderTop3(leaderboard.slice(0, 3));
        }

        // Render rest of leaderboard (4+)
        const restOfLeaderboard = leaderboard.slice(3);
        const listHTML = restOfLeaderboard.map(entry => {
            const profitColor = entry.profit >= 0 ? 'text-yellow-400' : 'text-red-400';
            const profitPrefix = entry.profit >= 0 ? '+' : '';
            const rankBadge = rankBadges[entry.rank_badge] || 'ü•â Bronze';

            return `
                <div class="glass rounded-xl p-4 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="font-bold text-lg w-8">#${entry.rank}</div>
                        <div class="w-10 h-10 bg-gray-700 rounded-full"></div>
                        <div>
                            <div class="font-bold">${entry.username || entry.first_name || `Player #${entry.user_id}`}</div>
                            <div class="text-xs text-gray-400">${rankBadge}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold ${profitColor}">${profitPrefix}${window.formatNumber(entry.profit)}</div>
                        <div class="text-xs text-gray-400">PRED</div>
                        <div class="text-xs text-gray-400">${entry.win_rate}% wins</div>
                    </div>
                </div>
            `;
        }).join('');

        document.getElementById('leaderboard-list').innerHTML = listHTML;
    }

    // Render top 3 specially
    function renderTop3(top3) {
        if (top3.length < 3) return;

        // Order: 2nd, 1st, 3rd
        const orderedTop3 = [top3[1], top3[0], top3[2]];

        const html = orderedTop3.map((entry, index) => {
            const actualRank = entry.rank;
            const medal = medalEmojis[actualRank];
            const isFirst = actualRank === 1;
            const profitPrefix = entry.profit >= 0 ? '+' : '';
            const classes = isFirst
                ? 'glass rounded-2xl p-4 text-center border-2 border-yellow-400 card-shine transform scale-110'
                : 'glass rounded-2xl p-4 text-center';
            const nameClass = isFirst ? 'font-bold mb-1' : 'font-bold text-sm mb-1';
            const profitClass = isFirst ? 'text-yellow-400 font-bold text-lg' : 'text-yellow-400 font-bold';

            return `
                <div class="${classes}">
                    <div class="${isFirst ? 'text-4xl mb-2' : 'text-3xl mb-2'}">${medal}</div>
                    <div class="w-${isFirst ? '14' : '12'} h-${isFirst ? '14' : '12'} ${isFirst ? 'gold-gradient pulse-gold' : 'bg-gray-700'} rounded-full mx-auto mb-2"></div>
                    <div class="${nameClass}">${entry.username || entry.first_name || `Player${actualRank}`}</div>
                    <div class="${profitClass}">${profitPrefix}${window.formatNumber(entry.profit)}</div>
                    <div class="text-gray-400 text-xs">PRED</div>
                </div>
            `;
        }).join('');

        document.getElementById('top3-container').innerHTML = html;
    }

    // Load user's rank
    async function loadUserRank() {
        try {
            const response = await fetch('/api/leaderboard/rank');
            if (!response.ok) {
                throw new Error('Failed to load user rank');
            }
            const rankData = await response.json();
            renderUserRank(rankData);
        } catch (error) {
            console.error('Error loading user rank:', error);
        }
    }

    // Render user's rank card
    function renderUserRank(rankData) {
        if (!rankData.rank) {
            document.getElementById('user-rank-card').innerHTML = `
                <div class="glass rounded-2xl p-4 text-center">
                    <div class="text-gray-400">Place bets to appear on the leaderboard!</div>
                </div>
            `;
            return;
        }

        const profitPrefix = rankData.profit >= 0 ? '+' : '';
        const profitColor = rankData.profit >= 0 ? 'text-yellow-400' : 'text-red-400';

        const html = `
            <div class="glass rounded-2xl p-4 border-2 border-yellow-400">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="font-bold text-2xl text-yellow-400">#${rankData.rank}</div>
                        <div class="w-10 h-10 gold-gradient rounded-full"></div>
                        <div>
                            <div class="font-bold">You</div>
                            <div class="${profitColor} text-sm">${profitPrefix}${window.formatNumber(rankData.profit)} PRED</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-gray-400 text-xs">of ${rankData.total_players} players</div>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('user-rank-card').innerHTML = html;
    }

    // Sort button handlers
    function setupSortButtons() {
        const sortButtons = {
            'sort-profit': 'profit',
            'sort-winrate': 'win_rate',
            'sort-streak': 'win_streak',
            'sort-wins': 'total_wins'
        };

        Object.keys(sortButtons).forEach(buttonId => {
            const button = document.getElementById(buttonId);
            if (button) {
                button.addEventListener('click', () => {
                    // Update button styles
                    document.querySelectorAll('.sort-button').forEach(btn => {
                        btn.classList.remove('gold-gradient', 'text-black');
                        btn.classList.add('glass');
                    });
                    button.classList.remove('glass');
                    button.classList.add('gold-gradient', 'text-black');

                    // Load with new sort
                    loadLeaderboard(sortButtons[buttonId]);
                });
            }
        });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadLeaderboard();
        loadUserRank();
        setupSortButtons();
    });
</script>
{% endblock %}
