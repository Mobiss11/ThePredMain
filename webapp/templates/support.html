{% extends "base.html" %}

{% block title %}–ü–æ–¥–¥–µ—Ä–∂–∫–∞ - ThePred{% endblock %}

{% block content %}
<!-- Header -->
<div class="glass card-shine rounded-2xl p-6 mb-6">
    <h1 class="text-2xl font-bold mb-2">üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞</h1>
    <p class="text-gray-400">–°–æ–∑–¥–∞–π—Ç–µ —Ç–∏–∫–µ—Ç –∏ –º—ã –ø–æ–º–æ–∂–µ–º –≤–∞–º —Ä–µ—à–∏—Ç—å –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å</p>
</div>

<!-- View Toggle Buttons -->
<div class="flex space-x-3 mb-6">
    <button id="btn-tickets-list" class="flex-1 glass rounded-xl py-3 font-semibold transition-all duration-200 bg-yellow-500 bg-opacity-20 border-2 border-yellow-500">
        üìã –ú–æ–∏ —Ç–∏–∫–µ—Ç—ã
    </button>
    <button id="btn-create-ticket" class="flex-1 glass rounded-xl py-3 font-semibold transition-all duration-200">
        ‚ûï –ù–æ–≤—ã–π —Ç–∏–∫–µ—Ç
    </button>
</div>

<!-- Loading -->
<div id="loading" class="text-center py-8">
    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-400"></div>
    <p class="text-gray-400 mt-2">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>

<!-- Tickets List View -->
<div id="tickets-list-view" class="hidden">
    <div id="tickets-container" class="space-y-4">
        <!-- Tickets will be loaded here -->
    </div>

    <!-- Empty State -->
    <div id="tickets-empty" class="hidden text-center py-12">
        <div class="text-6xl mb-4">üì≠</div>
        <p class="text-gray-400 mb-6">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤</p>
        <button onclick="switchView('create')" class="glass rounded-xl px-6 py-3 font-semibold bg-yellow-500 bg-opacity-20 hover:bg-opacity-30 transition-all">
            –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π —Ç–∏–∫–µ—Ç
        </button>
    </div>
</div>

<!-- Create Ticket View -->
<div id="create-ticket-view" class="hidden">
    <form id="create-ticket-form" class="space-y-4">
        <!-- Priority -->
        <div>
            <label class="block text-sm font-medium mb-2">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
            <select name="priority" class="w-full glass rounded-xl px-4 py-3 bg-gray-800 bg-opacity-50 border-0 focus:ring-2 focus:ring-yellow-500">
                <option value="low">üü¢ –ù–∏–∑–∫–∏–π</option>
                <option value="medium" selected>üü° –°—Ä–µ–¥–Ω–∏–π</option>
                <option value="high">üü† –í—ã—Å–æ–∫–∏–π</option>
                <option value="urgent">üî¥ –°—Ä–æ—á–Ω—ã–π</option>
            </select>
        </div>

        <!-- Subject -->
        <div>
            <label class="block text-sm font-medium mb-2">–¢–µ–º–∞</label>
            <input type="text" name="subject" required maxlength="255"
                   class="w-full glass rounded-xl px-4 py-3 bg-gray-800 bg-opacity-50 border-0 focus:ring-2 focus:ring-yellow-500"
                   placeholder="–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É">
        </div>

        <!-- Message -->
        <div>
            <label class="block text-sm font-medium mb-2">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
            <textarea name="message" required rows="6"
                      class="w-full glass rounded-xl px-4 py-3 bg-gray-800 bg-opacity-50 border-0 focus:ring-2 focus:ring-yellow-500 resize-none"
                      placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ –≤–æ–ø—Ä–æ—Å"></textarea>
        </div>

        <!-- Photo Attachment -->
        <div>
            <label class="block text-sm font-medium mb-2">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <input type="file" name="attachment" accept="image/*"
                   class="w-full glass rounded-xl px-4 py-3 bg-gray-800 bg-opacity-50 border-0 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-500 file:bg-opacity-20 file:text-yellow-400 hover:file:bg-opacity-30">
        </div>

        <!-- Submit Button -->
        <button type="submit" id="submit-ticket-btn" class="w-full glass rounded-xl py-4 font-bold text-lg bg-yellow-500 bg-opacity-20 hover:bg-opacity-30 transition-all">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
        </button>
    </form>
</div>

<!-- Ticket Detail View -->
<div id="ticket-detail-view" class="hidden">
    <!-- Back Button -->
    <button onclick="switchView('list')" class="glass rounded-xl px-4 py-2 mb-4 text-sm flex items-center space-x-2">
        <span>‚Üê</span>
        <span>–ù–∞–∑–∞–¥ –∫ —Ç–∏–∫–µ—Ç–∞–º</span>
    </button>

    <!-- Ticket Info -->
    <div id="ticket-info" class="glass rounded-2xl p-6 mb-6">
        <!-- Will be populated dynamically -->
    </div>

    <!-- Messages -->
    <div id="messages-container" class="space-y-4 mb-6">
        <!-- Messages will be loaded here -->
    </div>

    <!-- Reply Form -->
    <div id="reply-form-container" class="hidden">
        <form id="reply-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-2">–í–∞—à –æ—Ç–≤–µ—Ç</label>
                <textarea name="message" required rows="4"
                          class="w-full glass rounded-xl px-4 py-3 bg-gray-800 bg-opacity-50 border-0 focus:ring-2 focus:ring-yellow-500 resize-none"
                          placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <input type="file" name="attachment" accept="image/*"
                       class="w-full glass rounded-xl px-4 py-3 bg-gray-800 bg-opacity-50 border-0 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-500 file:bg-opacity-20 file:text-yellow-400 hover:file:bg-opacity-30">
            </div>

            <button type="submit" id="submit-reply-btn" class="w-full glass rounded-xl py-3 font-semibold bg-yellow-500 bg-opacity-20 hover:bg-opacity-30 transition-all">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
        </form>

        <!-- Rate Limit Warning -->
        <div id="rate-limit-warning" class="hidden glass rounded-xl p-4 mt-4 bg-orange-500 bg-opacity-10 border border-orange-500">
            <p class="text-sm text-orange-400"></p>
        </div>
    </div>

    <!-- Ticket Closed Message -->
    <div id="ticket-closed-message" class="hidden glass rounded-xl p-4 bg-red-500 bg-opacity-10 border border-red-500 text-center">
        <p class="text-red-400">–≠—Ç–æ—Ç —Ç–∏–∫–µ—Ç –∑–∞–∫—Ä—ã—Ç. –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.</p>
    </div>
</div>

<script>
const userId = {{ user_id }};
let currentView = 'list';
let currentTicketId = null;
let tickets = [];

// View Management
function switchView(view) {
    currentView = view;

    // Update buttons
    document.getElementById('btn-tickets-list').classList.toggle('bg-yellow-500', view === 'list');
    document.getElementById('btn-tickets-list').classList.toggle('bg-opacity-20', view === 'list');
    document.getElementById('btn-tickets-list').classList.toggle('border-2', view === 'list');
    document.getElementById('btn-tickets-list').classList.toggle('border-yellow-500', view === 'list');

    document.getElementById('btn-create-ticket').classList.toggle('bg-yellow-500', view === 'create');
    document.getElementById('btn-create-ticket').classList.toggle('bg-opacity-20', view === 'create');
    document.getElementById('btn-create-ticket').classList.toggle('border-2', view === 'create');
    document.getElementById('btn-create-ticket').classList.toggle('border-yellow-500', view === 'create');

    // Hide all views
    document.getElementById('tickets-list-view').classList.add('hidden');
    document.getElementById('create-ticket-view').classList.add('hidden');
    document.getElementById('ticket-detail-view').classList.add('hidden');

    // Show selected view
    if (view === 'list') {
        document.getElementById('tickets-list-view').classList.remove('hidden');
        loadTickets();
    } else if (view === 'create') {
        document.getElementById('create-ticket-view').classList.remove('hidden');
    } else if (view === 'detail') {
        document.getElementById('ticket-detail-view').classList.remove('hidden');
    }
}

// Load Tickets
async function loadTickets() {
    try {
        const response = await fetch(`/api/support/tickets/${userId}`);
        tickets = await response.json();

        document.getElementById('loading').classList.add('hidden');

        if (tickets.length === 0) {
            document.getElementById('tickets-empty').classList.remove('hidden');
            document.getElementById('tickets-container').classList.add('hidden');
        } else {
            document.getElementById('tickets-empty').classList.add('hidden');
            document.getElementById('tickets-container').classList.remove('hidden');
            renderTickets();
        }
    } catch (error) {
        console.error('Error loading tickets:', error);
        document.getElementById('loading').innerHTML = '<p class="text-red-400">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–∫–µ—Ç–æ–≤</p>';
    }
}

// Render Tickets
function renderTickets() {
    const container = document.getElementById('tickets-container');

    const priorityColors = {
        'low': 'green',
        'medium': 'yellow',
        'high': 'orange',
        'urgent': 'red'
    };

    const priorityEmojis = {
        'low': 'üü¢',
        'medium': 'üü°',
        'high': 'üü†',
        'urgent': 'üî¥'
    };

    const statusNames = {
        'open': '–û—Ç–∫—Ä—ã—Ç',
        'in_progress': '–í —Ä–∞–±–æ—Ç–µ',
        'waiting_user': '–ñ–¥—ë—Ç –æ—Ç–≤–µ—Ç–∞',
        'closed': '–ó–∞–∫—Ä—ã—Ç'
    };

    const statusColors = {
        'open': 'blue',
        'in_progress': 'purple',
        'waiting_user': 'yellow',
        'closed': 'gray'
    };

    container.innerHTML = tickets.map(ticket => {
        const priorityColor = priorityColors[ticket.priority] || 'gray';
        const statusColor = statusColors[ticket.status] || 'gray';
        const date = new Date(ticket.created_at).toLocaleString('ru-RU');

        return `
            <div onclick="openTicket(${ticket.id})" class="glass rounded-xl p-4 cursor-pointer hover:bg-opacity-20 transition-all">
                <!-- Status and Priority at top -->
                <div class="flex items-center space-x-2 mb-3">
                    <span class="text-xs px-2 py-1 rounded-full bg-${statusColor}-500 bg-opacity-20 text-${statusColor}-400">
                        ${statusNames[ticket.status]}
                    </span>
                    <span class="text-xs px-2 py-1 rounded-full bg-${priorityColor}-500 bg-opacity-20 text-${priorityColor}-400">
                        ${priorityEmojis[ticket.priority]} ${ticket.priority.toUpperCase()}
                    </span>
                </div>

                <!-- Title -->
                <h3 class="font-bold text-lg mb-2">${ticket.subject}</h3>

                <!-- Date and admin replied -->
                <div class="flex items-center space-x-3 text-sm text-gray-400 mb-2">
                    <span>${date}</span>
                    ${ticket.admin_replied ? '<span class="text-green-400">‚úì –ê–¥–º–∏–Ω –æ—Ç–≤–µ—Ç–∏–ª</span>' : '<span class="text-orange-400">‚ö† –ñ–¥—ë—Ç –æ—Ç–≤–µ—Ç–∞</span>'}
                </div>

                <!-- Last message -->
                ${ticket.last_message ? `
                    <p class="text-sm text-gray-400 truncate">
                        ${ticket.last_message}
                    </p>
                ` : ''}
            </div>
        `;
    }).join('');
}

// Open Ticket Detail
async function openTicket(ticketId) {
    currentTicketId = ticketId;
    switchView('detail');

    const ticket = tickets.find(t => t.id === ticketId);

    // Render ticket info
    const priorityEmojis = {
        'low': 'üü¢',
        'medium': 'üü°',
        'high': 'üü†',
        'urgent': 'üî¥'
    };

    const statusNames = {
        'open': '–û—Ç–∫—Ä—ã—Ç',
        'in_progress': '–í —Ä–∞–±–æ—Ç–µ',
        'waiting_user': '–ñ–¥—ë—Ç –≤–∞—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞',
        'closed': '–ó–∞–∫—Ä—ã—Ç'
    };

    document.getElementById('ticket-info').innerHTML = `
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold">${ticket.subject}</h2>
            <span class="text-xs px-3 py-1 rounded-full bg-yellow-500 bg-opacity-20 text-yellow-400">
                ${priorityEmojis[ticket.priority]} ${ticket.priority.toUpperCase()}
            </span>
        </div>
        <div class="text-sm text-gray-400 space-y-1">
            <p>–°—Ç–∞—Ç—É—Å: <span class="text-white">${statusNames[ticket.status]}</span></p>
            <p>–°–æ–∑–¥–∞–Ω: ${new Date(ticket.created_at).toLocaleString('ru-RU')}</p>
        </div>
    `;

    // Load messages
    await loadMessages(ticketId);

    // Show/hide reply form based on ticket status
    if (ticket.status === 'closed') {
        document.getElementById('reply-form-container').classList.add('hidden');
        document.getElementById('ticket-closed-message').classList.remove('hidden');
    } else {
        document.getElementById('reply-form-container').classList.remove('hidden');
        document.getElementById('ticket-closed-message').classList.add('hidden');
    }
}

// Load Messages
async function loadMessages(ticketId) {
    try {
        const response = await fetch(`/api/support/tickets/${ticketId}/messages`);
        const messages = await response.json();

        const container = document.getElementById('messages-container');
        container.innerHTML = messages.map(msg => {
            const date = new Date(msg.created_at).toLocaleString('ru-RU');

            if (msg.is_admin) {
                // Admin message
                return `
                    <div class="glass rounded-xl p-4 border-l-4 border-yellow-500">
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="text-yellow-400 font-semibold">üëë –ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
                            <span class="text-xs text-gray-400">${date}</span>
                        </div>
                        <p class="text-sm whitespace-pre-wrap">${msg.message}</p>
                        ${msg.attachment_url ? `
                            <img src="${msg.attachment_url}" class="mt-3 rounded-xl max-w-full h-auto" />
                        ` : ''}
                    </div>
                `;
            } else {
                // User message
                return `
                    <div class="glass rounded-xl p-4 border-l-4 border-blue-500">
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="text-blue-400 font-semibold">${msg.user_name || '–í—ã'}</span>
                            <span class="text-xs text-gray-400">${date}</span>
                        </div>
                        <p class="text-sm whitespace-pre-wrap">${msg.message}</p>
                        ${msg.attachment_url ? `
                            <img src="${msg.attachment_url}" class="mt-3 rounded-xl max-w-full h-auto" />
                        ` : ''}
                    </div>
                `;
            }
        }).join('');
    } catch (error) {
        console.error('Error loading messages:', error);
    }
}

// Create Ticket
document.getElementById('create-ticket-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const btn = document.getElementById('submit-ticket-btn');
    btn.disabled = true;
    btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

    try {
        const formData = new FormData(e.target);

        const response = await fetch('/api/support/tickets', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (response.ok) {
            // Reset form
            e.target.reset();

            // Switch to tickets list
            switchView('list');

            // Show success message
            alert('–¢–∏–∫–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω! –ú—ã —Å–∫–æ—Ä–æ –æ—Ç–≤–µ—Ç–∏–º –≤–∞–º.');
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç'));
        }
    } catch (error) {
        console.error('Error creating ticket:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–∏–∫–µ—Ç–∞');
    } finally {
        btn.disabled = false;
        btn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
    }
});

// Send Reply
document.getElementById('reply-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const btn = document.getElementById('submit-reply-btn');
    btn.disabled = true;
    btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

    try {
        const formData = new FormData(e.target);

        const response = await fetch(`/api/support/tickets/${currentTicketId}/messages`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (response.ok) {
            // Reset form
            e.target.reset();

            // Reload messages
            await loadMessages(currentTicketId);

            // Hide rate limit warning
            document.getElementById('rate-limit-warning').classList.add('hidden');
        } else {
            if (response.status === 429) {
                // Show rate limit warning
                const warning = document.getElementById('rate-limit-warning');
                warning.querySelector('p').textContent = result.detail || '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è';
                warning.classList.remove('hidden');
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (result.detail || result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ'));
            }
        }
    } catch (error) {
        console.error('Error sending message:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
    } finally {
        btn.disabled = false;
        btn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
    }
});

// Event Listeners
document.getElementById('btn-tickets-list').addEventListener('click', () => switchView('list'));
document.getElementById('btn-create-ticket').addEventListener('click', () => switchView('create'));

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    switchView('list'); // This will show list view and load tickets automatically
});
</script>

<style>
/* Smooth transitions */
* {
    transition: all 0.2s ease;
}

/* File input custom styling */
input[type="file"]::file-selector-button {
    cursor: pointer;
}
</style>

{% endblock %}
