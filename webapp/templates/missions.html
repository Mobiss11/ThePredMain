{% extends "base.html" %}

{% block title %}Missions - ThePred{% endblock %}

{% block content %}
<!-- Header -->
<div class="glass card-shine rounded-2xl p-6 mb-6">
    <h1 class="text-2xl font-bold mb-2">ğŸ¯ Daily Missions</h1>
    <p class="text-gray-400">Complete tasks and earn PRED rewards!</p>
    <div class="mt-4 glass rounded-xl p-4">
        <div class="flex items-center justify-between">
            <span class="text-sm text-gray-400">Daily Reset In</span>
            <span class="font-bold text-yellow-400">12:34:56</span>
        </div>
    </div>
</div>

<!-- Daily Missions -->
<div class="space-y-4 mb-6">
    <div class="glass rounded-2xl p-5 border-2 border-yellow-400">
        <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="text-2xl">ğŸ¯</span>
                    <h3 class="text-lg font-bold">Make 3 Bets</h3>
                </div>
                <p class="text-gray-400 text-sm">Place at least 3 bets today</p>
            </div>
            <div class="text-right">
                <div class="font-bold text-yellow-400">+500</div>
                <div class="text-xs text-gray-400">PRED</div>
            </div>
        </div>

        <div class="mb-3">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-400">Progress</span>
                <span class="text-sm font-bold">2 / 3</span>
            </div>
            <div class="w-full bg-gray-800 rounded-full h-2">
                <div class="gold-gradient h-2 rounded-full" style="width: 66%"></div>
            </div>
        </div>

        <button class="w-full glass rounded-xl py-3 font-bold opacity-50 cursor-not-allowed">
            1 more bet needed
        </button>
    </div>

    <div class="glass rounded-2xl p-5">
        <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="text-2xl">ğŸ†</span>
                    <h3 class="text-lg font-bold">Win a Bet</h3>
                </div>
                <p class="text-gray-400 text-sm">Win at least 1 bet today</p>
            </div>
            <div class="text-right">
                <div class="font-bold text-yellow-400">+1,000</div>
                <div class="text-xs text-gray-400">PRED</div>
            </div>
        </div>

        <div class="mb-3">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-400">Progress</span>
                <span class="text-sm font-bold text-green-400">1 / 1 âœ“</span>
            </div>
            <div class="w-full bg-gray-800 rounded-full h-2">
                <div class="green-gradient h-2 rounded-full" style="width: 100%"></div>
            </div>
        </div>

        <button class="w-full gold-gradient rounded-xl py-3 font-bold text-black hover:opacity-90">
            Claim Reward
        </button>
    </div>

    <div class="glass rounded-2xl p-5">
        <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="text-2xl">ğŸ‘¥</span>
                    <h3 class="text-lg font-bold">Invite a Friend</h3>
                </div>
                <p class="text-gray-400 text-sm">Invite 1 friend to ThePred</p>
            </div>
            <div class="text-right">
                <div class="font-bold text-yellow-400">+1,000</div>
                <div class="text-xs text-gray-400">PRED</div>
            </div>
        </div>

        <div class="mb-3">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-400">Progress</span>
                <span class="text-sm font-bold">0 / 1</span>
            </div>
            <div class="w-full bg-gray-800 rounded-full h-2">
                <div class="gold-gradient h-2 rounded-full" style="width: 0%"></div>
            </div>
        </div>

        <button class="w-full glass rounded-xl py-3 font-bold hover:bg-opacity-20">
            Share Referral Link
        </button>
    </div>
</div>

<!-- Weekly Missions -->
<div class="glass rounded-2xl p-6 mb-6">
    <h2 class="text-xl font-bold mb-4">ğŸ“… Weekly Challenges</h2>

    <div class="space-y-4">
        <div class="glass rounded-xl p-4">
            <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="text-xl">ğŸ”¥</span>
                        <h4 class="font-bold">10 Win Streak</h4>
                    </div>
                    <p class="text-gray-400 text-xs">Win 10 bets in a row</p>
                </div>
                <div class="text-right">
                    <div class="font-bold text-yellow-400">+5,000</div>
                    <div class="text-xs text-gray-400">PRED</div>
                </div>
            </div>
            <div class="flex items-center justify-between text-xs">
                <span class="text-gray-400">Current: 7 wins</span>
                <span class="font-bold">70%</span>
            </div>
        </div>

        <div class="glass rounded-xl p-4">
            <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="text-xl">ğŸ’°</span>
                        <h4 class="font-bold">Top 10 Profit</h4>
                    </div>
                    <p class="text-gray-400 text-xs">Be in top 10 by weekly profit</p>
                </div>
                <div class="text-right">
                    <div class="font-bold text-yellow-400">+1,000</div>
                    <div class="text-xs text-gray-400">PRED</div>
                </div>
            </div>
            <div class="flex items-center justify-between text-xs">
                <span class="text-gray-400">Current rank: #23</span>
                <span class="text-red-400">Not in top 10</span>
            </div>
        </div>

        <div class="glass rounded-xl p-4">
            <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="text-xl">ğŸ“Š</span>
                        <h4 class="font-bold">Market Creator</h4>
                    </div>
                    <p class="text-gray-400 text-xs">Create a market with 100+ bets</p>
                </div>
                <div class="text-right">
                    <div class="font-bold text-yellow-400">+5,000</div>
                    <div class="text-xs text-gray-400">PRED</div>
                </div>
            </div>
            <div class="flex items-center justify-between text-xs">
                <span class="text-gray-400">Create your first market</span>
                <span>0%</span>
            </div>
        </div>
    </div>
</div>

<!-- Special Achievements -->
<div class="glass rounded-2xl p-6">
    <h2 class="text-xl font-bold mb-4">ğŸ… Special Achievements</h2>

    <div class="grid grid-cols-2 gap-3">
        <div class="glass rounded-xl p-4 text-center border-2 border-yellow-400">
            <div class="text-3xl mb-2">ğŸ¯</div>
            <div class="font-bold text-sm mb-1">First Bet</div>
            <div class="text-xs text-green-400">Completed</div>
        </div>

        <div class="glass rounded-xl p-4 text-center border-2 border-yellow-400">
            <div class="text-3xl mb-2">ğŸ†</div>
            <div class="font-bold text-sm mb-1">First Win</div>
            <div class="text-xs text-green-400">Completed</div>
        </div>

        <div class="glass rounded-xl p-4 text-center opacity-50">
            <div class="text-3xl mb-2">ğŸ’¯</div>
            <div class="font-bold text-sm mb-1">100 Bets</div>
            <div class="text-xs text-gray-400">Locked</div>
        </div>

        <div class="glass rounded-xl p-4 text-center opacity-50">
            <div class="text-3xl mb-2">ğŸ’</div>
            <div class="font-bold text-sm mb-1">Diamond Rank</div>
            <div class="text-xs text-gray-400">Locked</div>
        </div>

        <div class="glass rounded-xl p-4 text-center opacity-50">
            <div class="text-3xl mb-2">ğŸ”¥</div>
            <div class="font-bold text-sm mb-1">15 Streak</div>
            <div class="text-xs text-gray-400">Locked</div>
        </div>

        <div class="glass rounded-xl p-4 text-center opacity-50">
            <div class="text-3xl mb-2">ğŸ‘‘</div>
            <div class="font-bold text-sm mb-1">Top 1</div>
            <div class="text-xs text-gray-400">Locked</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Mission icons mapping
const missionIcons = {
    'First Bet': 'ğŸ¯',
    '3 Bets Today': 'ğŸ¯',
    'First Win': 'ğŸ†',
    'Invite a Friend': 'ğŸ‘¥',
    '10 Win Streak': 'ğŸ”¥'
};

// Load missions from API
async function loadMissions() {
    try {
        const response = await fetch('/api/missions');
        if (response.ok) {
            const missions = await response.json();
            renderMissions(missions);
        }
    } catch (error) {
        console.error('Failed to load missions:', error);
    }
}

// Render missions
function renderMissions(missions) {
    const dailyContainer = document.querySelector('.space-y-4.mb-6');

    // Filter missions by type
    const dailyMissions = missions.filter(m => m.type === 'daily' || m.type === 'achievement');

    dailyContainer.innerHTML = dailyMissions.map(mission => {
        const icon = missionIcons[mission.title] || 'â­';
        const progress = mission.progress || 0;
        const required = Object.values(mission.requirements)[0] || 1;
        const progressPercent = Math.min((progress / required) * 100, 100);
        const isCompleted = mission.completed && !mission.claimed;
        const isClaimed = mission.claimed;

        return `
            <div class="glass rounded-2xl p-5 ${isCompleted ? 'border-2 border-yellow-400' : ''}">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="text-2xl">${icon}</span>
                            <h3 class="text-lg font-bold">${mission.title}</h3>
                        </div>
                        <p class="text-gray-400 text-sm">${mission.description}</p>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-yellow-400">+${mission.reward_amount}</div>
                        <div class="text-xs text-gray-400">${mission.reward_currency}</div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm text-gray-400">Progress</span>
                        <span class="text-sm font-bold ${isCompleted ? 'text-green-400' : ''}">${progress} / ${required} ${isCompleted ? 'âœ“' : ''}</span>
                    </div>
                    <div class="w-full bg-gray-800 rounded-full h-2">
                        <div class="${isCompleted ? 'green-gradient' : 'gold-gradient'} h-2 rounded-full" style="width: ${progressPercent}%"></div>
                    </div>
                </div>

                ${isClaimed
                    ? '<button class="w-full glass rounded-xl py-3 font-bold opacity-50 cursor-not-allowed">Already Claimed</button>'
                    : isCompleted
                    ? `<button onclick="claimMission(${mission.id})" class="w-full gold-gradient rounded-xl py-3 font-bold text-black hover:opacity-90">Claim Reward</button>`
                    : `<button class="w-full glass rounded-xl py-3 font-bold opacity-50 cursor-not-allowed">${required - progress} more needed</button>`
                }
            </div>
        `;
    }).join('');
}

// Claim mission reward
async function claimMission(missionId) {
    try {
        window.tgHaptic?.light();

        const response = await fetch('/api/missions/claim', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                mission_id: missionId
            })
        });

        if (response.ok) {
            const result = await response.json();
            window.tgHaptic?.success();
            window.showTgAlert(`Reward claimed! +${result.reward.amount} ${result.reward.currency}`);

            // Reload missions and balance
            await loadMissions();
            await window.loadUserBalance();
        } else {
            const error = await response.json();
            window.tgHaptic?.error();
            window.showTgAlert(error.error || error.detail || 'Failed to claim reward');
        }
    } catch (error) {
        console.error('Claim error:', error);
        window.tgHaptic?.error();
        window.showTgAlert('Network error. Please try again.');
    }
}

// Load missions on page load
document.addEventListener('DOMContentLoaded', () => {
    loadMissions();
});
</script>
{% endblock %}
