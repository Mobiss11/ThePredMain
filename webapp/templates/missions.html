{% extends "base.html" %}

{% block title %}–ú–∏—Å—Å–∏–∏ - ThePred{% endblock %}

{% block content %}
<!-- Header -->
<div class="glass card-shine rounded-2xl p-6 mb-6">
    <h1 class="text-2xl font-bold mb-2">üéØ –ú–∏—Å—Å–∏–∏ –∏ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h1>
    <p class="text-gray-400">–í—ã–ø–æ–ª–Ω—è–π –∑–∞–¥–∞–Ω–∏—è –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –Ω–∞–≥—Ä–∞–¥—ã!</p>
</div>

<!-- Loading -->
<div id="loading" class="text-center py-8">
    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-400"></div>
    <p class="text-gray-400 mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∏—Å—Å–∏–π...</p>
</div>

<!-- Missions Sections -->
<div id="missions-sections" class="space-y-8 hidden">
    <!-- Daily Missions Section -->
    <div id="daily-section" class="hidden">
        <div class="glass rounded-2xl p-6 mb-6 border-l-4 border-yellow-500" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(17, 24, 39, 0.5) 100%);">
            <div class="flex items-center">
                <div class="w-14 h-14 rounded-xl bg-yellow-500 bg-opacity-20 flex items-center justify-center mr-4">
                    <span class="text-3xl">üìÖ</span>
                </div>
                <div class="flex-1">
                    <h2 class="text-2xl font-bold mb-1 bg-gradient-to-r from-yellow-400 to-yellow-600 bg-clip-text text-transparent">
                        –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ó–∞–¥–∞–Ω–∏—è
                    </h2>
                    <p class="text-gray-400 text-sm">–û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00 UTC</p>
                </div>
            </div>
        </div>
        <div id="daily-missions" class="space-y-4">
            <!-- Daily missions will be loaded here -->
        </div>
    </div>

    <!-- Weekly Missions Section -->
    <div id="weekly-section" class="hidden">
        <div class="glass rounded-2xl p-6 mb-6 border-l-4 border-purple-500" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(17, 24, 39, 0.5) 100%);">
            <div class="flex items-center">
                <div class="w-14 h-14 rounded-xl bg-purple-500 bg-opacity-20 flex items-center justify-center mr-4">
                    <span class="text-3xl">üìä</span>
                </div>
                <div class="flex-1">
                    <h2 class="text-2xl font-bold mb-1 bg-gradient-to-r from-purple-400 to-purple-600 bg-clip-text text-transparent">
                        –ù–µ–¥–µ–ª—å–Ω—ã–µ –ó–∞–¥–∞–Ω–∏—è
                    </h2>
                    <p class="text-gray-400 text-sm">–û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 00:00 UTC</p>
                </div>
            </div>
        </div>
        <div id="weekly-missions" class="space-y-4">
            <!-- Weekly missions will be loaded here -->
        </div>
    </div>

    <!-- Achievements Section -->
    <div id="achievement-section" class="hidden">
        <div class="glass rounded-2xl p-6 mb-6 border-l-4 border-green-500" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(17, 24, 39, 0.5) 100%);">
            <div class="flex items-center">
                <div class="w-14 h-14 rounded-xl bg-green-500 bg-opacity-20 flex items-center justify-center mr-4">
                    <span class="text-3xl">üèÜ</span>
                </div>
                <div class="flex-1">
                    <h2 class="text-2xl font-bold mb-1 bg-gradient-to-r from-green-400 to-green-600 bg-clip-text text-transparent">
                        –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
                    </h2>
                    <p class="text-gray-400 text-sm">–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∑–∞ –∏–≥—Ä–æ–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å</p>
                </div>
            </div>
        </div>
        <div id="achievement-missions" class="space-y-4">
            <!-- Achievement missions will be loaded here -->
        </div>
    </div>
</div>

<!-- Empty State -->
<div id="empty-state" class="hidden text-center py-12">
    <div class="text-6xl mb-4">üéØ</div>
    <h3 class="text-xl font-bold mb-2">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∏—Å—Å–∏–π</h3>
    <p class="text-gray-400">–°–∫–æ—Ä–æ –ø–æ—è–≤—è—Ç—Å—è –Ω–æ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è!</p>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
let allMissions = [];
const userId = {{ user_id }};
const S3_BASE_URL = 'https://thepred.store/thepred-events/missions';

// Load missions
async function loadMissions() {
    try {
        const response = await fetch(`/api/missions/${userId}`);
        if (!response.ok) throw new Error('Failed to load missions');

        allMissions = await response.json();

        document.getElementById('loading').classList.add('hidden');
        renderMissions();
    } catch (error) {
        console.error('Error loading missions:', error);
        document.getElementById('loading').innerHTML = `
            <div class="text-red-400">
                <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∏—Å—Å–∏–π</p>
                <button onclick="loadMissions()" class="mt-4 px-4 py-2 bg-yellow-600 text-black rounded-lg font-bold">
                    –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                </button>
            </div>
        `;
    }
}

// Render missions by sections
function renderMissions() {
    const dailyMissions = allMissions.filter(m => m.type === 'daily');
    const weeklyMissions = allMissions.filter(m => m.type === 'weekly');
    const achievementMissions = allMissions.filter(m => m.type === 'achievement');

    const sectionsContainer = document.getElementById('missions-sections');
    const emptyState = document.getElementById('empty-state');

    if (allMissions.length === 0) {
        sectionsContainer.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
    }

    sectionsContainer.classList.remove('hidden');
    emptyState.classList.add('hidden');

    // Render daily missions
    if (dailyMissions.length > 0) {
        document.getElementById('daily-section').classList.remove('hidden');
        document.getElementById('daily-missions').innerHTML = dailyMissions.map(m => renderMissionCard(m)).join('');
    } else {
        document.getElementById('daily-section').classList.add('hidden');
    }

    // Render weekly missions
    if (weeklyMissions.length > 0) {
        document.getElementById('weekly-section').classList.remove('hidden');
        document.getElementById('weekly-missions').innerHTML = weeklyMissions.map(m => renderMissionCard(m)).join('');
    } else {
        document.getElementById('weekly-section').classList.add('hidden');
    }

    // Render achievement missions
    if (achievementMissions.length > 0) {
        document.getElementById('achievement-section').classList.remove('hidden');
        document.getElementById('achievement-missions').innerHTML = achievementMissions.map(m => renderMissionCard(m)).join('');
    } else {
        document.getElementById('achievement-section').classList.add('hidden');
    }
}

// Render single mission card
function renderMissionCard(mission) {
    const progress = mission.progress || 0;
    const target = mission.target || 1;
    const percentage = Math.min((progress / target) * 100, 100);
    const completed = mission.completed;
    const claimed = mission.claimed;

    // Get icon - check if it's custom URL, S3 icon name, or emoji
    let icon;
    if (mission.custom_icon_url) {
        // Custom URL provided
        icon = `<img src="${mission.custom_icon_url}" class="w-12 h-12 object-contain" alt="icon" />`;
    } else if (mission.icon) {
        // Check if it's an emoji (single character or contains emoji unicode)
        const isEmoji = /(\p{Emoji_Presentation}|\p{Extended_Pictographic})/u.test(mission.icon) || mission.icon.length <= 2;
        if (isEmoji) {
            // It's an emoji
            icon = `<span class="text-3xl">${mission.icon}</span>`;
        } else {
            // It's an S3 icon name
            const iconUrl = `${S3_BASE_URL}/${mission.icon}.svg`;
            icon = `<img src="${iconUrl}" class="w-12 h-12 object-contain" alt="${mission.icon}" />`;
        }
    } else {
        // Default icon
        icon = `<span class="text-3xl">üéØ</span>`;
    }

    // Get currency emoji
    const currencyEmoji = mission.reward_currency === 'TON' ? 'üíé' : 'üí∞';
    const currencyColor = mission.reward_currency === 'TON' ? 'text-blue-400' : 'text-yellow-400';

    // Border color based on status
    const borderClass = completed && !claimed ? 'border-2 border-yellow-400' : '';

    // Button
    let button = '';
    if (claimed) {
        button = `
            <button class="w-full glass rounded-xl py-3 font-bold text-gray-400 cursor-not-allowed" disabled>
                ‚úì –ü–æ–ª—É—á–µ–Ω–æ
            </button>
        `;
    } else if (completed) {
        button = `
            <button onclick="claimReward(${mission.id})" class="w-full gold-gradient rounded-xl py-3 font-bold text-black hover:opacity-90">
                üéÅ –ó–∞–±—Ä–∞—Ç—å –ù–∞–≥—Ä–∞–¥—É
            </button>
        `;
    } else if (mission.type === 'subscription') {
        button = `
            <button onclick="openChannel('${mission.channel_url}', ${mission.id})" class="w-full bg-blue-600 rounded-xl py-3 font-bold hover:bg-blue-700">
                üì¢ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è
            </button>
        `;
    } else {
        button = `
            <button class="w-full glass rounded-xl py-3 font-bold opacity-50 cursor-not-allowed" disabled>
                –ï—â—ë ${target - progress} ${getRequirementText(mission.requirements)}
            </button>
        `;
    }

    return `
        <div class="glass rounded-2xl p-5 ${borderClass}">
            <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-2">
                        ${icon}
                        <h3 class="text-lg font-bold">${mission.title}</h3>
                    </div>
                    <p class="text-gray-400 text-sm">${mission.description || ''}</p>
                </div>
                <div class="text-right ml-4">
                    <div class="font-bold ${currencyColor}">${currencyEmoji} +${window.formatNumber(mission.reward_amount)}</div>
                    <div class="text-xs text-gray-400">${mission.reward_currency}</div>
                </div>
            </div>

            <div class="mb-3">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-400">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                    <span class="text-sm font-bold ${completed ? 'text-green-400' : ''}">${progress} / ${target} ${completed ? '‚úì' : ''}</span>
                </div>
                <div class="w-full bg-gray-800 rounded-full h-2">
                    <div class="${completed ? 'green-gradient' : 'gold-gradient'} h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                </div>
            </div>

            ${button}
        </div>
    `;
}

// Get requirement text
function getRequirementText(requirements) {
    if (requirements.bets_count !== undefined) return '—Å—Ç–∞–≤–æ–∫';
    if (requirements.wins_count !== undefined) return '–ø–æ–±–µ–¥';
    if (requirements.win_streak !== undefined) return '–ø–æ–¥—Ä—è–¥';
    if (requirements.daily_bets !== undefined) return '—Å—Ç–∞–≤–æ–∫';
    if (requirements.weekly_bets !== undefined) return '—Å—Ç–∞–≤–æ–∫';
    if (requirements.category_bets !== undefined) return '—Å—Ç–∞–≤–æ–∫';
    if (requirements.referrals_count !== undefined) return '—Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤';
    if (requirements.subscription !== undefined) return '';
    return '';
}

// Claim reward
async function claimReward(missionId) {
    try {
        const response = await fetch(`/api/missions/claim/${userId}/${missionId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to claim reward');
        }

        const result = await response.json();

        // Show success message
        showToast(`–ü–æ–ª—É—á–µ–Ω–æ: ${result.reward.amount} ${result.reward.currency}! üéâ`, 'success');

        // Reload missions
        await loadMissions();

        // Update balance in header if exists
        if (window.updateBalance) {
            window.updateBalance(result.new_balance);
        }

    } catch (error) {
        console.error('Error claiming reward:', error);
        showToast(error.message || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥—ã', 'error');
    }
}

// Open channel (subscription mission)
async function openChannel(channelUrl, missionId) {
    // Open channel in new window
    window.open(channelUrl, '_blank');

    // Wait a bit, then check subscription
    setTimeout(async () => {
        try {
            const response = await fetch(`/api/missions/check-subscription/${userId}/${missionId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            });

            if (response.ok) {
                const result = await response.json();
                if (result.completed) {
                    showToast('–ú–∏—Å—Å–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! üéâ', 'success');
                    await loadMissions();
                } else {
                    showToast('–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª, —á—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏—Å—Å–∏—é', 'info');
                }
            }
        } catch (error) {
            console.error('Error checking subscription:', error);
        }
    }, 2000);
}

// Toast notification
function showToast(message, type = 'info') {
    // Create toast if it doesn't exist
    let toast = document.getElementById('toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.className = 'fixed top-4 right-4 z-50 max-w-sm';
        document.body.appendChild(toast);
    }

    const colors = {
        success: 'bg-green-600',
        error: 'bg-red-600',
        info: 'bg-blue-600'
    };

    const toastEl = document.createElement('div');
    toastEl.className = `${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg mb-2 transform transition-all`;
    toastEl.textContent = message;

    toast.appendChild(toastEl);

    // Remove after 3 seconds
    setTimeout(() => {
        toastEl.style.opacity = '0';
        setTimeout(() => toastEl.remove(), 300);
    }, 3000);
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadMissions();

    // Refresh missions every 30 seconds
    setInterval(loadMissions, 30000);
});
</script>
{% endblock %}
