{% extends "base.html" %}

{% block title %}–ú–∏—Å—Å–∏–∏ - ThePred{% endblock %}

{% block content %}
<!-- Header -->
<div class="glass card-shine rounded-2xl p-6 mb-6">
    <h1 class="text-2xl font-bold mb-2">üéØ –ú–∏—Å—Å–∏–∏ –∏ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h1>
    <p class="text-gray-400">–í—ã–ø–æ–ª–Ω—è–π –∑–∞–¥–∞–Ω–∏—è –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –Ω–∞–≥—Ä–∞–¥—ã!</p>
</div>

<!-- Tabs -->
<div class="flex space-x-2 mb-6 overflow-x-auto">
    <button onclick="switchTab('daily')" id="tab-daily" class="tab-button px-6 py-2 rounded-lg bg-yellow-600 text-black font-bold whitespace-nowrap">
        üìÖ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ
    </button>
    <button onclick="switchTab('weekly')" id="tab-weekly" class="tab-button px-6 py-2 rounded-lg glass font-bold whitespace-nowrap">
        üìä –ù–µ–¥–µ–ª—å–Ω—ã–µ
    </button>
    <button onclick="switchTab('achievement')" id="tab-achievement" class="tab-button px-6 py-2 rounded-lg glass font-bold whitespace-nowrap">
        üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    </button>
</div>

<!-- Loading -->
<div id="loading" class="text-center py-8">
    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-400"></div>
    <p class="text-gray-400 mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∏—Å—Å–∏–π...</p>
</div>

<!-- Missions Container -->
<div id="missions-container" class="space-y-4 hidden">
    <!-- Missions will be loaded here -->
</div>

<!-- Empty State -->
<div id="empty-state" class="hidden text-center py-12">
    <div class="text-6xl mb-4">üéØ</div>
    <h3 class="text-xl font-bold mb-2">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∏—Å—Å–∏–π</h3>
    <p class="text-gray-400">–°–∫–æ—Ä–æ –ø–æ—è–≤—è—Ç—Å—è –Ω–æ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è!</p>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
let currentTab = 'daily';
let allMissions = [];
const userId = {{ user_id }};

// Switch tab
function switchTab(tab) {
    currentTab = tab;

    // Update tab styles
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('bg-yellow-600', 'text-black');
        btn.classList.add('glass');
    });
    document.getElementById(`tab-${tab}`).classList.remove('glass');
    document.getElementById(`tab-${tab}`).classList.add('bg-yellow-600', 'text-black');

    // Filter and render missions
    renderMissions();
}

// Load missions
async function loadMissions() {
    try {
        const response = await fetch(`/api/missions/${userId}`);
        if (!response.ok) throw new Error('Failed to load missions');

        allMissions = await response.json();

        document.getElementById('loading').classList.add('hidden');
        renderMissions();
    } catch (error) {
        console.error('Error loading missions:', error);
        document.getElementById('loading').innerHTML = `
            <div class="text-red-400">
                <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∏—Å—Å–∏–π</p>
                <button onclick="loadMissions()" class="mt-4 px-4 py-2 bg-yellow-600 text-black rounded-lg font-bold">
                    –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                </button>
            </div>
        `;
    }
}

// Render missions
function renderMissions() {
    const filtered = allMissions.filter(m => m.type === currentTab);
    const container = document.getElementById('missions-container');
    const emptyState = document.getElementById('empty-state');

    if (filtered.length === 0) {
        container.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
    }

    container.classList.remove('hidden');
    emptyState.classList.add('hidden');

    container.innerHTML = filtered.map(mission => renderMissionCard(mission)).join('');
}

// Render single mission card
function renderMissionCard(mission) {
    const progress = mission.progress || 0;
    const target = mission.target || 1;
    const percentage = Math.min((progress / target) * 100, 100);
    const completed = mission.completed;
    const claimed = mission.claimed;

    // Get icon
    const icon = mission.custom_icon_url
        ? `<img src="${mission.custom_icon_url}" class="w-8 h-8 object-contain" />`
        : `<span class="text-2xl">${mission.icon || 'üéØ'}</span>`;

    // Get currency emoji
    const currencyEmoji = mission.reward_currency === 'TON' ? 'üíé' : 'üí∞';
    const currencyColor = mission.reward_currency === 'TON' ? 'text-blue-400' : 'text-yellow-400';

    // Border color based on status
    const borderClass = completed && !claimed ? 'border-2 border-yellow-400' : '';

    // Button
    let button = '';
    if (claimed) {
        button = `
            <button class="w-full glass rounded-xl py-3 font-bold text-gray-400 cursor-not-allowed" disabled>
                ‚úì –ü–æ–ª—É—á–µ–Ω–æ
            </button>
        `;
    } else if (completed) {
        button = `
            <button onclick="claimReward(${mission.id})" class="w-full gold-gradient rounded-xl py-3 font-bold text-black hover:opacity-90">
                üéÅ –ó–∞–±—Ä–∞—Ç—å –ù–∞–≥—Ä–∞–¥—É
            </button>
        `;
    } else if (mission.type === 'subscription') {
        button = `
            <button onclick="openChannel('${mission.channel_url}', ${mission.id})" class="w-full bg-blue-600 rounded-xl py-3 font-bold hover:bg-blue-700">
                üì¢ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è
            </button>
        `;
    } else {
        button = `
            <button class="w-full glass rounded-xl py-3 font-bold opacity-50 cursor-not-allowed" disabled>
                –ï—â—ë ${target - progress} ${getRequirementText(mission.requirements)}
            </button>
        `;
    }

    return `
        <div class="glass rounded-2xl p-5 ${borderClass}">
            <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-2">
                        ${icon}
                        <h3 class="text-lg font-bold">${mission.title}</h3>
                    </div>
                    <p class="text-gray-400 text-sm">${mission.description || ''}</p>
                </div>
                <div class="text-right ml-4">
                    <div class="font-bold ${currencyColor}">${currencyEmoji} +${window.formatNumber(mission.reward_amount)}</div>
                    <div class="text-xs text-gray-400">${mission.reward_currency}</div>
                </div>
            </div>

            <div class="mb-3">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-400">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                    <span class="text-sm font-bold ${completed ? 'text-green-400' : ''}">${progress} / ${target} ${completed ? '‚úì' : ''}</span>
                </div>
                <div class="w-full bg-gray-800 rounded-full h-2">
                    <div class="${completed ? 'green-gradient' : 'gold-gradient'} h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                </div>
            </div>

            ${button}
        </div>
    `;
}

// Get requirement text
function getRequirementText(requirements) {
    if (requirements.bets_count !== undefined) return '—Å—Ç–∞–≤–æ–∫';
    if (requirements.wins_count !== undefined) return '–ø–æ–±–µ–¥';
    if (requirements.win_streak !== undefined) return '–ø–æ–¥—Ä—è–¥';
    if (requirements.daily_bets !== undefined) return '—Å—Ç–∞–≤–æ–∫';
    if (requirements.weekly_bets !== undefined) return '—Å—Ç–∞–≤–æ–∫';
    if (requirements.category_bets !== undefined) return '—Å—Ç–∞–≤–æ–∫';
    if (requirements.referrals_count !== undefined) return '—Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤';
    if (requirements.subscription !== undefined) return '';
    return '';
}

// Claim reward
async function claimReward(missionId) {
    try {
        const response = await fetch(`/api/missions/claim/${userId}/${missionId}`, {
            method: 'POST'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to claim reward');
        }

        const result = await response.json();

        // Show success message
        showToast(`–ü–æ–ª—É—á–µ–Ω–æ: ${result.reward.amount} ${result.reward.currency}! üéâ`, 'success');

        // Reload missions
        await loadMissions();

        // Update balance in header if exists
        if (window.updateBalance) {
            window.updateBalance(result.new_balance);
        }

    } catch (error) {
        console.error('Error claiming reward:', error);
        showToast(error.message || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥—ã', 'error');
    }
}

// Open channel (subscription mission)
async function openChannel(channelUrl, missionId) {
    // Open channel in new window
    window.open(channelUrl, '_blank');

    // Wait a bit, then check subscription
    setTimeout(async () => {
        try {
            const response = await fetch(`/api/missions/check-subscription/${userId}/${missionId}`, {
                method: 'POST'
            });

            if (response.ok) {
                const result = await response.json();
                if (result.completed) {
                    showToast('–ú–∏—Å—Å–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! üéâ', 'success');
                    await loadMissions();
                } else {
                    showToast('–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª, —á—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏—Å—Å–∏—é', 'info');
                }
            }
        } catch (error) {
            console.error('Error checking subscription:', error);
        }
    }, 2000);
}

// Toast notification
function showToast(message, type = 'info') {
    // Create toast if it doesn't exist
    let toast = document.getElementById('toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.className = 'fixed top-4 right-4 z-50 max-w-sm';
        document.body.appendChild(toast);
    }

    const colors = {
        success: 'bg-green-600',
        error: 'bg-red-600',
        info: 'bg-blue-600'
    };

    const toastEl = document.createElement('div');
    toastEl.className = `${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg mb-2 transform transition-all`;
    toastEl.textContent = message;

    toast.appendChild(toastEl);

    // Remove after 3 seconds
    setTimeout(() => {
        toastEl.style.opacity = '0';
        setTimeout(() => toastEl.remove(), 300);
    }, 3000);
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadMissions();

    // Refresh missions every 30 seconds
    setInterval(loadMissions, 30000);
});
</script>
{% endblock %}
