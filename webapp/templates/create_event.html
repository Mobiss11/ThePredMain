{% extends "base.html" %}

{% block title %}–°–æ–∑–¥–∞—Ç—å –°–æ–±—ã—Ç–∏–µ - ThePred{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <a href="/" class="text-gray-400 hover:text-white flex items-center space-x-2 mb-4">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            <span>–ù–∞–∑–∞–¥ –∫ —Ä—ã–Ω–∫–∞–º</span>
        </a>
        <h1 class="text-3xl font-bold mb-2">–°–æ–∑–¥–∞—Ç—å –°–æ–±—ã—Ç–∏–µ</h1>
        <p class="text-gray-400">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ —Å–≤–æ—ë —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π. –û–Ω–æ –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º–∏.</p>
    </div>

    <!-- Form -->
    <form id="create-event-form" class="glass rounded-2xl p-6 space-y-5">
        <!-- Event Photo -->
        <div>
            <label class="block text-sm font-medium mb-2">–§–æ—Ç–æ –°–æ–±—ã—Ç–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <div class="glass rounded-xl p-4 border-2 border-dashed border-gray-600 text-center cursor-pointer hover:border-yellow-400 transition" onclick="document.getElementById('event-photo').click()">
                <input type="file" id="event-photo" class="hidden" accept="image/*" onchange="previewEventPhoto(event)">
                <div id="photo-preview" class="hidden mb-2">
                    <img id="photo-preview-img" class="w-full h-48 object-cover rounded-lg">
                </div>
                <div id="photo-placeholder">
                    <svg class="w-12 h-12 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <p class="text-gray-400 text-sm">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ</p>
                </div>
            </div>
        </div>

        <!-- Event Question -->
        <div>
            <label class="block text-sm font-medium mb-2">–í–æ–ø—Ä–æ—Å –°–æ–±—ã—Ç–∏—è *</label>
            <input type="text" id="event-question" required
                   placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–æ—Å—Ç–∏–≥–Ω–µ—Ç –ª–∏ Bitcoin $100,000 –∫ –∫–æ–Ω—Ü—É 2025?"
                   class="w-full glass rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-yellow-400">
            <p class="text-gray-500 text-xs mt-1">–§–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –≤–æ–ø—Ä–æ—Å —Ç–∞–∫, —á—Ç–æ–±—ã –Ω–∞ –Ω–µ–≥–æ –º–æ–∂–Ω–æ –±—ã–ª–æ –æ—Ç–≤–µ—Ç–∏—Ç—å "–î–∞" –∏–ª–∏ "–ù–µ—Ç"</p>
        </div>

        <!-- Event Description -->
        <div>
            <label class="block text-sm font-medium mb-2">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
            <textarea id="event-description" required rows="4"
                      placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞..."
                      class="w-full glass rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-yellow-400 resize-none"></textarea>
            <p class="text-gray-500 text-xs mt-1">–û–ø–∏—à–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ –∏ –∫–∞–∫ –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
        </div>

        <!-- Category -->
        <div>
            <label class="block text-sm font-medium mb-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
            <select id="event-category" required class="w-full glass rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-yellow-400 appearance-none cursor-pointer text-base">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                <option value="Crypto">üí∞ –ö—Ä–∏–ø—Ç–æ</option>
                <option value="Sports">‚öΩ –°–ø–æ—Ä—Ç</option>
                <option value="Politics">üèõÔ∏è –ü–æ–ª–∏—Ç–∏–∫–∞</option>
                <option value="Entertainment">üé¨ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
                <option value="Technology">üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</option>
                <option value="Finance">üìà –§–∏–Ω–∞–Ω—Å—ã</option>
            </select>
        </div>

        <!-- End Date -->
        <div>
            <label class="block text-sm font-medium mb-2">–î–∞—Ç–∞ –û–∫–æ–Ω—á–∞–Ω–∏—è *</label>
            <input type="datetime-local" id="event-end-date" required
                   class="w-full glass rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-yellow-400">
            <p class="text-gray-500 text-xs mt-1">–ö–æ–≥–¥–∞ —Å–æ–±—ã—Ç–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–æ</p>
        </div>

        <!-- Info Box -->
        <div class="glass rounded-xl p-4 bg-yellow-400 bg-opacity-10 border border-yellow-400 border-opacity-30">
            <h3 class="font-bold mb-2 flex items-center space-x-2">
                <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–∞–ª—å—à–µ?</span>
            </h3>
            <ul class="text-sm text-gray-300 space-y-1">
                <li>‚úÖ –í–∞—à–µ —Å–æ–±—ã—Ç–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é</li>
                <li>‚è≥ –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã –ø—Ä–æ–≤–µ—Ä—è—Ç –µ–≥–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤</li>
                <li>üéØ –ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–µ –ø–æ—è–≤–∏—Ç—Å—è –≤ –æ–±—â–µ–º —Å–ø–∏—Å–∫–µ</li>
                <li>üìä –í—ã —Å–º–æ–∂–µ—Ç–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å –≤ –ø—Ä–æ—Ñ–∏–ª–µ</li>
            </ul>
        </div>

        <!-- Buttons -->
        <div class="flex gap-3 pt-4">
            <a href="/" class="flex-1">
                <button type="button" class="w-full glass rounded-xl py-3 font-bold hover:bg-opacity-20 transition">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </a>
            <button type="submit" class="flex-1 gold-gradient rounded-xl py-3 font-bold text-black hover:opacity-90 transition">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
        </div>
    </form>
</div>

<!-- Success Modal -->
<div id="success-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50" style="display: none;">
    <div class="glass rounded-2xl p-6 max-w-md w-full text-center">
        <div class="w-16 h-16 gold-gradient rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
            </svg>
        </div>
        <h2 class="text-2xl font-bold mb-2">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é!</h2>
        <p class="text-gray-400 mb-6">–í–∞—à–µ —Å–æ–±—ã—Ç–∏–µ –±—É–¥–µ—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–æ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤</p>
        <button onclick="window.location.href='/'" class="w-full gold-gradient rounded-xl py-3 font-bold text-black hover:opacity-90 transition">
            –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–æ–±—ã—Ç–∏—è–º
        </button>
    </div>
</div>

<!-- Error Modal -->
<div id="error-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50" style="display: none;">
    <div class="glass rounded-2xl p-6 max-w-md w-full text-center">
        <div class="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </div>
        <h2 class="text-2xl font-bold mb-2">–û—à–∏–±–∫–∞</h2>
        <p class="text-gray-400 mb-6" id="error-message">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è</p>
        <button onclick="hideErrorModal()" class="w-full glass rounded-xl py-3 font-bold hover:bg-opacity-20 transition">
            –ó–∞–∫—Ä—ã—Ç—å
        </button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Preview event photo
function previewEventPhoto(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('photo-preview-img').src = e.target.result;
            document.getElementById('photo-preview').classList.remove('hidden');
            document.getElementById('photo-placeholder').style.display = 'none';
        };
        reader.readAsDataURL(file);
    }
}

// Submit create event form
document.addEventListener('DOMContentLoaded', async () => {
    console.log('Create event page loaded');
    console.log('window.loadUserProfile exists?', typeof window.loadUserProfile);

    // Ensure user profile is loaded
    if (!window.userProfile) {
        console.log('Loading user profile on page load...');
        if (typeof window.loadUserProfile === 'function') {
            await window.loadUserProfile();
        } else {
            console.error('window.loadUserProfile is not a function!');
        }
    } else {
        console.log('User profile already loaded:', window.userProfile);
    }

    const createEventForm = document.getElementById('create-event-form');
    console.log('Create event form found:', !!createEventForm);

    if (createEventForm) {
        createEventForm.addEventListener('submit', async (e) => {
            console.log('Form submit triggered');
            e.preventDefault();
            console.log('Default prevented');

            window.tgHaptic?.light();

            // Load user profile if not loaded
            if (!window.userProfile) {
                console.log('User profile not loaded, loading now...');
                if (typeof window.loadUserProfile === 'function') {
                    await window.loadUserProfile();
                }
            }

            console.log('Current user profile:', window.userProfile);

            // Check if user is loaded
            if (!window.userProfile || !window.userProfile.id) {
                console.error('User profile not loaded or missing ID');
                window.tgHaptic?.error();
                alert('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                return;
            }

            console.log('Creating FormData...');
            const formData = new FormData();
            formData.append('user_id', window.userProfile.id);

            const photoFile = document.getElementById('event-photo').files[0];
            if (photoFile) {
                console.log('Adding photo:', photoFile.name);
                formData.append('photo', photoFile);
            }

            const title = document.getElementById('event-question').value;
            const description = document.getElementById('event-description').value;
            const category = document.getElementById('event-category').value;
            const resolveDate = document.getElementById('event-end-date').value;

            console.log('Form values:', { title, description, category, resolveDate });

            formData.append('title', title);
            formData.append('description', description);
            formData.append('category', category);
            formData.append('resolve_date', resolveDate);

            try {
                console.log('Sending request to:', `${API_URL}/markets/create-event`);
                const response = await fetch(`${API_URL}/markets/create-event`, {
                    method: 'POST',
                    body: formData
                });

                console.log('Response status:', response.status);

                if (response.ok) {
                    console.log('Event created successfully!');
                    window.tgHaptic?.success();
                    // Show success modal
                    document.getElementById('success-modal').style.display = 'flex';
                } else {
                    const errorText = await response.text();
                    console.error('Error creating event:', errorText);
                    let errorMessage;
                    try {
                        const error = JSON.parse(errorText);
                        errorMessage = error.error || error.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è';
                    } catch {
                        errorMessage = errorText || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è';
                    }
                    window.tgHaptic?.error();
                    // Show error modal
                    document.getElementById('error-message').innerText = errorMessage;
                    document.getElementById('error-modal').style.display = 'flex';
                }
            } catch (error) {
                console.error('Create event error:', error);
                window.tgHaptic?.error();
                // Show error modal
                document.getElementById('error-message').innerText = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message;
                document.getElementById('error-modal').style.display = 'flex';
            }
        });
    } else {
        console.error('Create event form not found in DOM!');
    }
});

function hideErrorModal() {
    document.getElementById('error-modal').style.display = 'none';
}
</script>
{% endblock %}
