{% extends "base.html" %}

{% block title %}Ğ Ñ‹Ğ½ĞºĞ¸ - ThePred{% endblock %}

{% block content %}
<!-- Filter Section -->
<div class="mb-6 space-y-3">
    <a href="/create-event" class="block">
        <button class="w-full gold-gradient rounded-xl px-6 py-3.5 font-bold text-base text-black hover:opacity-90 transition flex items-center justify-center space-x-2">
            <span>+</span>
            <span>Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ</span>
        </button>
    </a>
    <select id="category-filter" class="w-full glass px-6 py-3.5 rounded-xl text-base font-medium focus:outline-none focus:ring-2 focus:ring-yellow-400 appearance-none cursor-pointer">
        <option value="">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸</option>
        <option value="Crypto">ğŸ’° ĞšÑ€Ğ¸Ğ¿Ñ‚Ğ¾</option>
        <option value="Sports">âš½ Ğ¡Ğ¿Ğ¾Ñ€Ñ‚</option>
        <option value="Politics">ğŸ›ï¸ ĞŸĞ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°</option>
        <option value="Entertainment">ğŸ¬ Ğ Ğ°Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ</option>
        <option value="Technology">ğŸ’» Ğ¢ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ğ¸</option>
        <option value="Finance">ğŸ“ˆ Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑÑ‹</option>
    </select>
</div>

<!-- Promoted Market -->
<div id="promoted-market" class="mb-6">
    <!-- Will be loaded dynamically -->
</div>

<!-- Markets List -->
<div id="markets-list" class="space-y-4">
    <!-- Market cards will be loaded dynamically -->

</div>

<!-- Load More -->
<button class="w-full glass rounded-xl py-4 font-bold mt-6 hover:bg-opacity-20 transition">
    Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ•Ñ‰Ñ‘
</button>
{% endblock %}

{% block extra_scripts %}
<script>
// Render market card HTML
function renderMarketCard(market, isPromoted = false) {
    const categories = {
        'Crypto': 'ğŸ’°',
        'Sports': 'âš½',
        'Politics': 'ğŸ›ï¸',
        'Finance': 'ğŸ“ˆ',
        'Technology': 'ğŸ’»',
        'Space': 'ğŸš€',
        'Economics': 'ğŸ’µ',
        'Climate': 'ğŸŒ',
        'Health': 'ğŸ¥',
        'Entertainment': 'ğŸ¬'
    };

    const categoryIcon = categories[market.category] || 'ğŸ“Š';

    // Check if user has active bet on this market
    const hasActiveBet = window.hasActiveBetOnMarket && window.hasActiveBetOnMarket(market.id);

    const promotedBadge = market.is_promoted === 'premium'
        ? '<span class="gold-gradient px-3 py-1 rounded-full text-xs font-bold text-black">ğŸ”¥ ĞŸĞ ĞĞ”Ğ’Ğ˜Ğ“ĞĞ•ĞœĞ«Ğ™</span>'
        : market.is_promoted === 'basic'
        ? '<span class="glass px-3 py-1 rounded-full text-xs font-bold">â­ Ğ˜Ğ—Ğ‘Ğ ĞĞĞĞ«Ğ™</span>'
        : '';

    // Active bet badge
    const activeBetBadge = hasActiveBet
        ? '<span class="bg-blue-600 px-3 py-1 rounded-full text-xs font-bold">ğŸ‘¤ Ğ’Ñ‹ ÑƒÑ‡Ğ°ÑÑ‚Ğ²ÑƒĞµÑ‚Ğµ</span>'
        : '';

    // Card styling with active bet highlight
    let cardClass = isPromoted
        ? 'glass card-shine rounded-2xl p-5 mb-6 border-2 border-yellow-400 market-card'
        : 'glass rounded-2xl p-4 market-card';

    if (hasActiveBet && !isPromoted) {
        cardClass = 'glass rounded-2xl p-4 market-card border-2 border-blue-500';
    } else if (hasActiveBet && isPromoted) {
        cardClass = 'glass card-shine rounded-2xl p-5 mb-6 border-2 border-blue-500 market-card';
    }

    // Format end date
    let endDateText = '';
    if (market.resolve_date) {
        const endDate = new Date(market.resolve_date);
        const now = new Date();
        const diff = endDate - now;
        const daysLeft = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hoursLeft = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

        if (daysLeft > 0) {
            endDateText = `${daysLeft}Ğ´ ${hoursLeft}Ñ‡`;
        } else if (hoursLeft > 0) {
            endDateText = `${hoursLeft}Ñ‡`;
        } else {
            endDateText = 'Ğ¡ĞºĞ¾Ñ€Ğ¾';
        }
    }

    // Event avatar (photo or category icon)
    const avatarHtml = market.photo_url
        ? `<img src="${market.photo_url}" alt="${market.title}" class="w-12 h-12 rounded-xl object-cover">`
        : `<div class="w-12 h-12 rounded-xl glass flex items-center justify-center text-2xl">${categoryIcon}</div>`;

    return `
        <div class="${cardClass}">
            <!-- Header: Tag, Avatar, Title, Description -->
            <div class="flex items-start space-x-3 mb-3">
                ${avatarHtml}
                <div class="flex-1 min-w-0">
                    <div class="flex items-center flex-wrap gap-2 mb-1">
                        ${activeBetBadge}
                        ${promotedBadge}
                        <span class="glass px-2 py-0.5 rounded-full text-xs font-medium">${categoryIcon} ${market.category}</span>
                    </div>
                    <h3 class="text-base font-bold mb-1 line-clamp-2">${market.title}</h3>
                    ${market.description ? `<p class="text-gray-400 text-xs line-clamp-1">${market.description}</p>` : ''}
                </div>
            </div>

            <!-- Date and Stats -->
            <div class="flex items-center justify-between text-xs text-gray-400 mb-3">
                ${endDateText ? `<span>â° ${endDateText}</span>` : '<span></span>'}
                <div class="flex items-center space-x-3">
                    <span>ğŸ’° ${window.formatNumber(market.total_volume_pred)}</span>
                    <span>ğŸ‘¥ ${market.bets_count}</span>
                </div>
            </div>

            <!-- Odds -->
            <div class="grid grid-cols-2 gap-2 mb-3">
                <div class="glass rounded-lg p-2">
                    <div class="text-gray-400 text-xs mb-0.5">Ğ”Ğ</div>
                    <div class="text-xl font-bold text-green-400">${Math.round(market.yes_odds)}%</div>
                </div>
                <div class="glass rounded-lg p-2">
                    <div class="text-gray-400 text-xs mb-0.5">ĞĞ•Ğ¢</div>
                    <div class="text-xl font-bold text-red-400">${Math.round(market.no_odds)}%</div>
                </div>
            </div>

            <!-- Bet Buttons -->
            <div class="grid grid-cols-2 gap-2">
                <button onclick="showBetModal(${market.id}, 'YES')" class="bg-green-600 hover:bg-green-700 rounded-lg py-2.5 text-sm font-bold text-white transition">
                    Ğ”Ğ
                </button>
                <button onclick="showBetModal(${market.id}, 'NO')" class="bg-red-600 hover:bg-red-700 rounded-lg py-2.5 text-sm font-bold text-white transition">
                    ĞĞ•Ğ¢
                </button>
            </div>
        </div>
    `;
}

// Show bet modal
function showBetModal(marketId, position) {
    const positionText = position === 'YES' ? 'Ğ”Ğ' : 'ĞĞ•Ğ¢';
    const amount = prompt(`Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑÑƒĞ¼Ğ¼Ñƒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ·Ğ° Ğ² PRED Ğ´Ğ»Ñ ${positionText}:`, '100');
    if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
        window.placeBet(marketId, position, parseFloat(amount));
    }
}

// Load and render markets
async function loadAndRenderMarkets() {
    try {
        const markets = await window.loadMarkets();

        if (markets && markets.length > 0) {
            // Find promoted market
            const promotedMarket = markets.find(m => m.is_promoted === 'premium');
            const regularMarkets = markets.filter(m => m.is_promoted !== 'premium');

            // Render promoted market
            if (promotedMarket) {
                document.getElementById('promoted-market').outerHTML = renderMarketCard(promotedMarket, true);
            }

            // Render regular markets
            const marketsList = document.getElementById('markets-list');
            marketsList.innerHTML = regularMarkets.map(m => renderMarketCard(m)).join('');
        }
    } catch (error) {
        console.error('Failed to load and render markets:', error);
    }
}

// Reload markets function (called after placing bet)
window.reloadMarkets = loadAndRenderMarkets;

// Initialize page
document.addEventListener('DOMContentLoaded', () => {
    loadAndRenderMarkets();

    // Category filter
    const categoryFilter = document.getElementById('category-filter');
    if (categoryFilter) {
        categoryFilter.addEventListener('change', async (e) => {
            const category = e.target.value || null;
            const markets = await window.loadMarkets(category);

            const promotedMarket = markets.find(m => m.is_promoted === 'premium');
            const regularMarkets = markets.filter(m => m.is_promoted !== 'premium');

            // Update promoted market
            if (promotedMarket) {
                document.getElementById('promoted-market').outerHTML = renderMarketCard(promotedMarket, true);
            }

            // Update regular markets
            const marketsList = document.getElementById('markets-list');
            marketsList.innerHTML = regularMarkets.map(m => renderMarketCard(m)).join('');
        });
    }
});
</script>
{% endblock %}
