{% extends "base.html" %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å - ThePred{% endblock %}

{% block content %}
<!-- Profile Header -->
<div class="glass card-shine rounded-2xl p-6 mb-6">
    <div class="flex items-center space-x-4 mb-6">
        <div class="w-20 h-20 rounded-2xl flex items-center justify-center overflow-hidden" id="profile-avatar-container">
            <img id="profile-avatar" src="" alt="–ê–≤–∞—Ç–∞—Ä" class="w-full h-full object-cover" style="display: none;">
            <div id="profile-avatar-placeholder" class="w-full h-full gold-gradient rounded-2xl flex items-center justify-center text-3xl font-bold pulse-gold">
                üèÜ
            </div>
        </div>
        <div class="flex-1">
            <h1 class="text-2xl font-bold mb-2" id="username">...</h1>
            <div class="mb-2">
                <span class="gold-gradient px-3 py-1 rounded-full text-xs font-bold text-black" id="user-rank-badge">
                    ü•â –ë–†–û–ù–ó–û–í–´–ô –†–ê–ù–ì
                </span>
            </div>
            <div>
                <span class="text-gray-400 text-sm" id="user-global-rank"></span>
            </div>
        </div>
    </div>

    <!-- Balance Cards -->
    <div class="grid grid-cols-2 gap-4">
        <div class="glass rounded-xl p-4">
            <div class="text-gray-400 text-sm mb-1">–ë–∞–ª–∞–Ω—Å PRED</div>
            <div class="text-2xl font-bold text-yellow-400" id="pred-balance-display">...</div>
            <button onclick="openDepositModal()" class="gold-gradient px-3 py-1 rounded-lg text-xs font-bold text-black mt-2 hover:opacity-90 transition">
                + –ü–æ–ø–æ–ª–Ω–∏—Ç—å
            </button>
        </div>
        <div class="glass rounded-xl p-4">
            <div class="text-gray-400 text-sm mb-1">–ë–∞–ª–∞–Ω—Å TON</div>
            <div class="text-2xl font-bold text-blue-400" id="ton-balance-display">...</div>

            <!-- Wallet Connection Status -->
            <div id="wallet-connection-status" class="mt-2">
                <button onclick="connectWallet()" id="connect-wallet-btn" class="gold-gradient px-3 py-1 rounded-lg text-xs font-bold text-black hover:opacity-90 transition">
                    üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å
                </button>
                <div id="wallet-connected-info" style="display: none;">
                    <div class="text-xs text-green-400 mt-1">‚úì –ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω</div>
                    <div class="text-xs text-gray-400 truncate mb-2" id="wallet-address-short">...</div>
                    <button onclick="disconnectWallet()" class="w-full bg-red-500 bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded-lg text-xs font-bold text-red-400 transition border border-red-500 border-opacity-30">
                        üîå –û—Ç–∫–ª—é—á–∏—Ç—å (Debug)
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stats -->
<div class="glass rounded-2xl p-6 mb-6">
    <h2 class="text-xl font-bold mb-4">üìä –í–∞—à–∞ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
    <div class="grid grid-cols-2 gap-4">
        <div class="glass rounded-xl p-4 text-center">
            <div class="text-3xl font-bold text-white mb-1" id="stat-total-bets">...</div>
            <div class="text-gray-400 text-sm">–í—Å–µ–≥–æ –ü—Ä–æ–≥–Ω–æ–∑–æ–≤</div>
        </div>
        <div class="glass rounded-xl p-4 text-center">
            <div class="text-3xl font-bold text-green-400 mb-1" id="stat-wins">...</div>
            <div class="text-gray-400 text-sm">–ü–æ–±–µ–¥</div>
        </div>
        <div class="glass rounded-xl p-4 text-center">
            <div class="text-3xl font-bold text-red-400 mb-1" id="stat-losses">...</div>
            <div class="text-gray-400 text-sm">–ü—Ä–æ–∏–≥—Ä—ã—à–µ–π</div>
        </div>
        <div class="glass rounded-xl p-4 text-center">
            <div class="text-3xl font-bold text-purple-400 mb-1" id="stat-winrate">...</div>
            <div class="text-gray-400 text-sm">–í–∏–Ω—Ä–µ–π—Ç</div>
        </div>
    </div>

    <div class="mt-4 glass rounded-xl p-4">
        <div class="flex items-center justify-between mb-2">
            <span class="text-gray-400 text-sm">–¢–µ–∫—É—â–∞—è –°–µ—Ä–∏—è</span>
            <span class="text-2xl font-bold text-yellow-400" id="stat-current-streak">...</span>
        </div>
        <div class="flex items-center justify-between">
            <span class="text-gray-400 text-sm">–õ—É—á—à–∞—è –°–µ—Ä–∏—è</span>
            <span class="text-xl font-bold" id="stat-best-streak">...</span>
        </div>
    </div>
</div>

<!-- Achievements -->
<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
        <a href="/missions" class="text-yellow-400 text-sm">–í—Å–µ –º–∏—Å—Å–∏–∏</a>
    </div>

    <div id="achievements-container" class="grid grid-cols-2 gap-3">
        <!-- Achievements will be loaded dynamically -->
        <div class="glass rounded-xl p-4 text-center">
            <div class="text-gray-400 text-sm">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>
</div>

<!-- Rank Progress -->
<div class="glass rounded-2xl p-6 mb-6">
    <h2 class="text-xl font-bold mb-4">üéñ –ü—Ä–æ–≥—Ä–µ—Å—Å –†–∞–Ω–≥–∞</h2>

    <div id="rank-progress-container" class="space-y-3">
        <!-- Ranks will be loaded dynamically -->
        <div class="glass rounded-xl p-4 text-center">
            <div class="text-gray-400 text-sm">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>
</div>

<!-- Referral -->
<div class="glass rounded-2xl p-6 mb-6">
    <h2 class="text-xl font-bold mb-4">üéÅ –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –î—Ä—É–∑–µ–π</h2>
    <p class="text-gray-400 text-sm mb-4">–ü–æ–ª—É—á–∞–π—Ç–µ 100 PRED –∑–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ –¥—Ä—É–≥–∞!</p>

    <div class="glass rounded-xl p-4 mb-4">
        <div class="text-gray-400 text-xs mb-2">–í–∞—à–∞ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –°—Å—ã–ª–∫–∞</div>
        <input type="text" readonly value="https://t.me/ThePredBot?start=abc123" id="referral-link"
               class="w-full bg-transparent text-sm focus:outline-none mb-3 p-2 rounded border border-gray-700">
        <button onclick="copyReferralLink()" class="w-full gold-gradient px-4 py-2 rounded-lg font-bold text-black text-sm">
            üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –°—Å—ã–ª–∫—É
        </button>
    </div>

    <div class="grid grid-cols-2 gap-4">
        <div class="glass rounded-xl p-4 text-center">
            <div class="text-2xl font-bold mb-1" id="referral-count">...</div>
            <div class="text-gray-400 text-xs">–†–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>
        </div>
        <div class="glass rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-yellow-400 mb-1" id="referral-earned">...</div>
            <div class="text-gray-400 text-xs">PRED –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
        </div>
    </div>
</div>

<!-- Support -->
<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h2 class="text-xl font-bold mb-1">üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞</h2>
            <p class="text-gray-400 text-sm">–ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã? –ú—ã –≥–æ—Ç–æ–≤—ã –ø–æ–º–æ—á—å!</p>
        </div>
        <div class="text-4xl">üéß</div>
    </div>

    <a href="/support" class="block w-full glass rounded-xl p-4 text-center font-semibold bg-yellow-500 bg-opacity-20 hover:bg-opacity-30 transition-all duration-200">
        <span class="text-yellow-400">üì® –û—Ç–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏</span>
    </a>

    <div class="grid grid-cols-2 gap-3 mt-4 text-xs">
        <div class="glass rounded-lg p-3 text-center">
            <div class="text-green-400 font-semibold mb-1">‚ö°Ô∏è –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç</div>
            <div class="text-gray-400">–í —Ç–µ—á–µ–Ω–∏–µ 2-4 —á–∞—Å–æ–≤</div>
        </div>
        <div class="glass rounded-lg p-3 text-center">
            <div class="text-blue-400 font-semibold mb-1">üîí –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ</div>
            <div class="text-gray-400">–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</div>
        </div>
    </div>
</div>

<!-- Recent Bets -->
<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">üìú –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ü—Ä–æ–≥–Ω–æ–∑—ã</h2>
        <a href="/markets" class="text-yellow-400 text-sm">–í—Å–µ</a>
    </div>

    <div id="recent-bets-container" class="space-y-3">
        <!-- Bets will be loaded dynamically -->
        <div class="glass rounded-xl p-4 text-center">
            <div class="text-gray-400 text-sm">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>
</div>

<!-- My Events - For Gold+ users only -->
<div id="my-events-section" class="glass rounded-2xl p-6 mb-6 relative" style="display: none; min-height: 200px;">
    <!-- Will be shown/hidden based on rank -->
</div>

<!-- AI Assistant - Coming Soon -->
<div class="glass rounded-2xl p-6 mb-6 relative overflow-hidden" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(109, 40, 217, 0.15) 100%); border: 2px solid rgba(139, 92, 246, 0.3);">
    <!-- Lock overlay -->
    <div class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-40 flex items-center justify-center z-10">
        <div class="text-center">
            <div class="text-6xl mb-3">üîí</div>
            <div class="text-xl font-bold text-purple-300 mb-1">–°–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ</div>
            <div class="text-sm text-gray-400">–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</div>
        </div>
    </div>

    <!-- Content (blurred behind overlay) -->
    <div class="flex items-start space-x-4 mb-6">
        <div class="w-16 h-16 rounded-2xl flex items-center justify-center text-4xl" style="background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%);">
            ü§ñ
        </div>
        <div class="flex-1">
            <h2 class="text-2xl font-bold mb-2 bg-gradient-to-r from-purple-400 to-purple-600 bg-clip-text text-transparent">
                –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç
            </h2>
            <p class="text-gray-300 text-sm">
                –£–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–±—ã—Ç–∏–π –∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è
            </p>
        </div>
    </div>

    <div class="space-y-3 mb-6">
        <div class="glass rounded-xl p-4" style="border-left: 3px solid #8B5CF6;">
            <div class="flex items-start space-x-3">
                <img src="https://thepred.store/thepred-events/ai-icons/ai-data-analysis.svg" class="w-10 h-10" alt="Data Analysis">
                <div>
                    <div class="font-semibold text-purple-300 mb-1">–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</div>
                    <div class="text-xs text-gray-400">AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏ —Ç–µ–∫—É—â–∏–µ —Ç—Ä–µ–Ω–¥—ã –¥–ª—è —Ç–æ—á–Ω—ã—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π</div>
                </div>
            </div>
        </div>

        <div class="glass rounded-xl p-4" style="border-left: 3px solid #8B5CF6;">
            <div class="flex items-start space-x-3">
                <img src="https://thepred.store/thepred-events/ai-icons/ai-recommendations.svg" class="w-10 h-10" alt="Recommendations">
                <div>
                    <div class="font-semibold text-purple-300 mb-1">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
                    <div class="text-xs text-gray-400">–ü–æ–ª—É—á–∞–π—Ç–µ —Å–æ–≤–µ—Ç—ã –ø–æ —Å—Ç–∞–≤–∫–∞–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–µ–≥–æ —Å—Ç–∏–ª—è –∏ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤</div>
                </div>
            </div>
        </div>

        <div class="glass rounded-xl p-4" style="border-left: 3px solid #8B5CF6;">
            <div class="flex items-start space-x-3">
                <img src="https://thepred.store/thepred-events/ai-icons/ai-insights.svg" class="w-10 h-10" alt="Insights">
                <div>
                    <div class="font-semibold text-purple-300 mb-1">–£–º–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã</div>
                    <div class="text-xs text-gray-400">–£–∑–Ω–∞–≤–∞–π—Ç–µ –æ —Å–∫—Ä—ã—Ç—ã—Ö –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç—è—Ö –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö –¥–ª—è –≤—ã–∏–≥—Ä—ã—à–∞</div>
                </div>
            </div>
        </div>

        <div class="glass rounded-xl p-4" style="border-left: 3px solid #8B5CF6;">
            <div class="flex items-start space-x-3">
                <img src="https://thepred.store/thepred-events/ai-icons/ai-telegram-learning.svg" class="w-10 h-10" alt="Telegram Learning">
                <div>
                    <div class="font-semibold text-purple-300 mb-1">–û–±—É—á–µ–Ω–∏–µ –Ω–∞ Telegram –Ω–æ–≤–æ—Å—Ç—è—Ö</div>
                    <div class="text-xs text-gray-400">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –Ω–æ–≤–æ—Å—Ç–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ - AI –±—É–¥–µ—Ç —É—á–∏—Ç—å—Å—è –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π</div>
                </div>
            </div>
        </div>

        <div class="glass rounded-xl p-4" style="border-left: 3px solid #8B5CF6;">
            <div class="flex items-start space-x-3">
                <img src="https://thepred.store/thepred-events/ai-icons/ai-notifications.svg" class="w-10 h-10" alt="Notifications">
                <div>
                    <div class="font-semibold text-purple-300 mb-1">–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                    <div class="text-xs text-gray-400">–ü–æ–ª—É—á–∞–π—Ç–µ –∞–ª–µ—Ä—Ç—ã –æ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö –∏ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–∞—Ö –¥–ª—è —Å—Ç–∞–≤–æ–∫</div>
                </div>
            </div>
        </div>
    </div>

    <div class="glass rounded-xl p-4 text-center" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(109, 40, 217, 0.3) 100%);">
        <div class="text-sm text-purple-300 font-semibold mb-1">üöÄ –û–∂–∏–¥–∞–µ—Ç—Å—è –∑–∞–ø—É—Å–∫</div>
        <div class="text-xs text-gray-400">AI –ø–æ–º–æ—â–Ω–∏–∫ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å —Ä–∞–Ω–≥–æ–º –ó–æ–ª–æ—Ç–æ –∏ –≤—ã—à–µ</div>
    </div>
</div>

<!-- Deposit Modal -->
<div id="deposit-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4" style="display: none;">
    <div class="glass rounded-2xl max-w-md w-full">
        <div class="p-6">
            <!-- Header -->
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">üíé –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</h2>
                <button onclick="closeDepositModal()" class="text-gray-400 hover:text-white text-2xl">√ó</button>
            </div>

            <!-- Wallet Connection Check -->
            <div id="deposit-connect-wallet" class="mb-6">
                <div class="glass rounded-xl p-5 text-center">
                    <div class="text-4xl mb-3">üëõ</div>
                    <div class="font-semibold mb-2">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ TON –∫–æ—à–µ–ª–µ–∫</div>
                    <div class="text-sm text-gray-400 mb-4">–î–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –≤–∞—à TON –∫–æ—à–µ–ª–µ–∫</div>
                    <button onclick="connectWalletFromModal()" class="gold-gradient px-6 py-3 rounded-xl font-bold text-black hover:opacity-90 transition w-full">
                        üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫
                    </button>
                </div>
            </div>

            <!-- Deposit Form (shown when wallet connected) -->
            <div id="deposit-form" style="display: none;">
                <!-- Conversion Info -->
                <div class="glass rounded-xl p-4 mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm text-gray-400">–ö—É—Ä—Å –æ–±–º–µ–Ω–∞</span>
                        <span class="font-bold text-yellow-400">1 TON = 1,000 PRED</span>
                    </div>
                    <div class="flex items-center justify-between text-xs text-gray-500">
                        <span>–ú–∏–Ω–∏–º—É–º: 0.1 TON</span>
                        <span>–ú–∞–∫—Å–∏–º—É–º: 1,000 TON</span>
                    </div>
                </div>

                <!-- Amount Input -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold mb-2">–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                    <div class="glass rounded-xl p-4">
                        <div class="flex items-center space-x-3 mb-3">
                            <div class="text-2xl">üíé</div>
                            <input
                                type="number"
                                id="deposit-amount-input"
                                placeholder="0.0"
                                step="0.1"
                                min="0.1"
                                max="1000"
                                class="flex-1 bg-transparent text-2xl font-bold focus:outline-none"
                                oninput="calculateExpectedPRED()"
                            >
                            <span class="text-blue-400 font-bold">TON</span>
                        </div>

                        <!-- Quick Amount Buttons -->
                        <div class="flex space-x-2 mb-3">
                            <button onclick="setDepositAmount(0.1)" class="flex-1 glass rounded-lg px-3 py-2 text-xs font-semibold hover:bg-opacity-30 transition">
                                0.1 TON
                            </button>
                            <button onclick="setDepositAmount(1)" class="flex-1 glass rounded-lg px-3 py-2 text-xs font-semibold hover:bg-opacity-30 transition">
                                1 TON
                            </button>
                            <button onclick="setDepositAmount(5)" class="flex-1 glass rounded-lg px-3 py-2 text-xs font-semibold hover:bg-opacity-30 transition">
                                5 TON
                            </button>
                        </div>

                        <!-- Expected PRED -->
                        <div class="pt-3 border-t border-gray-700">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-400">–í—ã –ø–æ–ª—É—á–∏—Ç–µ</span>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xl font-bold text-yellow-400" id="expected-pred">0</span>
                                    <span class="text-sm text-gray-400">PRED</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error Message -->
                <div id="deposit-error" class="mb-4 p-3 rounded-lg bg-red-500 bg-opacity-20 border border-red-500 text-red-400 text-sm" style="display: none;">
                    <div id="deposit-error-text"></div>
                </div>

                <!-- Submit Button -->
                <div class="flex space-x-3">
                    <button onclick="closeDepositModal()" class="flex-1 glass rounded-xl px-6 py-3 font-bold hover:bg-opacity-30 transition">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button onclick="submitDeposit()" id="deposit-submit-btn" class="flex-1 gold-gradient rounded-xl px-6 py-3 font-bold text-black hover:opacity-90 transition">
                        üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å
                    </button>
                </div>

                <!-- Processing State -->
                <div id="deposit-processing" class="mt-4 glass rounded-xl p-4 text-center" style="display: none;">
                    <div class="animate-spin text-4xl mb-3">‚è≥</div>
                    <div class="font-semibold mb-2">–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏...</div>
                    <div class="text-sm text-gray-400" id="deposit-status-text">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Promote Event Modal -->
<div id="promote-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4" style="display: none;">
    <div class="glass rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <!-- Header -->
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">üöÄ –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –°–æ–±—ã—Ç–∏—è</h2>
                <button onclick="closePromoteModal()" class="text-gray-400 hover:text-white text-2xl">√ó</button>
            </div>

            <!-- Event Title -->
            <div class="glass rounded-xl p-4 mb-6">
                <div class="text-sm text-gray-400 mb-1">–°–æ–±—ã—Ç–∏–µ:</div>
                <div class="font-bold" id="promote-event-title">Loading...</div>
            </div>

            <!-- Promotion Options -->
            <div class="space-y-4 mb-6">
                <!-- Basic Promotion -->
                <div class="glass rounded-xl p-5 hover:bg-opacity-30 transition cursor-pointer border-2 border-transparent hover:border-yellow-400" onclick="selectPromotion('basic')">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <div class="text-lg font-bold mb-1">‚≠ê –ë–∞–∑–æ–≤–æ–µ –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ</div>
                            <div class="text-sm text-gray-400">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤ –ª–µ–Ω—Ç–µ –Ω–∞ 7 –¥–Ω–µ–π</div>
                        </div>
                        <input type="radio" name="promotion-type" value="basic" class="mt-1">
                    </div>
                    <div class="flex items-center space-x-4 text-sm">
                        <div class="flex items-center space-x-2">
                            <span class="text-yellow-400 font-bold">500 PRED</span>
                        </div>
                        <div class="text-gray-500">–∏–ª–∏</div>
                        <div class="flex items-center space-x-2">
                            <span class="text-blue-400 font-bold">0.5 TON</span>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-700">
                        <div class="text-xs text-gray-400">‚úì –ü–æ–∫–∞–∑ –≤—ã—à–µ –æ–±—ã—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π</div>
                        <div class="text-xs text-gray-400">‚úì –ë–µ–π–¥–∂ "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"</div>
                    </div>
                </div>

                <!-- Top Category -->
                <div class="glass rounded-xl p-5 hover:bg-opacity-30 transition cursor-pointer border-2 border-transparent hover:border-yellow-400" onclick="selectPromotion('top_category')">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <div class="text-lg font-bold mb-1">üî• –¢–æ–ø –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
                            <div class="text-sm text-gray-400">–ü–µ—Ä–≤–æ–µ –º–µ—Å—Ç–æ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞ 3 –¥–Ω—è</div>
                        </div>
                        <input type="radio" name="promotion-type" value="top_category" class="mt-1">
                    </div>
                    <div class="flex items-center space-x-4 text-sm">
                        <div class="flex items-center space-x-2">
                            <span class="text-yellow-400 font-bold">1000 PRED</span>
                        </div>
                        <div class="text-gray-500">–∏–ª–∏</div>
                        <div class="flex items-center space-x-2">
                            <span class="text-blue-400 font-bold">1 TON</span>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-700">
                        <div class="text-xs text-gray-400">‚úì –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –≤ —Ç–æ–ø–µ —Å–≤–æ–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
                        <div class="text-xs text-gray-400">‚úì –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≤ 3 —Ä–∞–∑–∞</div>
                        <div class="text-xs text-gray-400">‚úì –ó–æ–ª–æ—Ç–∞—è —Ä–∞–º–∫–∞</div>
                    </div>
                </div>

                <!-- Pinned Top -->
                <div class="glass rounded-xl p-5 hover:bg-opacity-30 transition cursor-pointer border-2 border-transparent hover:border-yellow-400" onclick="selectPromotion('pinned')">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <div class="text-lg font-bold mb-1">üìå –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –≤ –¢–æ–ø–µ</div>
                            <div class="text-sm text-gray-400">–ü–µ—Ä–≤–∞—è –ø–æ–∑–∏—Ü–∏—è –≤–æ –≤—Å–µ–π –ª–µ–Ω—Ç–µ –Ω–∞ 24 —á–∞—Å–∞</div>
                        </div>
                        <input type="radio" name="promotion-type" value="pinned" class="mt-1">
                    </div>
                    <div class="flex items-center space-x-4 text-sm">
                        <div class="flex items-center space-x-2">
                            <span class="text-yellow-400 font-bold">2000 PRED</span>
                        </div>
                        <div class="text-gray-500">–∏–ª–∏</div>
                        <div class="flex items-center space-x-2">
                            <span class="text-blue-400 font-bold">2 TON</span>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-700">
                        <div class="text-xs text-gray-400">‚úì –°–∞–º–∞—è –≤–µ—Ä—Ö–Ω—è—è –ø–æ–∑–∏—Ü–∏—è</div>
                        <div class="text-xs text-gray-400">‚úì –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å</div>
                        <div class="text-xs text-gray-400">‚úì –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–æ–ª–æ—Ç–∞—è —Ä–∞–º–∫–∞</div>
                        <div class="text-xs text-gray-400">‚úì –ü—É—à-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</div>
                    </div>
                </div>

                <!-- VIP Premium -->
                <div class="glass rounded-xl p-5 hover:bg-opacity-30 transition cursor-pointer border-2 border-yellow-400 relative overflow-hidden" onclick="selectPromotion('premium')">
                    <div class="absolute top-0 right-0 bg-gradient-to-br from-yellow-400 to-orange-500 px-3 py-1 text-xs font-bold text-black rounded-bl-lg">
                        VIP
                    </div>
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <div class="text-lg font-bold mb-1 text-yellow-400">üëë VIP –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ</div>
                            <div class="text-sm text-gray-400">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –Ω–∞ 7 –¥–Ω–µ–π</div>
                        </div>
                        <input type="radio" name="promotion-type" value="premium" class="mt-1">
                    </div>
                    <div class="flex items-center space-x-4 text-sm">
                        <div class="flex items-center space-x-2">
                            <span class="text-yellow-400 font-bold">5000 PRED</span>
                        </div>
                        <div class="text-gray-500">–∏–ª–∏</div>
                        <div class="flex items-center space-x-2">
                            <span class="text-blue-400 font-bold">5 TON</span>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-700">
                        <div class="text-xs text-gray-400">‚úì –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –≤ —Å–∞–º–æ–º –≤–µ—Ä—Ö—É –Ω–∞ 7 –¥–Ω–µ–π</div>
                        <div class="text-xs text-gray-400">‚úì –ü—Ä–µ–º–∏—É–º –∞–Ω–∏–º–∞—Ü–∏—è –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã</div>
                        <div class="text-xs text-gray-400">‚úì –ë–µ–π–¥–∂ "üî• –ü–†–û–î–í–ò–ì–ê–ï–ú–´–ô"</div>
                        <div class="text-xs text-gray-400">‚úì –ü—É—à-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</div>
                        <div class="text-xs text-gray-400">‚úì –£–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ —Ä–∞—Å—Å—ã–ª–∫–µ</div>
                        <div class="text-xs text-gray-400">‚úì –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö</div>
                    </div>
                </div>
            </div>

            <!-- Payment Method -->
            <div class="glass rounded-xl p-5 mb-6">
                <div class="text-sm font-bold mb-3">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</div>
                <div class="flex space-x-3">
                    <button onclick="selectPaymentMethod('pred')" id="payment-pred" class="flex-1 glass rounded-lg px-4 py-3 font-semibold hover:bg-opacity-30 transition border-2 border-transparent">
                        <div class="text-yellow-400 text-lg mb-1">üí∞ PRED</div>
                        <div class="text-xs text-gray-400">–ë–∞–ª–∞–Ω—Å: <span id="user-pred-balance">...</span></div>
                    </button>
                    <button onclick="selectPaymentMethod('ton')" id="payment-ton" class="flex-1 glass rounded-lg px-4 py-3 font-semibold hover:bg-opacity-30 transition border-2 border-transparent">
                        <div class="text-blue-400 text-lg mb-1">üíé TON</div>
                        <div class="text-xs text-gray-400">–ë–∞–ª–∞–Ω—Å: <span id="user-ton-balance">...</span></div>
                    </button>
                </div>
            </div>

            <!-- Total -->
            <div class="glass rounded-xl p-5 mb-6">
                <div class="flex items-center justify-between">
                    <div class="text-lg font-bold">–ò—Ç–æ–≥–æ:</div>
                    <div class="text-2xl font-bold" id="promotion-total">–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex space-x-3">
                <button onclick="closePromoteModal()" class="flex-1 glass rounded-xl px-6 py-3 font-bold hover:bg-opacity-30 transition">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button onclick="confirmPromotion()" id="confirm-promotion-btn" disabled class="flex-1 gold-gradient rounded-xl px-6 py-3 font-bold text-black hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    –û–ø–ª–∞—Ç–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Load profile data
async function loadProfile() {
    try {
        const response = await fetch('/api/profile');
        if (response.ok) {
            const profile = await response.json();

            // Update username
            document.getElementById('username').innerText = profile.username || profile.first_name || `–ò–≥—Ä–æ–∫ #${profile.telegram_id}`;

            // Update avatar
            const avatar = document.getElementById('profile-avatar');
            const avatarPlaceholder = document.getElementById('profile-avatar-placeholder');
            if (profile.photo_url && avatar && avatarPlaceholder) {
                avatar.src = profile.photo_url;
                avatar.style.display = 'block';
                avatarPlaceholder.style.display = 'none';
            }

            // Update balances
            document.getElementById('pred-balance-display').innerText = window.formatNumber(profile.pred_balance || 0);
            document.getElementById('ton-balance-display').innerText = window.formatNumber(profile.ton_balance || 0);

            // Update stats
            document.getElementById('stat-total-bets').innerText = profile.total_bets || 0;
            document.getElementById('stat-wins').innerText = profile.total_wins || 0;
            document.getElementById('stat-losses').innerText = profile.total_losses || 0;

            const winRate = profile.total_bets > 0
                ? Math.round((profile.total_wins / profile.total_bets) * 100)
                : 0;
            document.getElementById('stat-winrate').innerText = winRate + '%';

            // Update win streak
            document.getElementById('stat-current-streak').innerHTML = `üî• ${profile.win_streak || 0}`;
            document.getElementById('stat-best-streak').innerText = profile.best_streak || 0;

            // Update rank
            const rankBadge = document.getElementById('user-rank-badge');
            const rankIcons = {
                'Bronze': 'ü•â',
                'Silver': 'ü•à',
                'Gold': 'ü•á',
                'Diamond': 'üíé',
                'Legend': 'üåü'
            };
            const rankNames = {
                'Bronze': '–ë–†–û–ù–ó–û–í–´–ô',
                'Silver': '–°–ï–†–ï–ë–†–Ø–ù–´–ô',
                'Gold': '–ó–û–õ–û–¢–û–ô',
                'Diamond': '–ê–õ–ú–ê–ó–ù–´–ô',
                'Legend': '–õ–ï–ì–ï–ù–î–ê–†–ù–´–ô'
            };
            if (rankBadge) {
                rankBadge.innerHTML = `${rankIcons[profile.rank] || 'üèÜ'} ${rankNames[profile.rank] || profile.rank.toUpperCase()} –†–ê–ù–ì`;
            }

            // Load and update global rank from leaderboard
            loadUserRank();

            // Update referral link
            const referralInput = document.getElementById('referral-link');
            if (referralInput && profile.referral_code) {
                referralInput.value = `https://t.me/The_Pred_Bot?start=ref_${profile.referral_code}`;
            }

            // Update rank progress section
            updateRankProgress(profile.rank, profile.total_bets || 0);

            // Load referral stats
            loadReferralStats(profile.id);
        }
    } catch (error) {
        console.error('Failed to load profile:', error);
    }
}

// Load bet history
async function loadBetHistory() {
    try {
        const response = await fetch('/api/bets/history');
        if (response.ok) {
            const bets = await response.json();

            if (bets.length > 0) {
                const recentBetsContainer = document.querySelector('.space-y-3');

                const statusColors = {
                    'WON': 'green-gradient',
                    'LOST': 'red-gradient',
                    'PENDING': 'glass'
                };

                const statusTextColors = {
                    'WON': 'text-white',
                    'LOST': 'text-white',
                    'PENDING': 'text-yellow-400'
                };

                const statusTranslations = {
                    'WON': '–í–´–ò–ì–†–´–®',
                    'LOST': '–ü–†–û–ò–ì–†–´–®',
                    'PENDING': '–û–ñ–ò–î–ê–ù–ò–ï'
                };

                recentBetsContainer.innerHTML = bets.slice(0, 5).map(bet => {
                    const statusClass = statusColors[bet.status] || 'glass';
                    const statusTextClass = statusTextColors[bet.status] || 'text-white';
                    const positionText = bet.position === 'YES' ? '–î–ê' : '–ù–ï–¢';

                    return `
                        <div class="glass rounded-xl p-4">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex-1">
                                    <div class="font-medium mb-1">${bet.market_title || '–†—ã–Ω–æ–∫ #' + bet.market_id}</div>
                                    <div class="text-xs text-gray-400">–ü—Ä–æ–≥–Ω–æ–∑ ${positionText} ‚Ä¢ ${bet.amount} ${bet.currency}</div>
                                </div>
                                <span class="${statusClass} px-3 py-1 rounded-full text-xs font-bold ${statusTextClass}">
                                    ${statusTranslations[bet.status] || bet.status}
                                </span>
                            </div>
                            <div class="text-xs text-gray-500">
                                ${bet.status === 'WON' ? `+${bet.payout} ${bet.currency}` : bet.status === 'LOST' ? `-${bet.amount} ${bet.currency}` : `–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª: +${bet.potential_win} ${bet.currency}`}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
    } catch (error) {
        console.error('Failed to load bet history:', error);
    }
}

// Load user's rank in leaderboard
async function loadUserRank() {
    try {
        const response = await fetch('/api/leaderboard/rank');
        if (response.ok) {
            const rankData = await response.json();
            const globalRank = document.getElementById('user-global-rank');
            if (globalRank && rankData.rank) {
                globalRank.innerText = `üèÜ #${rankData.rank} –≤ –º–∏—Ä–µ`;
            }
        }
    } catch (error) {
        console.error('Failed to load user rank:', error);
    }
}

// Load referral stats
async function loadReferralStats(userId) {
    try {
        const response = await fetch(`/api/users/${userId}/referrals`);
        if (response.ok) {
            const data = await response.json();

            // Update referral count
            const referralCount = document.getElementById('referral-count');
            if (referralCount) {
                referralCount.innerText = data.referral_count || 0;
            }

            // Update referral earned (100 PRED per referral)
            const referralEarned = document.getElementById('referral-earned');
            if (referralEarned) {
                const earned = (data.referral_count || 0) * 100;
                referralEarned.innerText = window.formatNumber(earned);
            }
        }
    } catch (error) {
        console.error('Failed to load referral stats:', error);
        // Set defaults on error
        document.getElementById('referral-count').innerText = '0';
        document.getElementById('referral-earned').innerText = '0';
    }
}

// Update rank progress section dynamically
function updateRankProgress(currentRank, totalBets) {
    const ranks = [
        {
            name: 'Bronze',
            icon: 'ü•â',
            min: 0,
            max: 100,
            text: '–ë—Ä–æ–Ω–∑–∞',
            benefits: [
                '–ö–æ–º–∏—Å—Å–∏—è: 1% PRED, 5% TON',
                '–ë–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã'
            ]
        },
        {
            name: 'Silver',
            icon: 'ü•à',
            min: 100,
            max: 500,
            text: '–°–µ—Ä–µ–±—Ä–æ',
            benefits: [
                '–ö–æ–º–∏—Å—Å–∏—è: 0.8% PRED, 4.5% TON',
                '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞'
            ]
        },
        {
            name: 'Gold',
            icon: 'ü•á',
            min: 500,
            max: 2000,
            text: '–ó–æ–ª–æ—Ç–æ',
            benefits: [
                '–ö–æ–º–∏—Å—Å–∏—è: 0.6% PRED, 4% TON',
                '‚ú® –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π'
            ]
        },
        {
            name: 'Diamond',
            icon: 'üíé',
            min: 2000,
            max: 10000,
            text: '–ê–ª–º–∞–∑',
            benefits: [
                '–ö–æ–º–∏—Å—Å–∏—è: 0.4% PRED, 3% TON',
                '‚ú® –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π',
                'üöÄ –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≤ –ª–µ–Ω—Ç–µ',
                'VIP –ø–æ–¥–¥–µ—Ä–∂–∫–∞ 24/7'
            ]
        },
        {
            name: 'Legend',
            icon: 'üåü',
            min: 10000,
            max: Infinity,
            text: '–õ–µ–≥–µ–Ω–¥–∞',
            benefits: [
                '–ö–æ–º–∏—Å—Å–∏—è: 0.2% PRED, 2% TON',
                '‚ú® –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π',
                'üöÄ –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –≤ —Ç–æ–ø –ª–µ–Ω—Ç—ã',
                '‚≠ê –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –º–µ—Å—Ç–∞',
                '‚è∞ –î–ª–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–µ—Ä–∂–∞–Ω–∏–µ –≤ –ª–µ–Ω—Ç–µ',
                'üëë –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –±–µ–π–¥–∂'
            ]
        }
    ];

    // Find current rank index
    const currentRankIndex = ranks.findIndex(r => r.name === currentRank);
    if (currentRankIndex === -1) return;

    const currentRankData = ranks[currentRankIndex];
    const nextRankData = ranks[currentRankIndex + 1];

    // Update all rank cards
    const rankProgressSection = document.getElementById('rank-progress-container');
    if (!rankProgressSection) return;

    rankProgressSection.innerHTML = ranks.map((rank, index) => {
        const isCurrent = rank.name === currentRank;
        const isPassed = index < currentRankIndex;
        const isNext = index === currentRankIndex + 1;

        let cardClass = 'glass rounded-xl p-5';
        if (isPassed) cardClass += ' opacity-50 border border-gray-700';
        if (isCurrent) cardClass += ' border-2 border-yellow-400 shadow-lg shadow-yellow-400/20';
        if (!isPassed && !isCurrent) cardClass += ' border border-gray-800';

        let content = `
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-2">
                    <span class="text-2xl">${rank.icon}</span>
                    <span class="font-bold text-lg ${isCurrent ? 'text-yellow-400' : ''}">${rank.text}</span>
                </div>
                <div>
                    ${isCurrent ? '<span class="text-xs px-2 py-1 rounded-full bg-green-600 text-white font-bold">–¢–ï–ö–£–©–ò–ô</span>' : ''}
                    ${isPassed ? '<span class="text-xs px-2 py-1 rounded-full bg-gray-600 text-gray-300 font-bold">‚úì –ü–†–û–ô–î–ï–ù</span>' : ''}
                    ${!isCurrent && !isPassed ? `<span class="text-xs text-gray-400">${rank.min}${rank.max === Infinity ? '+' : `-${rank.max}`} –ø—Ä–æ–≥–Ω–æ–∑–æ–≤</span>` : ''}
                </div>
            </div>
        `;

        // Show benefits
        content += `
            <div class="space-y-1.5 mb-3">
                ${rank.benefits.map(benefit => `
                    <div class="flex items-start space-x-2">
                        <span class="text-xs ${isCurrent ? 'text-green-400' : 'text-gray-400'} mt-0.5">‚Ä¢</span>
                        <span class="text-xs ${isCurrent ? 'text-gray-200' : 'text-gray-400'}">${benefit}</span>
                    </div>
                `).join('')}
            </div>
        `;

        // Show progress bar for current rank
        if (isCurrent && nextRankData) {
            const progress = ((totalBets - rank.min) / (rank.max - rank.min)) * 100;
            const remaining = rank.max - totalBets;
            content += `
                <div class="mt-3 pt-3 border-t border-gray-700">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-gray-400">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                        <span class="text-xs font-bold text-yellow-400">${totalBets} / ${rank.max}</span>
                    </div>
                    <div class="w-full bg-gray-800 rounded-full h-2.5 mb-2">
                        <div class="gold-gradient h-2.5 rounded-full transition-all duration-500" style="width: ${Math.min(progress, 100)}%"></div>
                    </div>
                    <div class="text-xs text-gray-400 text-center">
                        <span class="text-yellow-400 font-bold">${remaining}</span> –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –¥–æ —Ä–∞–Ω–≥–∞ ${nextRankData.icon} ${nextRankData.text}
                    </div>
                </div>
            `;
        }

        return `<div class="${cardClass}">${content}</div>`;
    }).join('');
}

// Load user's markets (created + with bets)
async function loadUserMarkets() {
    try {
        // Load bet history (markets where user placed bets)
        const betsResponse = await fetch('/api/bets/history');
        const userMarkets = new Map(); // Using Map to avoid duplicates

        if (betsResponse.ok) {
            const bets = await betsResponse.json();

            bets.forEach(bet => {
                if (!userMarkets.has(bet.market_id)) {
                    userMarkets.set(bet.market_id, {
                        id: bet.market_id,
                        title: bet.market_title || `–°–æ–±—ã—Ç–∏–µ #${bet.market_id}`,
                        status: bet.status,
                        amount: bet.amount,
                        position: bet.position,
                        currency: bet.currency,
                        payout: bet.payout,
                        potential_win: bet.potential_win,
                        type: 'bet'
                    });
                }
            });
        }

        // Render markets
        const recentBetsContainer = document.getElementById('recent-bets-container');

        if (!recentBetsContainer) {
            console.error('Recent bets container not found');
            return;
        }

        if (userMarkets.size > 0) {
            const statusColors = {
                'WON': 'green-gradient',
                'LOST': 'red-gradient',
                'PENDING': 'glass'
            };

            const statusTextColors = {
                'WON': 'text-white',
                'LOST': 'text-white',
                'PENDING': 'text-yellow-400'
            };

            const statusTranslations = {
                'WON': '–í–´–ò–ì–†–´–®',
                'LOST': '–ü–†–û–ò–ì–†–´–®',
                'PENDING': '–û–ñ–ò–î–ê–ù–ò–ï'
            };

            recentBetsContainer.innerHTML = Array.from(userMarkets.values()).slice(0, 10).map(market => {
                const statusClass = statusColors[market.status] || 'glass';
                const statusTextClass = statusTextColors[market.status] || 'text-white';
                const positionText = market.position === 'YES' ? '–î–ê' : '–ù–ï–¢';

                return `
                    <div class="glass rounded-xl p-4">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <div class="font-medium mb-1">${market.title}</div>
                                <div class="text-xs text-gray-400">–ü—Ä–æ–≥–Ω–æ–∑ ${positionText} ‚Ä¢ ${market.amount} ${market.currency}</div>
                            </div>
                            <span class="${statusClass} px-3 py-1 rounded-full text-xs font-bold ${statusTextClass}">
                                ${statusTranslations[market.status] || market.status}
                            </span>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${market.status === 'WON' ? `+${market.payout} ${market.currency}` : market.status === 'LOST' ? `-${market.amount} ${market.currency}` : `–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª: +${market.potential_win} ${market.currency}`}
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            recentBetsContainer.innerHTML = `
                <div class="glass rounded-xl p-6 text-center">
                    <div class="text-4xl mb-2">üìä</div>
                    <div class="text-gray-400 text-sm">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–≥–Ω–æ–∑–æ–≤</div>
                    <a href="/markets" class="mt-3 inline-block gold-gradient px-4 py-2 rounded-lg text-black text-sm font-bold">
                        –°–¥–µ–ª–∞—Ç—å –ü—Ä–æ–≥–Ω–æ–∑
                    </a>
                </div>
            `;
        }
    } catch (error) {
        console.error('Failed to load user markets:', error);
        const recentBetsContainer = document.getElementById('recent-bets-container');
        if (recentBetsContainer) {
            recentBetsContainer.innerHTML = '<div class="glass rounded-xl p-4 text-center text-red-400 text-sm">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤</div>';
        }
    }
}

// Make copyReferralLink globally accessible
window.copyReferralLink = function() {
    const input = document.getElementById('referral-link');
    if (input && window.copyToClipboard) {
        window.copyToClipboard(input.value);
    } else {
        // Fallback to native clipboard API
        if (input) {
            input.select();
            document.execCommand('copy');
            alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
        }
    }
};

// Load achievements
async function loadAchievements() {
    const S3_BASE_URL = 'https://thepred.store/thepred-events/missions';
    const userId = {{ user_id }};

    try {
        const response = await fetch(`/api/missions/${userId}`);
        if (!response.ok) {
            throw new Error('Failed to load achievements');
        }

        const missions = await response.json();

        // Filter only achievements
        const achievements = missions.filter(m => m.type === 'achievement');

        const container = document.getElementById('achievements-container');

        if (achievements.length === 0) {
            container.innerHTML = '<div class="col-span-2 glass rounded-xl p-4 text-center text-gray-400 text-sm">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</div>';
            return;
        }

        container.innerHTML = achievements.slice(0, 6).map(achievement => {
            const isCompleted = achievement.completed;
            const progress = achievement.progress || 0;
            const target = achievement.target || 1;
            const percentage = Math.min((progress / target) * 100, 100);

            // Get icon - check if it's custom URL, S3 icon name, or emoji
            let iconHtml;
            if (achievement.custom_icon_url) {
                // Custom URL provided
                iconHtml = `<img src="${achievement.custom_icon_url}" class="w-12 h-12 mx-auto mb-2 object-contain" alt="icon" />`;
            } else if (achievement.icon) {
                // Check if it's an emoji (single character or contains emoji unicode)
                const isEmoji = /(\p{Emoji_Presentation}|\p{Extended_Pictographic})/u.test(achievement.icon) || achievement.icon.length <= 2;
                if (isEmoji) {
                    // It's an emoji
                    iconHtml = `<span class="text-4xl">${achievement.icon}</span>`;
                } else {
                    // It's an S3 icon name
                    const iconUrl = `${S3_BASE_URL}/${achievement.icon}.svg`;
                    iconHtml = `<img src="${iconUrl}" class="w-12 h-12 mx-auto mb-2 object-contain" alt="${achievement.icon}" />`;
                }
            } else {
                // Default icon
                iconHtml = `<span class="text-4xl">üéØ</span>`;
            }

            return `
                <div class="glass rounded-xl p-4 text-center relative ${isCompleted ? 'border-2 border-green-500' : ''}">
                    <div class="mb-2">
                        ${iconHtml}
                    </div>
                        ${isCompleted ? '<div class="absolute top-2 right-2 text-green-500 text-xl">‚úì</div>' : ''}
                        <div class="font-bold text-sm mb-1">${achievement.title}</div>
                        <div class="text-xs text-gray-400 mb-2">${achievement.description}</div>

                        ${!isCompleted ? `
                            <div class="w-full bg-gray-800 rounded-full h-1.5 mb-1">
                                <div class="gold-gradient h-1.5 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                            <div class="text-xs text-gray-500">${progress}/${target}</div>
                        ` : `
                            <div class="text-xs text-green-400 font-bold">‚úì –ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                        `}

                        <div class="text-xs text-yellow-400 font-bold mt-2">
                            +${achievement.reward_amount} ${achievement.reward_currency}
                        </div>
                    </div>
                `;
            }).join('');
    } catch (error) {
        console.error('Failed to load achievements:', error);
        const container = document.getElementById('achievements-container');
        if (container) {
            container.innerHTML = '<div class="col-span-2 glass rounded-xl p-4 text-center text-red-400 text-sm">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</div>';
        }
    }
}

// Load user's created events
async function loadMyEvents() {
    const userRank = window.userProfile?.rank || 'Bronze';
    const userId = window.userProfile?.id;
    const goldPlusRanks = ['Gold', 'Diamond', 'Legend'];
    const hasAccess = goldPlusRanks.includes(userRank);

    const section = document.getElementById('my-events-section');
    if (!section) return;

    if (!hasAccess) {
        // Show locked version for non-Gold users
        section.style.display = 'block';
        section.style.background = 'linear-gradient(135deg, rgba(255, 215, 0, 0.05) 0%, rgba(255, 165, 0, 0.1) 100%)';
        section.style.border = '2px solid rgba(255, 215, 0, 0.2)';
        section.innerHTML = `
            <div class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-50 flex items-center justify-center z-10">
                <div class="text-center">
                    <div class="text-6xl mb-3">üîí</div>
                    <div class="text-xl font-bold text-yellow-300 mb-2">–°–æ–∑–¥–∞–Ω–∏–µ –°–æ–±—ã—Ç–∏–π</div>
                    <div class="text-sm text-gray-400 mb-3">–î–æ—Å—Ç—É–ø–Ω–æ —Å Gold —Ä–∞–Ω–≥–∞ –∏ –≤—ã—à–µ</div>
                    <a href="/markets" class="inline-block gold-gradient px-6 py-2 rounded-lg text-black font-bold text-sm">
                        –ü–æ–≤—ã—Å–∏—Ç—å –†–∞–Ω–≥
                    </a>
                </div>
            </div>
            <div class="opacity-40">
                <h2 class="text-xl font-bold mb-4">üéØ –ú–æ–∏ –°–æ–±—ã—Ç–∏—è</h2>
                <div class="glass rounded-xl p-4 text-center">
                    <div class="text-gray-400 text-sm">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π</div>
                </div>
            </div>
        `;
        return;
    }

    // Gold+ users - load their events
    section.style.display = 'block';

    // Check if userId is available
    if (!userId) {
        section.innerHTML = `
            <h2 class="text-xl font-bold mb-4">üéØ –ú–æ–∏ –°–æ–±—ã—Ç–∏—è</h2>
            <div class="glass rounded-xl p-4 text-center text-gray-400 text-sm">
                –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
        `;
        return;
    }

    try {
        console.log('Loading events for user:', userId);
        const response = await fetch(`/api/markets/user/${userId}`);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('Failed to load events:', response.status, errorText);
            throw new Error(`Failed to load events: ${response.status}`);
        }

        const events = await response.json();
        console.log('Loaded events:', events);

        section.innerHTML = `
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">üéØ –ú–æ–∏ –°–æ–±—ã—Ç–∏—è</h2>
                <a href="/create-event" class="gold-gradient px-4 py-2 rounded-lg text-black font-bold text-sm">
                    + –°–æ–∑–¥–∞—Ç—å
                </a>
            </div>
            <div id="user-events-container" class="space-y-3">
                ${events.length === 0 ? `
                    <div class="glass rounded-xl p-6 text-center">
                        <div class="text-4xl mb-2">üìä</div>
                        <div class="text-gray-400 text-sm mb-3">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π</div>
                        <a href="/create-event" class="inline-block gold-gradient px-4 py-2 rounded-lg text-black font-bold text-sm">
                            –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ
                        </a>
                    </div>
                ` : events.map(event => `
                    <div class="glass rounded-xl p-4">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="font-semibold mb-1">${event.title}</div>
                                <div class="text-xs text-gray-400">${event.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}</div>
                            </div>
                            <span class="px-3 py-1 rounded-full text-xs font-bold ${
                                event.status === 'open' ? 'bg-green-600' :
                                event.status === 'resolved' ? 'bg-blue-600' : 'bg-gray-600'
                            }">${
                                event.status === 'open' ? '–ê–∫—Ç–∏–≤–Ω–æ' :
                                event.status === 'resolved' ? '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' : '–û—Ç–º–µ–Ω–µ–Ω–æ'
                            }</span>
                        </div>

                        <div class="grid grid-cols-3 gap-2 mb-3 text-xs">
                            <div class="glass rounded-lg p-2 text-center">
                                <div class="text-gray-400">–û–±—ä—ë–º</div>
                                <div class="font-bold">${window.formatNumber(event.total_volume_pred)} PRED</div>
                            </div>
                            <div class="glass rounded-lg p-2 text-center">
                                <div class="text-gray-400">–°—Ç–∞–≤–æ–∫</div>
                                <div class="font-bold">${event.bets_count || 0}</div>
                            </div>
                            <div class="glass rounded-lg p-2 text-center">
                                <div class="text-gray-400">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</div>
                                <div class="font-bold">${event.views_count || 0}</div>
                            </div>
                        </div>

                        ${event.is_promoted && event.is_promoted !== 'none' ? `
                            <div class="mb-3">
                                <span class="gold-gradient px-3 py-1 rounded-full text-xs font-bold text-black">
                                    üî• ${event.is_promoted === 'premium' ? 'VIP –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ' : '–ü—Ä–æ–¥–≤–∏–≥–∞–µ—Ç—Å—è'}
                                </span>
                            </div>
                        ` : ''}

                        <div class="flex items-center space-x-2">
                            <a href="/market/${event.id}" class="flex-1 glass rounded-lg px-4 py-2 text-center text-sm font-semibold hover:bg-opacity-30 transition">
                                –û—Ç–∫—Ä—ã—Ç—å
                            </a>
                            ${event.status === 'open' ? `
                                <button onclick="openPromoteModal(${event.id}, '${event.title}')" class="flex-1 gold-gradient rounded-lg px-4 py-2 text-center text-sm font-bold text-black hover:opacity-90 transition">
                                    üöÄ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—å
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    } catch (error) {
        console.error('Failed to load my events:', error);
        section.innerHTML = `
            <h2 class="text-xl font-bold mb-4">üéØ –ú–æ–∏ –°–æ–±—ã—Ç–∏—è</h2>
            <div class="glass rounded-xl p-4 text-center">
                <div class="text-red-400 text-sm mb-3">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π</div>
                <button onclick="loadMyEvents()" class="gold-gradient px-4 py-2 rounded-lg text-black font-bold text-sm">
                    –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É
                </button>
            </div>
        `;
    }
}

// Promotion modal state
let currentPromotionData = {
    eventId: null,
    eventTitle: null,
    promotionType: null,
    paymentMethod: null
};

const promotionPrices = {
    basic: { pred: 500, ton: 0.5 },
    top_category: { pred: 1000, ton: 1 },
    pinned: { pred: 2000, ton: 2 },
    premium: { pred: 5000, ton: 5 }
};

// Open promote modal
window.openPromoteModal = function(eventId, eventTitle) {
    currentPromotionData.eventId = eventId;
    currentPromotionData.eventTitle = eventTitle;
    currentPromotionData.promotionType = null;
    currentPromotionData.paymentMethod = 'pred'; // Default

    // Update modal
    document.getElementById('promote-event-title').textContent = eventTitle;
    document.getElementById('user-pred-balance').textContent = window.formatNumber(window.userProfile?.pred_balance || 0);
    document.getElementById('user-ton-balance').textContent = window.formatNumber(window.userProfile?.ton_balance || 0);

    // Reset selections
    document.querySelectorAll('input[name="promotion-type"]').forEach(input => input.checked = false);
    document.getElementById('payment-pred').classList.add('border-yellow-400');
    document.getElementById('payment-ton').classList.remove('border-blue-400');
    document.getElementById('promotion-total').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω';
    document.getElementById('confirm-promotion-btn').disabled = true;

    // Show modal
    document.getElementById('promote-modal').style.display = 'flex';
};

// Close promote modal
window.closePromoteModal = function() {
    document.getElementById('promote-modal').style.display = 'none';
    currentPromotionData = {
        eventId: null,
        eventTitle: null,
        promotionType: null,
        paymentMethod: null
    };
};

// Select promotion type
window.selectPromotion = function(type) {
    currentPromotionData.promotionType = type;

    // Update radio button
    document.querySelector(`input[name="promotion-type"][value="${type}"]`).checked = true;

    // Update total
    updatePromotionTotal();
};

// Select payment method
window.selectPaymentMethod = function(method) {
    currentPromotionData.paymentMethod = method;

    // Update button styles
    if (method === 'pred') {
        document.getElementById('payment-pred').classList.add('border-yellow-400');
        document.getElementById('payment-ton').classList.remove('border-blue-400');
    } else {
        document.getElementById('payment-pred').classList.remove('border-yellow-400');
        document.getElementById('payment-ton').classList.add('border-blue-400');
    }

    // Update total
    updatePromotionTotal();
};

// Update total display
function updatePromotionTotal() {
    const { promotionType, paymentMethod } = currentPromotionData;

    if (!promotionType || !paymentMethod) {
        document.getElementById('promotion-total').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω';
        document.getElementById('confirm-promotion-btn').disabled = true;
        return;
    }

    const price = promotionPrices[promotionType][paymentMethod];
    const currency = paymentMethod === 'pred' ? 'PRED' : 'TON';
    const color = paymentMethod === 'pred' ? 'text-yellow-400' : 'text-blue-400';

    document.getElementById('promotion-total').innerHTML = `<span class="${color}">${price} ${currency}</span>`;

    // Check if user has enough balance
    const userBalance = paymentMethod === 'pred'
        ? window.userProfile?.pred_balance || 0
        : window.userProfile?.ton_balance || 0;

    if (userBalance >= price) {
        document.getElementById('confirm-promotion-btn').disabled = false;
    } else {
        document.getElementById('confirm-promotion-btn').disabled = true;
        document.getElementById('promotion-total').innerHTML += ` <span class="text-red-400 text-sm">(–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤)</span>`;
    }
}

// Confirm and purchase promotion
window.confirmPromotion = async function() {
    const { eventId, promotionType, paymentMethod } = currentPromotionData;

    if (!eventId || !promotionType || !paymentMethod) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è');
        return;
    }

    const confirmBtn = document.getElementById('confirm-promotion-btn');
    confirmBtn.disabled = true;
    confirmBtn.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';

    try {
        const response = await fetch('/api/markets/promote', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                market_id: eventId,
                promotion_type: promotionType,
                currency: paymentMethod
            })
        });

        const result = await response.json();

        if (response.ok) {
            alert('‚úÖ –°–æ–±—ã—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ!');
            closePromoteModal();

            // Reload profile and events
            await loadProfile();
            await loadMyEvents();
        } else {
            alert(`‚ùå –û—à–∏–±–∫–∞: ${result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—å —Å–æ–±—ã—Ç–∏–µ'}`);
        }
    } catch (error) {
        console.error('Failed to promote event:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è');
    } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = '–û–ø–ª–∞—Ç–∏—Ç—å';
    }
};

// Clear session and re-authenticate
async function clearSessionAndReauth() {
    if (confirm('–°–±—Ä–æ—Å–∏—Ç—å —Å–µ—Å—Å–∏—é –∏ –∑–∞–Ω–æ–≤–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è?')) {
        try {
            const response = await fetch('/debug/clear-session');
            const result = await response.json();
            if (result.success) {
                alert('–°–µ—Å—Å–∏—è –æ—á–∏—â–µ–Ω–∞! –°–µ–π—á–∞—Å –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.');
                // Redirect to home to trigger re-authentication
                window.location.href = '/';
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
    }
}

// ============ TON Wallet & Deposit Functions ============

// Initialize TON Connect Manual (custom UI)
window.tonConnectManual = new TONConnectManual('https://thepred.tech/static/tonconnect-manifest.json');

// Check wallet connection status on load
async function checkWalletConnection() {
    try {
        // Wait for tonConnectManual to initialize
        await window.tonConnectManual.initPromise;

        // First check localStorage connection (from TON Connect SDK)
        if (window.tonConnectManual.connected && window.tonConnectManual.address) {
            updateWalletConnectionUI(true, window.tonConnectManual.address);
            return;
        }

        // If not connected in localStorage, check database
        console.log('üîç Checking wallet in database...');

        // Get user_id from global userProfile
        const userId = window.userProfile?.id;
        if (!userId) {
            console.error('‚ùå No user_id found in window.userProfile');
            updateWalletConnectionUI(false, null);
            return;
        }

        const response = await fetch(`/api/wallet/balance/${userId}`);

        if (response.ok) {
            const data = await response.json();
            console.log('‚úÖ Wallet info from database:', data);

            if (data.wallet_connected && data.ton_address) {
                console.log('üìç Wallet found in database:', data.ton_address);
                // Update UI to show wallet as connected
                updateWalletConnectionUI(true, data.ton_address);

                // Update internal state
                window.tonConnectManual.connected = true;
                window.tonConnectManual.address = data.ton_address;
            } else {
                console.log('‚ÑπÔ∏è No wallet connected in database');
                updateWalletConnectionUI(false, null);
            }
        } else {
            console.log('‚ÑπÔ∏è Could not fetch wallet info from database');
            updateWalletConnectionUI(false, null);
        }
    } catch (error) {
        console.error('Failed to check wallet connection:', error);
        updateWalletConnectionUI(false, null);
    }
}

// Update wallet connection UI
function updateWalletConnectionUI(connected, address) {
    const connectBtn = document.getElementById('connect-wallet-btn');
    const connectedInfo = document.getElementById('wallet-connected-info');
    const addressShort = document.getElementById('wallet-address-short');

    if (connected && address) {
        connectBtn.style.display = 'none';
        connectedInfo.style.display = 'block';
        // Show shortened address (first 6 and last 4 chars)
        addressShort.textContent = `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
    } else {
        connectBtn.style.display = 'block';
        connectedInfo.style.display = 'none';
    }
}

// Connect wallet
window.connectWallet = async function() {
    try {
        // Just call connect() - it will show custom modal
        // Success is handled via onConnectionChange callback
        await window.tonConnectManual.connect();
    } catch (error) {
        console.error('Wallet connection failed:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞: ' + error.message);
    }
};

// Disconnect wallet (DEBUG)
window.disconnectWallet = async function() {
    try {
        await window.tonConnectManual.disconnect();
        // Update UI
        updateWalletConnectionUI(false, null);
        console.log('Wallet disconnected successfully');
    } catch (error) {
        console.error('Wallet disconnection failed:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞: ' + error.message);
    }
};

// Set up wallet connection callback
window.tonConnectManual.onConnectionChange = function(connected, address) {
    console.log('Wallet connection changed:', connected, address);

    if (connected && address) {
        // Update UI
        updateWalletConnectionUI(true, address);

        // Update deposit modal state
        updateDepositModalState();

        // Save address to backend
        window.tonConnectManual.saveAddress();

        // Show success notification ONLY if not restoring connection
        if (!window.tonConnectManual.isRestoringConnection) {
            const tg = window.Telegram?.WebApp;
            if (tg && tg.showAlert) {
                tg.showAlert('‚úÖ –ö–æ—à–µ–ª–µ–∫ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!');
            }
        }

        // Reload profile to show updated balance
        loadProfile();
    } else {
        // Wallet disconnected
        updateWalletConnectionUI(false, null);

        // Update deposit modal state
        updateDepositModalState();
    }
};

// Connect wallet from modal
window.connectWalletFromModal = async function() {
    try {
        // Just call connect() - it will show custom modal
        // Success is handled via onConnectionChange callback
        await window.tonConnectManual.connect();
    } catch (error) {
        console.error('Wallet connection failed:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞: ' + error.message);
    }
};

// Open deposit modal
window.openDepositModal = function() {
    document.getElementById('deposit-modal').style.display = 'flex';
    updateDepositModalState();

    // Reset form
    document.getElementById('deposit-amount-input').value = '';
    document.getElementById('expected-pred').textContent = '0';
    document.getElementById('deposit-error').style.display = 'none';
    document.getElementById('deposit-processing').style.display = 'none';
};

// Close deposit modal
window.closeDepositModal = function() {
    document.getElementById('deposit-modal').style.display = 'none';
};

// Update deposit modal state based on wallet connection
function updateDepositModalState() {
    const connectSection = document.getElementById('deposit-connect-wallet');
    const depositForm = document.getElementById('deposit-form');

    if (window.tonConnectManual.connected) {
        connectSection.style.display = 'none';
        depositForm.style.display = 'block';
    } else {
        connectSection.style.display = 'block';
        depositForm.style.display = 'none';
    }
}

// Set deposit amount (quick buttons)
window.setDepositAmount = function(amount) {
    document.getElementById('deposit-amount-input').value = amount;
    calculateExpectedPRED();
};

// Calculate expected PRED from TON amount
window.calculateExpectedPRED = function() {
    const amountInput = document.getElementById('deposit-amount-input');
    const expectedPred = document.getElementById('expected-pred');

    const amount = parseFloat(amountInput.value) || 0;
    const pred = Math.floor(amount * 1000); // 1 TON = 1000 PRED

    expectedPred.textContent = formatNumber(pred);
};

// Submit deposit
window.submitDeposit = async function() {
    const amountInput = document.getElementById('deposit-amount-input');
    const amount = parseFloat(amountInput.value);

    // Validate amount
    if (!amount || amount < 0.1) {
        showDepositError('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–∞: 0.1 TON');
        return;
    }

    if (amount > 1000) {
        showDepositError('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–∞: 1,000 TON');
        return;
    }

    // Hide error
    document.getElementById('deposit-error').style.display = 'none';

    // Show processing
    const submitBtn = document.getElementById('deposit-submit-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';

    const processingDiv = document.getElementById('deposit-processing');
    processingDiv.style.display = 'block';

    try {
        // Update status
        updateDepositStatus('–°–æ–∑–¥–∞–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞...');

        // Execute deposit flow
        const result = await window.tonWallet.deposit(amount);

        if (result.success) {
            // Success!
            updateDepositStatus('‚úÖ –î–µ–ø–æ–∑–∏—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞—á–∏—Å–ª–µ–Ω!');

            // Wait 2 seconds before closing
            await new Promise(resolve => setTimeout(resolve, 2000));

            // Reload profile to update balances
            await loadProfile();

            // Close modal
            closeDepositModal();

            // Show success message
            alert(`‚úÖ –£—Å–ø–µ—à–Ω–æ! –ó–∞—á–∏—Å–ª–µ–Ω–æ ${result.pred_credited} PRED`);
        } else {
            throw new Error(result.error || 'Deposit failed');
        }
    } catch (error) {
        console.error('Deposit failed:', error);
        showDepositError('–û—à–∏–±–∫–∞ –¥–µ–ø–æ–∑–∏—Ç–∞: ' + error.message);
        processingDiv.style.display = 'none';
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å';
    }
};

// Show deposit error
function showDepositError(message) {
    const errorDiv = document.getElementById('deposit-error');
    const errorText = document.getElementById('deposit-error-text');

    errorText.textContent = message;
    errorDiv.style.display = 'block';
}

// Update deposit status text
function updateDepositStatus(text) {
    document.getElementById('deposit-status-text').textContent = text;
}

// Format number with commas
function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// Make formatNumber globally accessible
window.formatNumber = formatNumber;

// Load data on page load
document.addEventListener('DOMContentLoaded', () => {
    loadProfile();
    loadUserMarkets();
    loadAchievements();

    // Check wallet connection
    checkWalletConnection();

    // Load my events after profile is loaded
    setTimeout(() => {
        loadMyEvents();
    }, 500);
});
</script>
{% endblock %}
