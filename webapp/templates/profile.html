{% extends "base.html" %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å - ThePred{% endblock %}

{% block content %}
<!-- Profile Header -->
<div class="glass card-shine rounded-2xl p-6 mb-6">
    <div class="flex items-center space-x-4 mb-6">
        <div class="w-20 h-20 rounded-2xl flex items-center justify-center overflow-hidden" id="profile-avatar-container">
            <img id="profile-avatar" src="" alt="–ê–≤–∞—Ç–∞—Ä" class="w-full h-full object-cover" style="display: none;">
            <div id="profile-avatar-placeholder" class="w-full h-full gold-gradient rounded-2xl flex items-center justify-center text-3xl font-bold pulse-gold">
                üèÜ
            </div>
        </div>
        <div class="flex-1">
            <h1 class="text-2xl font-bold mb-2" id="username">...</h1>
            <div class="mb-2">
                <span class="gold-gradient px-3 py-1 rounded-full text-xs font-bold text-black" id="user-rank-badge">
                    ü•â –ë–†–û–ù–ó–û–í–´–ô –†–ê–ù–ì
                </span>
            </div>
            <div>
                <span class="text-gray-400 text-sm" id="user-global-rank"></span>
            </div>
        </div>
    </div>

    <!-- Balance Cards -->
    <div class="grid grid-cols-2 gap-4">
        <div class="glass rounded-xl p-4">
            <div class="text-gray-400 text-sm mb-1">–ë–∞–ª–∞–Ω—Å PRED</div>
            <div class="text-2xl font-bold text-yellow-400" id="pred-balance-display">...</div>
            <button class="gold-gradient px-3 py-1 rounded-lg text-xs font-bold text-black mt-2">
                + –ü–æ–ø–æ–ª–Ω–∏—Ç—å
            </button>
        </div>
        <div class="glass rounded-xl p-4">
            <div class="text-gray-400 text-sm mb-1">–ë–∞–ª–∞–Ω—Å TON</div>
            <div class="text-2xl font-bold text-blue-400" id="ton-balance-display">...</div>
            <button class="gold-gradient px-3 py-1 rounded-lg text-xs font-bold text-black mt-2">
                + –ü–æ–ø–æ–ª–Ω–∏—Ç—å
            </button>
        </div>
    </div>

    <!-- Debug: Clear Session Button -->
    <div class="mt-4">
        <button onclick="clearSessionAndReauth()" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition">
            üîÑ –°–±—Ä–æ—Å–∏—Ç—å –°–µ—Å—Å–∏—é (Debug)
        </button>
    </div>
</div>

<!-- Stats -->
<div class="glass rounded-2xl p-6 mb-6">
    <h2 class="text-xl font-bold mb-4">üìä –í–∞—à–∞ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
    <div class="grid grid-cols-2 gap-4">
        <div class="glass rounded-xl p-4 text-center">
            <div class="text-3xl font-bold text-white mb-1" id="stat-total-bets">...</div>
            <div class="text-gray-400 text-sm">–í—Å–µ–≥–æ –ü—Ä–æ–≥–Ω–æ–∑–æ–≤</div>
        </div>
        <div class="glass rounded-xl p-4 text-center">
            <div class="text-3xl font-bold text-green-400 mb-1" id="stat-wins">...</div>
            <div class="text-gray-400 text-sm">–ü–æ–±–µ–¥</div>
        </div>
        <div class="glass rounded-xl p-4 text-center">
            <div class="text-3xl font-bold text-red-400 mb-1" id="stat-losses">...</div>
            <div class="text-gray-400 text-sm">–ü—Ä–æ–∏–≥—Ä—ã—à–µ–π</div>
        </div>
        <div class="glass rounded-xl p-4 text-center">
            <div class="text-3xl font-bold text-purple-400 mb-1" id="stat-winrate">...</div>
            <div class="text-gray-400 text-sm">–í–∏–Ω—Ä–µ–π—Ç</div>
        </div>
    </div>

    <div class="mt-4 glass rounded-xl p-4">
        <div class="flex items-center justify-between mb-2">
            <span class="text-gray-400 text-sm">–¢–µ–∫—É—â–∞—è –°–µ—Ä–∏—è</span>
            <span class="text-2xl font-bold text-yellow-400" id="stat-current-streak">...</span>
        </div>
        <div class="flex items-center justify-between">
            <span class="text-gray-400 text-sm">–õ—É—á—à–∞—è –°–µ—Ä–∏—è</span>
            <span class="text-xl font-bold" id="stat-best-streak">...</span>
        </div>
    </div>
</div>

<!-- Achievements -->
<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
        <a href="/missions" class="text-yellow-400 text-sm">–í—Å–µ –º–∏—Å—Å–∏–∏</a>
    </div>

    <div id="achievements-container" class="grid grid-cols-2 gap-3">
        <!-- Achievements will be loaded dynamically -->
        <div class="glass rounded-xl p-4 text-center">
            <div class="text-gray-400 text-sm">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>
</div>

<!-- Rank Progress -->
<div class="glass rounded-2xl p-6 mb-6">
    <h2 class="text-xl font-bold mb-4">üéñ –ü—Ä–æ–≥—Ä–µ—Å—Å –†–∞–Ω–≥–∞</h2>

    <div id="rank-progress-container" class="space-y-3">
        <!-- Ranks will be loaded dynamically -->
        <div class="glass rounded-xl p-4 text-center">
            <div class="text-gray-400 text-sm">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>
</div>

<!-- Referral -->
<div class="glass rounded-2xl p-6 mb-6">
    <h2 class="text-xl font-bold mb-4">üéÅ –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –î—Ä—É–∑–µ–π</h2>
    <p class="text-gray-400 text-sm mb-4">–ü–æ–ª—É—á–∞–π—Ç–µ 100 PRED –∑–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ –¥—Ä—É–≥–∞!</p>

    <div class="glass rounded-xl p-4 mb-4">
        <div class="text-gray-400 text-xs mb-2">–í–∞—à–∞ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –°—Å—ã–ª–∫–∞</div>
        <input type="text" readonly value="https://t.me/ThePredBot?start=abc123" id="referral-link"
               class="w-full bg-transparent text-sm focus:outline-none mb-3 p-2 rounded border border-gray-700">
        <button onclick="copyReferralLink()" class="w-full gold-gradient px-4 py-2 rounded-lg font-bold text-black text-sm">
            üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –°—Å—ã–ª–∫—É
        </button>
    </div>

    <div class="grid grid-cols-2 gap-4">
        <div class="glass rounded-xl p-4 text-center">
            <div class="text-2xl font-bold mb-1" id="referral-count">...</div>
            <div class="text-gray-400 text-xs">–†–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>
        </div>
        <div class="glass rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-yellow-400 mb-1" id="referral-earned">...</div>
            <div class="text-gray-400 text-xs">PRED –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
        </div>
    </div>
</div>

<!-- Support -->
<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h2 class="text-xl font-bold mb-1">üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞</h2>
            <p class="text-gray-400 text-sm">–ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã? –ú—ã –≥–æ—Ç–æ–≤—ã –ø–æ–º–æ—á—å!</p>
        </div>
        <div class="text-4xl">üéß</div>
    </div>

    <a href="/support" class="block w-full glass rounded-xl p-4 text-center font-semibold bg-yellow-500 bg-opacity-20 hover:bg-opacity-30 transition-all duration-200">
        <span class="text-yellow-400">üì® –û—Ç–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏</span>
    </a>

    <div class="grid grid-cols-2 gap-3 mt-4 text-xs">
        <div class="glass rounded-lg p-3 text-center">
            <div class="text-green-400 font-semibold mb-1">‚ö°Ô∏è –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç</div>
            <div class="text-gray-400">–í —Ç–µ—á–µ–Ω–∏–µ 2-4 —á–∞—Å–æ–≤</div>
        </div>
        <div class="glass rounded-lg p-3 text-center">
            <div class="text-blue-400 font-semibold mb-1">üîí –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ</div>
            <div class="text-gray-400">–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</div>
        </div>
    </div>
</div>

<!-- Recent Bets -->
<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">üìú –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ü—Ä–æ–≥–Ω–æ–∑—ã</h2>
        <a href="/markets" class="text-yellow-400 text-sm">–í—Å–µ</a>
    </div>

    <div id="recent-bets-container" class="space-y-3">
        <!-- Bets will be loaded dynamically -->
        <div class="glass rounded-xl p-4 text-center">
            <div class="text-gray-400 text-sm">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Load profile data
async function loadProfile() {
    try {
        const response = await fetch('/api/profile');
        if (response.ok) {
            const profile = await response.json();

            // Update username
            document.getElementById('username').innerText = profile.username || profile.first_name || `–ò–≥—Ä–æ–∫ #${profile.telegram_id}`;

            // Update avatar
            const avatar = document.getElementById('profile-avatar');
            const avatarPlaceholder = document.getElementById('profile-avatar-placeholder');
            if (profile.photo_url && avatar && avatarPlaceholder) {
                avatar.src = profile.photo_url;
                avatar.style.display = 'block';
                avatarPlaceholder.style.display = 'none';
            }

            // Update balances
            document.getElementById('pred-balance-display').innerText = window.formatNumber(profile.pred_balance || 0);
            document.getElementById('ton-balance-display').innerText = window.formatNumber(profile.ton_balance || 0);

            // Update stats
            document.getElementById('stat-total-bets').innerText = profile.total_bets || 0;
            document.getElementById('stat-wins').innerText = profile.total_wins || 0;
            document.getElementById('stat-losses').innerText = profile.total_losses || 0;

            const winRate = profile.total_bets > 0
                ? Math.round((profile.total_wins / profile.total_bets) * 100)
                : 0;
            document.getElementById('stat-winrate').innerText = winRate + '%';

            // Update win streak
            document.getElementById('stat-current-streak').innerHTML = `üî• ${profile.win_streak || 0}`;
            document.getElementById('stat-best-streak').innerText = profile.best_streak || 0;

            // Update rank
            const rankBadge = document.getElementById('user-rank-badge');
            const rankIcons = {
                'Bronze': 'ü•â',
                'Silver': 'ü•à',
                'Gold': 'ü•á',
                'Diamond': 'üíé',
                'Legend': 'üåü'
            };
            const rankNames = {
                'Bronze': '–ë–†–û–ù–ó–û–í–´–ô',
                'Silver': '–°–ï–†–ï–ë–†–Ø–ù–´–ô',
                'Gold': '–ó–û–õ–û–¢–û–ô',
                'Diamond': '–ê–õ–ú–ê–ó–ù–´–ô',
                'Legend': '–õ–ï–ì–ï–ù–î–ê–†–ù–´–ô'
            };
            if (rankBadge) {
                rankBadge.innerHTML = `${rankIcons[profile.rank] || 'üèÜ'} ${rankNames[profile.rank] || profile.rank.toUpperCase()} –†–ê–ù–ì`;
            }

            // Load and update global rank from leaderboard
            loadUserRank();

            // Update referral link
            const referralInput = document.getElementById('referral-link');
            if (referralInput && profile.telegram_id) {
                referralInput.value = `https://t.me/The_Pred_Bot?start=${profile.telegram_id}`;
            }

            // Update rank progress section
            updateRankProgress(profile.rank, profile.total_bets || 0);

            // Load referral stats
            loadReferralStats(profile.id);
        }
    } catch (error) {
        console.error('Failed to load profile:', error);
    }
}

// Load bet history
async function loadBetHistory() {
    try {
        const response = await fetch('/api/bets/history');
        if (response.ok) {
            const bets = await response.json();

            if (bets.length > 0) {
                const recentBetsContainer = document.querySelector('.space-y-3');

                const statusColors = {
                    'WON': 'green-gradient',
                    'LOST': 'red-gradient',
                    'PENDING': 'glass'
                };

                const statusTextColors = {
                    'WON': 'text-white',
                    'LOST': 'text-white',
                    'PENDING': 'text-yellow-400'
                };

                const statusTranslations = {
                    'WON': '–í–´–ò–ì–†–´–®',
                    'LOST': '–ü–†–û–ò–ì–†–´–®',
                    'PENDING': '–û–ñ–ò–î–ê–ù–ò–ï'
                };

                recentBetsContainer.innerHTML = bets.slice(0, 5).map(bet => {
                    const statusClass = statusColors[bet.status] || 'glass';
                    const statusTextClass = statusTextColors[bet.status] || 'text-white';
                    const positionText = bet.position === 'YES' ? '–î–ê' : '–ù–ï–¢';

                    return `
                        <div class="glass rounded-xl p-4">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex-1">
                                    <div class="font-medium mb-1">${bet.market_title || '–†—ã–Ω–æ–∫ #' + bet.market_id}</div>
                                    <div class="text-xs text-gray-400">–ü—Ä–æ–≥–Ω–æ–∑ ${positionText} ‚Ä¢ ${bet.amount} ${bet.currency}</div>
                                </div>
                                <span class="${statusClass} px-3 py-1 rounded-full text-xs font-bold ${statusTextClass}">
                                    ${statusTranslations[bet.status] || bet.status}
                                </span>
                            </div>
                            <div class="text-xs text-gray-500">
                                ${bet.status === 'WON' ? `+${bet.payout} ${bet.currency}` : bet.status === 'LOST' ? `-${bet.amount} ${bet.currency}` : `–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª: +${bet.potential_win} ${bet.currency}`}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
    } catch (error) {
        console.error('Failed to load bet history:', error);
    }
}

// Load user's rank in leaderboard
async function loadUserRank() {
    try {
        const response = await fetch('/api/leaderboard/rank');
        if (response.ok) {
            const rankData = await response.json();
            const globalRank = document.getElementById('user-global-rank');
            if (globalRank && rankData.rank) {
                globalRank.innerText = `üèÜ #${rankData.rank} –≤ –º–∏—Ä–µ`;
            }
        }
    } catch (error) {
        console.error('Failed to load user rank:', error);
    }
}

// Load referral stats
async function loadReferralStats(userId) {
    try {
        const response = await fetch(`/api/users/${userId}/referrals`);
        if (response.ok) {
            const data = await response.json();

            // Update referral count
            const referralCount = document.getElementById('referral-count');
            if (referralCount) {
                referralCount.innerText = data.referral_count || 0;
            }

            // Update referral earned (100 PRED per referral)
            const referralEarned = document.getElementById('referral-earned');
            if (referralEarned) {
                const earned = (data.referral_count || 0) * 100;
                referralEarned.innerText = window.formatNumber(earned);
            }
        }
    } catch (error) {
        console.error('Failed to load referral stats:', error);
        // Set defaults on error
        document.getElementById('referral-count').innerText = '0';
        document.getElementById('referral-earned').innerText = '0';
    }
}

// Update rank progress section dynamically
function updateRankProgress(currentRank, totalBets) {
    const ranks = [
        {
            name: 'Bronze',
            icon: 'ü•â',
            min: 0,
            max: 100,
            text: '–ë—Ä–æ–Ω–∑–∞',
            benefits: [
                '–ö–æ–º–∏—Å—Å–∏—è: 1% PRED, 5% TON',
                '–ë–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã'
            ]
        },
        {
            name: 'Silver',
            icon: 'ü•à',
            min: 100,
            max: 500,
            text: '–°–µ—Ä–µ–±—Ä–æ',
            benefits: [
                '–ö–æ–º–∏—Å—Å–∏—è: 0.8% PRED, 4.5% TON',
                '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞'
            ]
        },
        {
            name: 'Gold',
            icon: 'ü•á',
            min: 500,
            max: 2000,
            text: '–ó–æ–ª–æ—Ç–æ',
            benefits: [
                '–ö–æ–º–∏—Å—Å–∏—è: 0.6% PRED, 4% TON',
                '‚ú® –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π'
            ]
        },
        {
            name: 'Diamond',
            icon: 'üíé',
            min: 2000,
            max: 10000,
            text: '–ê–ª–º–∞–∑',
            benefits: [
                '–ö–æ–º–∏—Å—Å–∏—è: 0.4% PRED, 3% TON',
                '‚ú® –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π',
                'üöÄ –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≤ –ª–µ–Ω—Ç–µ',
                'VIP –ø–æ–¥–¥–µ—Ä–∂–∫–∞ 24/7'
            ]
        },
        {
            name: 'Legend',
            icon: 'üåü',
            min: 10000,
            max: Infinity,
            text: '–õ–µ–≥–µ–Ω–¥–∞',
            benefits: [
                '–ö–æ–º–∏—Å—Å–∏—è: 0.2% PRED, 2% TON',
                '‚ú® –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π',
                'üöÄ –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –≤ —Ç–æ–ø –ª–µ–Ω—Ç—ã',
                '‚≠ê –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –º–µ—Å—Ç–∞',
                '‚è∞ –î–ª–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–µ—Ä–∂–∞–Ω–∏–µ –≤ –ª–µ–Ω—Ç–µ',
                'üëë –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –±–µ–π–¥–∂'
            ]
        }
    ];

    // Find current rank index
    const currentRankIndex = ranks.findIndex(r => r.name === currentRank);
    if (currentRankIndex === -1) return;

    const currentRankData = ranks[currentRankIndex];
    const nextRankData = ranks[currentRankIndex + 1];

    // Update all rank cards
    const rankProgressSection = document.getElementById('rank-progress-container');
    if (!rankProgressSection) return;

    rankProgressSection.innerHTML = ranks.map((rank, index) => {
        const isCurrent = rank.name === currentRank;
        const isPassed = index < currentRankIndex;
        const isNext = index === currentRankIndex + 1;

        let cardClass = 'glass rounded-xl p-5';
        if (isPassed) cardClass += ' opacity-50 border border-gray-700';
        if (isCurrent) cardClass += ' border-2 border-yellow-400 shadow-lg shadow-yellow-400/20';
        if (!isPassed && !isCurrent) cardClass += ' border border-gray-800';

        let content = `
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-2">
                    <span class="text-2xl">${rank.icon}</span>
                    <span class="font-bold text-lg ${isCurrent ? 'text-yellow-400' : ''}">${rank.text}</span>
                </div>
                <div>
                    ${isCurrent ? '<span class="text-xs px-2 py-1 rounded-full bg-green-600 text-white font-bold">–¢–ï–ö–£–©–ò–ô</span>' : ''}
                    ${isPassed ? '<span class="text-xs px-2 py-1 rounded-full bg-gray-600 text-gray-300 font-bold">‚úì –ü–†–û–ô–î–ï–ù</span>' : ''}
                    ${!isCurrent && !isPassed ? `<span class="text-xs text-gray-400">${rank.min}${rank.max === Infinity ? '+' : `-${rank.max}`} –ø—Ä–æ–≥–Ω–æ–∑–æ–≤</span>` : ''}
                </div>
            </div>
        `;

        // Show benefits
        content += `
            <div class="space-y-1.5 mb-3">
                ${rank.benefits.map(benefit => `
                    <div class="flex items-start space-x-2">
                        <span class="text-xs ${isCurrent ? 'text-green-400' : 'text-gray-400'} mt-0.5">‚Ä¢</span>
                        <span class="text-xs ${isCurrent ? 'text-gray-200' : 'text-gray-400'}">${benefit}</span>
                    </div>
                `).join('')}
            </div>
        `;

        // Show progress bar for current rank
        if (isCurrent && nextRankData) {
            const progress = ((totalBets - rank.min) / (rank.max - rank.min)) * 100;
            const remaining = rank.max - totalBets;
            content += `
                <div class="mt-3 pt-3 border-t border-gray-700">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-gray-400">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                        <span class="text-xs font-bold text-yellow-400">${totalBets} / ${rank.max}</span>
                    </div>
                    <div class="w-full bg-gray-800 rounded-full h-2.5 mb-2">
                        <div class="gold-gradient h-2.5 rounded-full transition-all duration-500" style="width: ${Math.min(progress, 100)}%"></div>
                    </div>
                    <div class="text-xs text-gray-400 text-center">
                        <span class="text-yellow-400 font-bold">${remaining}</span> –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –¥–æ —Ä–∞–Ω–≥–∞ ${nextRankData.icon} ${nextRankData.text}
                    </div>
                </div>
            `;
        }

        return `<div class="${cardClass}">${content}</div>`;
    }).join('');
}

// Load user's markets (created + with bets)
async function loadUserMarkets() {
    try {
        // Load bet history (markets where user placed bets)
        const betsResponse = await fetch('/api/bets/history');
        const userMarkets = new Map(); // Using Map to avoid duplicates

        if (betsResponse.ok) {
            const bets = await betsResponse.json();

            bets.forEach(bet => {
                if (!userMarkets.has(bet.market_id)) {
                    userMarkets.set(bet.market_id, {
                        id: bet.market_id,
                        title: bet.market_title || `–°–æ–±—ã—Ç–∏–µ #${bet.market_id}`,
                        status: bet.status,
                        amount: bet.amount,
                        position: bet.position,
                        currency: bet.currency,
                        payout: bet.payout,
                        potential_win: bet.potential_win,
                        type: 'bet'
                    });
                }
            });
        }

        // Render markets
        const recentBetsContainer = document.getElementById('recent-bets-container');

        if (!recentBetsContainer) {
            console.error('Recent bets container not found');
            return;
        }

        if (userMarkets.size > 0) {
            const statusColors = {
                'WON': 'green-gradient',
                'LOST': 'red-gradient',
                'PENDING': 'glass'
            };

            const statusTextColors = {
                'WON': 'text-white',
                'LOST': 'text-white',
                'PENDING': 'text-yellow-400'
            };

            const statusTranslations = {
                'WON': '–í–´–ò–ì–†–´–®',
                'LOST': '–ü–†–û–ò–ì–†–´–®',
                'PENDING': '–û–ñ–ò–î–ê–ù–ò–ï'
            };

            recentBetsContainer.innerHTML = Array.from(userMarkets.values()).slice(0, 10).map(market => {
                const statusClass = statusColors[market.status] || 'glass';
                const statusTextClass = statusTextColors[market.status] || 'text-white';
                const positionText = market.position === 'YES' ? '–î–ê' : '–ù–ï–¢';

                return `
                    <div class="glass rounded-xl p-4">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <div class="font-medium mb-1">${market.title}</div>
                                <div class="text-xs text-gray-400">–ü—Ä–æ–≥–Ω–æ–∑ ${positionText} ‚Ä¢ ${market.amount} ${market.currency}</div>
                            </div>
                            <span class="${statusClass} px-3 py-1 rounded-full text-xs font-bold ${statusTextClass}">
                                ${statusTranslations[market.status] || market.status}
                            </span>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${market.status === 'WON' ? `+${market.payout} ${market.currency}` : market.status === 'LOST' ? `-${market.amount} ${market.currency}` : `–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª: +${market.potential_win} ${market.currency}`}
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            recentBetsContainer.innerHTML = `
                <div class="glass rounded-xl p-6 text-center">
                    <div class="text-4xl mb-2">üìä</div>
                    <div class="text-gray-400 text-sm">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–≥–Ω–æ–∑–æ–≤</div>
                    <a href="/markets" class="mt-3 inline-block gold-gradient px-4 py-2 rounded-lg text-black text-sm font-bold">
                        –°–¥–µ–ª–∞—Ç—å –ü—Ä–æ–≥–Ω–æ–∑
                    </a>
                </div>
            `;
        }
    } catch (error) {
        console.error('Failed to load user markets:', error);
        const recentBetsContainer = document.getElementById('recent-bets-container');
        if (recentBetsContainer) {
            recentBetsContainer.innerHTML = '<div class="glass rounded-xl p-4 text-center text-red-400 text-sm">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤</div>';
        }
    }
}

// Make copyReferralLink globally accessible
window.copyReferralLink = function() {
    const input = document.getElementById('referral-link');
    if (input && window.copyToClipboard) {
        window.copyToClipboard(input.value);
    } else {
        // Fallback to native clipboard API
        if (input) {
            input.select();
            document.execCommand('copy');
            alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
        }
    }
};

// Load achievements
async function loadAchievements() {
    const S3_BASE_URL = 'https://thepred.store/thepred-events/missions';
    const userId = {{ user_id }};

    try {
        const response = await fetch(`/api/missions/${userId}`);
        if (!response.ok) {
            throw new Error('Failed to load achievements');
        }

        const missions = await response.json();

        // Filter only achievements
        const achievements = missions.filter(m => m.type === 'achievement');

        const container = document.getElementById('achievements-container');

        if (achievements.length === 0) {
            container.innerHTML = '<div class="col-span-2 glass rounded-xl p-4 text-center text-gray-400 text-sm">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</div>';
            return;
        }

        container.innerHTML = achievements.slice(0, 6).map(achievement => {
            const isCompleted = achievement.completed;
            const progress = achievement.progress || 0;
            const target = achievement.target || 1;
            const percentage = Math.min((progress / target) * 100, 100);

            // Get icon - check if it's custom URL, S3 icon name, or emoji
            let iconHtml;
            if (achievement.custom_icon_url) {
                // Custom URL provided
                iconHtml = `<img src="${achievement.custom_icon_url}" class="w-12 h-12 mx-auto mb-2 object-contain" alt="icon" />`;
            } else if (achievement.icon) {
                // Check if it's an emoji (single character or contains emoji unicode)
                const isEmoji = /(\p{Emoji_Presentation}|\p{Extended_Pictographic})/u.test(achievement.icon) || achievement.icon.length <= 2;
                if (isEmoji) {
                    // It's an emoji
                    iconHtml = `<span class="text-4xl">${achievement.icon}</span>`;
                } else {
                    // It's an S3 icon name
                    const iconUrl = `${S3_BASE_URL}/${achievement.icon}.svg`;
                    iconHtml = `<img src="${iconUrl}" class="w-12 h-12 mx-auto mb-2 object-contain" alt="${achievement.icon}" />`;
                }
            } else {
                // Default icon
                iconHtml = `<span class="text-4xl">üéØ</span>`;
            }

            return `
                <div class="glass rounded-xl p-4 text-center relative ${isCompleted ? 'border-2 border-green-500' : ''}">
                    <div class="mb-2">
                        ${iconHtml}
                    </div>
                        ${isCompleted ? '<div class="absolute top-2 right-2 text-green-500 text-xl">‚úì</div>' : ''}
                        <div class="font-bold text-sm mb-1">${achievement.title}</div>
                        <div class="text-xs text-gray-400 mb-2">${achievement.description}</div>

                        ${!isCompleted ? `
                            <div class="w-full bg-gray-800 rounded-full h-1.5 mb-1">
                                <div class="gold-gradient h-1.5 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                            <div class="text-xs text-gray-500">${progress}/${target}</div>
                        ` : `
                            <div class="text-xs text-green-400 font-bold">‚úì –ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                        `}

                        <div class="text-xs text-yellow-400 font-bold mt-2">
                            +${achievement.reward_amount} ${achievement.reward_currency}
                        </div>
                    </div>
                `;
            }).join('');
    } catch (error) {
        console.error('Failed to load achievements:', error);
        const container = document.getElementById('achievements-container');
        if (container) {
            container.innerHTML = '<div class="col-span-2 glass rounded-xl p-4 text-center text-red-400 text-sm">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</div>';
        }
    }
}

// Clear session and re-authenticate
async function clearSessionAndReauth() {
    if (confirm('–°–±—Ä–æ—Å–∏—Ç—å —Å–µ—Å—Å–∏—é –∏ –∑–∞–Ω–æ–≤–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è?')) {
        try {
            const response = await fetch('/debug/clear-session');
            const result = await response.json();
            if (result.success) {
                alert('–°–µ—Å—Å–∏—è –æ—á–∏—â–µ–Ω–∞! –°–µ–π—á–∞—Å –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.');
                // Redirect to home to trigger re-authentication
                window.location.href = '/';
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
    }
}

// Load data on page load
document.addEventListener('DOMContentLoaded', () => {
    loadProfile();
    loadUserMarkets();
    loadAchievements();
});
</script>
{% endblock %}
