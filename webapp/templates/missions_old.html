{% extends "base.html" %}

{% block title %}–ú–∏—Å—Å–∏–∏ - ThePred{% endblock %}

{% block content %}
<!-- Header -->
<div class="glass card-shine rounded-2xl p-6 mb-6">
    <h1 class="text-2xl font-bold mb-2">üéØ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ú–∏—Å—Å–∏–∏</h1>
    <p class="text-gray-400">–í—ã–ø–æ–ª–Ω—è–π—Ç–µ –∑–∞–¥–∞–Ω–∏—è –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ PRED!</p>
    <div class="mt-4 glass rounded-xl p-4">
        <div class="flex items-center justify-between">
            <span class="text-sm text-gray-400">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑</span>
            <span class="font-bold text-yellow-400">12:34:56</span>
        </div>
    </div>
</div>

<!-- Daily Missions -->
<div class="space-y-4 mb-6">
    <div class="glass rounded-2xl p-5 border-2 border-yellow-400">
        <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="text-2xl">üéØ</span>
                    <h3 class="text-lg font-bold">–°–¥–µ–ª–∞—Ç—å 3 –ü—Ä–æ–≥–Ω–æ–∑–∞</h3>
                </div>
                <p class="text-gray-400 text-sm">–°–¥–µ–ª–∞–π—Ç–µ –º–∏–Ω–∏–º—É–º 3 –ø—Ä–æ–≥–Ω–æ–∑–∞ —Å–µ–≥–æ–¥–Ω—è</p>
            </div>
            <div class="text-right">
                <div class="font-bold text-yellow-400">+500</div>
                <div class="text-xs text-gray-400">PRED</div>
            </div>
        </div>

        <div class="mb-3">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-400">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                <span class="text-sm font-bold">2 / 3</span>
            </div>
            <div class="w-full bg-gray-800 rounded-full h-2">
                <div class="gold-gradient h-2 rounded-full" style="width: 66%"></div>
            </div>
        </div>

        <button class="w-full glass rounded-xl py-3 font-bold opacity-50 cursor-not-allowed">
            –ï—â—ë 1 –ø—Ä–æ–≥–Ω–æ–∑
        </button>
    </div>

    <div class="glass rounded-2xl p-5">
        <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="text-2xl">üèÜ</span>
                    <h3 class="text-lg font-bold">–í—ã–∏–≥—Ä–∞—Ç—å –ü—Ä–æ–≥–Ω–æ–∑</h3>
                </div>
                <p class="text-gray-400 text-sm">–í—ã–∏–≥—Ä–∞–π—Ç–µ –º–∏–Ω–∏–º—É–º 1 –ø—Ä–æ–≥–Ω–æ–∑ —Å–µ–≥–æ–¥–Ω—è</p>
            </div>
            <div class="text-right">
                <div class="font-bold text-yellow-400">+1,000</div>
                <div class="text-xs text-gray-400">PRED</div>
            </div>
        </div>

        <div class="mb-3">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-400">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                <span class="text-sm font-bold text-green-400">1 / 1 ‚úì</span>
            </div>
            <div class="w-full bg-gray-800 rounded-full h-2">
                <div class="green-gradient h-2 rounded-full" style="width: 100%"></div>
            </div>
        </div>

        <button class="w-full gold-gradient rounded-xl py-3 font-bold text-black hover:opacity-90">
            –ó–∞–±—Ä–∞—Ç—å –ù–∞–≥—Ä–∞–¥—É
        </button>
    </div>

    <div class="glass rounded-2xl p-5">
        <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="text-2xl">üë•</span>
                    <h3 class="text-lg font-bold">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –î—Ä—É–≥–∞</h3>
                </div>
                <p class="text-gray-400 text-sm">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ 1 –¥—Ä—É–≥–∞ –≤ ThePred</p>
            </div>
            <div class="text-right">
                <div class="font-bold text-yellow-400">+100</div>
                <div class="text-xs text-gray-400">PRED</div>
            </div>
        </div>

        <div class="mb-3">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-400">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                <span class="text-sm font-bold">0 / 1</span>
            </div>
            <div class="w-full bg-gray-800 rounded-full h-2">
                <div class="gold-gradient h-2 rounded-full" style="width: 0%"></div>
            </div>
        </div>

        <button class="w-full glass rounded-xl py-3 font-bold hover:bg-opacity-20">
            –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –°—Å—ã–ª–∫–æ–π
        </button>
    </div>
</div>

<!-- Weekly Missions -->
<div class="glass rounded-2xl p-6 mb-6">
    <h2 class="text-xl font-bold mb-4">üìÖ –ù–µ–¥–µ–ª—å–Ω—ã–µ –ó–∞–¥–∞–Ω–∏—è</h2>

    <div class="space-y-4">
        <div class="glass rounded-xl p-4">
            <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="text-xl">üî•</span>
                        <h4 class="font-bold">–°–µ—Ä–∏—è –∏–∑ 10 –ü–æ–±–µ–¥</h4>
                    </div>
                    <p class="text-gray-400 text-xs">–í—ã–∏–≥—Ä–∞–π—Ç–µ 10 –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –ø–æ–¥—Ä—è–¥</p>
                </div>
                <div class="text-right">
                    <div class="font-bold text-yellow-400">+5,000</div>
                    <div class="text-xs text-gray-400">PRED</div>
                </div>
            </div>
            <div class="flex items-center justify-between text-xs">
                <span class="text-gray-400">–¢–µ–∫—É—â–∞—è: 7 –ø–æ–±–µ–¥</span>
                <span class="font-bold">70%</span>
            </div>
        </div>

        <div class="glass rounded-xl p-4">
            <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="text-xl">üí∞</span>
                        <h4 class="font-bold">–¢–æ–ø 10 –ø–æ –ü—Ä–∏–±—ã–ª–∏</h4>
                    </div>
                    <p class="text-gray-400 text-xs">–ü–æ–ø–∞—Å—Ç—å –≤ —Ç–æ–ø 10 –ø–æ –Ω–µ–¥–µ–ª—å–Ω–æ–π –ø—Ä–∏–±—ã–ª–∏</p>
                </div>
                <div class="text-right">
                    <div class="font-bold text-yellow-400">+1,000</div>
                    <div class="text-xs text-gray-400">PRED</div>
                </div>
            </div>
            <div class="flex items-center justify-between text-xs">
                <span class="text-gray-400">–¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ: #23</span>
                <span class="text-red-400">–ù–µ –≤ —Ç–æ–ø 10</span>
            </div>
        </div>

        <div class="glass rounded-xl p-4">
            <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="text-xl">üìä</span>
                        <h4 class="font-bold">–°–æ–∑–¥–∞—Ç–µ–ª—å –†—ã–Ω–∫–∞</h4>
                    </div>
                    <p class="text-gray-400 text-xs">–°–æ–∑–¥–∞–π—Ç–µ —Ä—ã–Ω–æ–∫ —Å–æ 100+ –ø—Ä–æ–≥–Ω–æ–∑–∞–º–∏</p>
                </div>
                <div class="text-right">
                    <div class="font-bold text-yellow-400">+5,000</div>
                    <div class="text-xs text-gray-400">PRED</div>
                </div>
            </div>
            <div class="flex items-center justify-between text-xs">
                <span class="text-gray-400">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π —Ä—ã–Ω–æ–∫</span>
                <span>0%</span>
            </div>
        </div>
    </div>
</div>

<!-- Special Achievements -->
<div class="glass rounded-2xl p-6">
    <h2 class="text-xl font-bold mb-4">üèÖ –û—Å–æ–±—ã–µ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>

    <div class="grid grid-cols-2 gap-3">
        <div class="glass rounded-xl p-4 text-center border-2 border-yellow-400">
            <div class="text-3xl mb-2">üéØ</div>
            <div class="font-bold text-sm mb-1">–ü–µ—Ä–≤—ã–π –ü—Ä–æ–≥–Ω–æ–∑</div>
            <div class="text-xs text-green-400">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
        </div>

        <div class="glass rounded-xl p-4 text-center border-2 border-yellow-400">
            <div class="text-3xl mb-2">üèÜ</div>
            <div class="font-bold text-sm mb-1">–ü–µ—Ä–≤–∞—è –ü–æ–±–µ–¥–∞</div>
            <div class="text-xs text-green-400">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
        </div>

        <div class="glass rounded-xl p-4 text-center opacity-50">
            <div class="text-3xl mb-2">üíØ</div>
            <div class="font-bold text-sm mb-1">100 –ü—Ä–æ–≥–Ω–æ–∑–æ–≤</div>
            <div class="text-xs text-gray-400">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>
        </div>

        <div class="glass rounded-xl p-4 text-center opacity-50">
            <div class="text-3xl mb-2">üíé</div>
            <div class="font-bold text-sm mb-1">–ê–ª–º–∞–∑–Ω—ã–π –†–∞–Ω–≥</div>
            <div class="text-xs text-gray-400">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>
        </div>

        <div class="glass rounded-xl p-4 text-center opacity-50">
            <div class="text-3xl mb-2">üî•</div>
            <div class="font-bold text-sm mb-1">–°–µ—Ä–∏—è –∏–∑ 15</div>
            <div class="text-xs text-gray-400">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>
        </div>

        <div class="glass rounded-xl p-4 text-center opacity-50">
            <div class="text-3xl mb-2">üëë</div>
            <div class="font-bold text-sm mb-1">–¢–æ–ø 1</div>
            <div class="text-xs text-gray-400">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Load missions from API
async function loadMissions() {
    try {
        console.log('Loading missions...');
        const response = await fetch('/api/missions');
        if (response.ok) {
            const missions = await response.json();
            console.log('Missions loaded:', missions);
            renderMissions(missions);
        } else {
            console.error('Failed to load missions:', response.status);
        }
    } catch (error) {
        console.error('Failed to load missions:', error);
    }
}

// Get requirement value from requirements object
function getRequirementValue(requirements) {
    // requirements can be {"bets_count": 5} or {"wins_count": 1} or {"win_streak": 3}
    const values = Object.values(requirements);
    if (values.length > 0) {
        // Handle nested objects like {"category_bets": {"category": "Crypto", "count": 3}}
        if (typeof values[0] === 'object' && values[0].count) {
            return values[0].count;
        }
        return values[0];
    }
    return 1;
}

// Render missions
function getIconHtml(iconName) {
    // Check if it's a default icon name or a URL
    if (iconName && !iconName.startsWith('http') && !iconName.startsWith('/uploads')) {
        // Default icon - use S3 URL
        return `<img src="${S3_MISSIONS_URL}/${iconName}.svg" alt="icon" class="w-12 h-12">`;
    } else if (iconName) {
        // Custom uploaded icon (already a full URL)
        return `<img src="${iconName}" alt="icon" class="w-12 h-12 rounded-lg">`;
    } else {
        // Fallback emoji
        return '<span class="text-4xl">üéØ</span>';
    }
}

function renderMissions(missions) {
    const dailyContainer = document.querySelector('.space-y-4.mb-6');

    if (missions.length === 0) {
        dailyContainer.innerHTML = '<div class="glass rounded-2xl p-8 text-center text-gray-400">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∏—Å—Å–∏–π</div>';
        return;
    }

    dailyContainer.innerHTML = missions.map(mission => {
        const iconHtml = getIconHtml(mission.icon);
        const progress = mission.progress || 0;
        const required = getRequirementValue(mission.requirements);
        const progressPercent = Math.min((progress / required) * 100, 100);
        const isCompleted = mission.completed && !mission.claimed;
        const isClaimed = mission.claimed;

        return `
            <div class="glass rounded-2xl p-5 ${isCompleted ? 'border-2 border-green-400' : ''}">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                        <div class="flex items-center space-x-3 mb-2">
                            ${iconHtml}
                            <div>
                                <h3 class="text-lg font-bold">${mission.title}</h3>
                                ${isClaimed ? '<span class="text-xs bg-green-600 text-white px-2 py-1 rounded-full">‚úì –ü–æ–ª—É—á–µ–Ω–æ</span>' : ''}
                            </div>
                        </div>
                        <p class="text-gray-400 text-sm">${mission.description || ''}</p>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-yellow-400">+${window.formatNumber ? window.formatNumber(mission.reward_amount) : mission.reward_amount}</div>
                        <div class="text-xs text-gray-400">${mission.reward_currency}</div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm text-gray-400">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                        <span class="text-sm font-bold ${isCompleted ? 'text-green-400' : ''}">${progress} / ${required} ${isCompleted ? '‚úì' : ''}</span>
                    </div>
                    <div class="w-full bg-gray-800 rounded-full h-2">
                        <div class="${isCompleted ? 'bg-green-500' : 'gold-gradient'} h-2 rounded-full transition-all duration-300" style="width: ${progressPercent}%"></div>
                    </div>
                </div>

                ${isClaimed
                    ? '<button class="w-full glass rounded-xl py-3 font-bold opacity-50 cursor-not-allowed">‚úì –ù–∞–≥—Ä–∞–¥–∞ –ü–æ–ª—É—á–µ–Ω–∞</button>'
                    : isCompleted
                    ? `<button onclick="claimMission(${mission.id})" class="w-full green-gradient rounded-xl py-3 font-bold text-white hover:opacity-90 pulse-gold">üéâ –ó–∞–±—Ä–∞—Ç—å –ù–∞–≥—Ä–∞–¥—É</button>`
                    : `<button class="w-full glass rounded-xl py-3 font-bold opacity-50 cursor-not-allowed">–ï—â—ë ${required - progress} –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</button>`
                }
            </div>
        `;
    }).join('');
}

// Claim mission reward
async function claimMission(missionId) {
    try {
        window.tgHaptic?.light();

        console.log('Claiming mission:', missionId);

        const response = await fetch(`/api/missions/claim/${missionId}`, {
            method: 'POST'
        });

        if (response.ok) {
            const result = await response.json();
            window.tgHaptic?.success();
            window.showTgAlert(`üéâ –ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞! +${result.reward.amount} ${result.reward.currency}`);

            // Reload missions and balance
            await loadMissions();
            if (window.loadUserBalance) {
                await window.loadUserBalance();
            }
        } else {
            const error = await response.json();
            window.tgHaptic?.error();
            window.showTgAlert(error.error || error.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É');
        }
    } catch (error) {
        console.error('Claim error:', error);
        window.tgHaptic?.error();
        window.showTgAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
    }
}

// Load missions on page load
document.addEventListener('DOMContentLoaded', () => {
    loadMissions();
});
</script>
{% endblock %}
